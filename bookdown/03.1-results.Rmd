---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Results

## Coverage

### Geographical coverage

Should probably include a map here of the countries that we have included. Here is a list instead to start with 

```{r}
# Setup ---------------------------------------------------------------------------
library(tidyverse)
library(here)
library(sf)

# Import data ---------------------------------------------------------------------
stock.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
value.sp.geo.in <- readRDS(here("objects/EUROSTAT/value.species.country.rds"))

bg.map <- 
  list(annotation_map(map_data("world"),fill="grey",colour="darkgrey"),
       scale_fill_viridis_c())
  

# Calculate proportion of landings & landings value covered ----------------------------------------
prop.catch.covered  <- 
  stock.haz %>%
  mutate(missing.haz=is.na(hazard)) %>%
  group_by(FAO_3A_code,missing.haz) %>%
  summarise(prop.sp.covered=sum(st.prop)) %>%
  filter(!missing.haz)

#Merge into value.sp.geo
value.sp.geo <-
  value.sp.geo.in %>%
  rename(FAO_3A_code=species) %>%
  left_join(y=prop.catch.covered,by="FAO_3A_code") %>%
  mutate(prop.sp.covered=ifelse(is.na(prop.sp.covered),0,prop.sp.covered),
         covered.value=value*prop.sp.covered) %>%
  rename(full.value=value)

# Calculate total coverage --------------------------------------------------------
total.value <- sum(value.sp.geo$full.value)
coverage <- sum(value.sp.geo$covered.value)/total.value

```

The selected groups included in this analysis cover `r sprintf("%2.1f%%",round(coverage*100,1))` of  the total value of European fisheres landings. This is broken down by country as follows.

```{r}
geo.coverage <- 
  value.sp.geo %>%
  group_by(geo) %>%
  summarise(total.covered=sum(covered.value),
            total=sum(full.value)) %>%
  mutate(prop=total.covered/total) 

ggplot(geo.coverage,aes(geo,prop))+
  geom_bar(stat="identity")+
  labs(x="Country",y="Proportion of landings by value")+
  coord_cartesian(ylim=c(0,1),expand=FALSE)

min.prop <- 0.90
prop.countries <- ecdf(geo.coverage$prop)(min.prop)

```

We can see that `r sprintf("%2.0f%%", round((1-prop.countries)*100))` of countries  have at least `r sprintf("%2.0f%%",round(min.prop*100))` coverage and all countries have at least `r sprintf("%2.0f%%",floor(min(geo.coverage$prop,na.rm=TRUE)*100))` coverage. 

Basically the Black Sea countries seem to be missing some important species. The Romanian fishery data is dominated by veing rapa whelk (*Rapana venosa* FAO Code RPW), while the Bulgarian data is dominated by sea snails (*Rapana spp* FAO Code RPW). The Aquamap that we are using for these two species appears to be the incorrect one, centered on Japan.

### Fleet Coverage

```{r}
flt.risk <- readRDS(here("objects/fleet_metrics/Fleet_risk.rds"))

```
We should also check the coverage by fleet segment. We are able to do the full analysis for `r nrow(flt.risk)` fleet segments, although the coverage of some of these units can be pretty poor.
```{r}
ggplot(flt.risk,aes(x=1-prop.missing))+
  stat_ecdf()+
  labs(x="Proportion of landings value covered",
       y="Cumulative proportion of fleet segments")+
  scale_x_reverse()
```

Nevertheless, we still cover 75% or more of the landings value for more than 70% of fleets. We should probably filter this at some point to focus on the most important and/or best covered fleets.

