---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Results

## Coverage

### Geographical coverage

Should probably include a map here of the countries that we have included. Here is a list instead to start with 

```{r}
# Setup ---------------------------------------------------------------------------
library(tidyverse)
library(here)
library(sf)

# Import data ---------------------------------------------------------------------
stock.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
stock.haz.all <- readRDS(here("objects/biological_metrics/stock_hazard_all.rds"))
value.sp.geo <- readRDS(here("objects/EUROSTAT/value.species.country.rds"))
nations.sf <- readRDS(here("objects/Geodata/nation_regions.rds"))

bg.map <- 
  list(annotation_map(map_data("world"),fill="grey",colour="darkgrey"),
       scale_fill_viridis_c())
  

# Calculate proportion of landings & landings value for which
# we have hazards i.e. the "coverage"
# ----------------------------------------
prop.catch.covered  <-
  stock.haz.all %>%
  mutate(missing.haz=is.na(hazard)) %>%
  group_by(FAO_3A_code) %>%
  summarise(prop.sp.covered=sum(st.prop*!missing.haz)) %>%
  ungroup() 

#Merge the coverage proportions into value information
value.sp.geo.covered <-
  value.sp.geo %>%
  #Add in proportion coveraged
  left_join(y=prop.catch.covered,by=c("species"="FAO_3A_code")) %>%
  mutate(covered.value=value*prop.sp.covered)

# Calculate total coverage 
total.value <- sum(value.sp.geo.covered$value,na.rm=TRUE)
coverage <- sum(value.sp.geo.covered$covered.value,na.rm=TRUE)/total.value

```



```{r}
geo.coverage <-
  value.sp.geo.covered %>%
  group_by(geo) %>%
  summarise(total.covered=sum(covered.value,na.rm=TRUE),
            total=sum(value,na.rm=TRUE)) %>%
  mutate(prop=total.covered/total,
         geo=fct_reorder(geo,prop))

ggplot(geo.coverage,aes(geo,prop))+
  geom_bar(stat="identity")+
  labs(x="Country",y="Proportion of landings by value")+
  coord_cartesian(ylim=c(0,1),expand=FALSE)

#Merge into a map
right_join(nations.sf,y=geo.coverage,by=c("FID"="geo")) %>%
  ggplot()+
  annotation_map(map_data("world"),fill="grey",colour="darkgrey")+
  geom_sf(aes(fill=prop))+
  coord_sf(xlim=c(-30,45),ylim=c(30,75),expand=FALSE)+
  scale_fill_viridis_c(limits=c(0,1))+
  theme_bw()+
  labs(fill="Coverage")

```

A complete set of trait and Aquamap data (allowing the calculation of climate hazard) was gathered for  `r length(unique(stock.haz$FAO_3A_code))` species caught in European waters, representing  `r sprintf("%02.1f%%",round(coverage*100,1))` of the total value of fish and shellfish landings in Europe. Catch data was available covering `r nrow(geo.coverage)` countries in Europe: country-wise coverage was at least `r sprintf("%2.0f%%",round(min(geo.coverage$prop)*100))` by value and typically above 90%.

When combined with catch data covering `r length(unique(stock.haz$F_CODE))` FAO subareas, this resulted in a total of `r stock.haz.all %>% filter(!is.na(hazard)) %>% nrow()` potential "stocks". However, many of these stocks made relatively minor contributions to the total catch of the species: stocks comprising less than 5% of the total catch of that species were therefore filtered out, leaving `r nrow(stock.haz)` stocks in the analysis.

### Fleet Coverage

```{r}
flt.risk <- readRDS(here("objects/fleet_metrics/Fleet_risk.rds"))

```

We should also check the coverage by fleet segment. We are able to do the full analysis for `r nrow(flt.risk)` fleet segments, although the coverage of some of these units can be pretty poor.

```{r}
ggplot(flt.risk,aes(x=1-prop.missing))+
  stat_ecdf()+
  labs(x="Proportion of landings value covered",
       y="Cumulative proportion of fleet segments")+
  scale_x_reverse()
```

Nevertheless, we still cover 75% or more of the landings value for more than 70% of fleets. We should probably filter this at some point to focus on the most important and/or best covered fleets.

Number of fleet segements: `r flt.risk %>% filter(!is.na(risk)) %>% nrow()`
