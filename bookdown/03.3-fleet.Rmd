
## Fleet metrics

### Fleet hazard metrics

Fleets with the top and bottom 10 hazard scores

```{r}
fleet.haz <- 
  readRDS(here("objects/fleet_metrics/Fleet_hazard.rds")) %>%
  arrange(hazard)
n <- 10

knitr::kable(
  bind_rows(head(fleet.haz,n),tail(fleet.haz,n)),
  caption="Top and botton 10 fleets by hazard "
  
)
```

```{r fig.cap="Distribution of hazard metrics"}
ggplot(fleet.haz,aes(x=hazard))+
  stat_bin()+
  labs(x="Fleetwise Hazard score",y="Frequency")

```

### Fleet exposure metrics

We use the Shannon diversity and the Simpson Dominance metrics to characterise the diversity of species that a fishing fleet catching. The distribution of these metrics is as follows. 

```{r fig.cap="Fleetwsie Shannon Diversity index" }
# Import fleet data -----------------------------------------------------------
fleet.exp <- readRDS(here("objects/fleet_metrics/Fleet_exposure.rds")) 

ggplot(fleet.exp,aes(x=shannon.H))+
  stat_bin()+
  labs(x="Fleet Shannon Diversity index",y="Frequency")
```

```{r, fig.cap="Fleetwise Simpson Dominance"}
ggplot(fleet.exp,aes(x=simpsons.D))+
  stat_bin()+
  labs(x="Fleet Simpson Dominance index",y="Frequency")

```

A correlation between these two metrics is expected.

```{r fig.cap="Relationship between Shannon Diversity H’ and Simpson’s Dominance D of fishery landings, for EU fleet segments in 2016"}
# Plot ----------------------------------------------------------------------------
ggplot(fleet.exp,aes(shannon.H,simpsons.D))+
  geom_point()+
  labs(x="Shannon diversity",y="Simpson's dominance (D)")

```

 Clearly there is a strong relationship between Shannon diversity  of fishery landings and Simpson’s dominance (D), although this is not linear (figure 1).
 
We combine the two metrics together into a into exposure metrics. Checking that we have done this correctly:

```{r fig.cap="Exposure vs Shannon Index"}
fleet.exp %>%
  select(shannon.H,simpsons.D,exposure) %>%
  gather("parameter","value",-exposure) %>%
ggplot(aes(x=value,y=exposure))+
  geom_point()+
  facet_wrap(~parameter,scale="free_x")+
  labs(x="Value",y="Fleetwise exposure")

```

So fleets with higher diversity have lower exposure. Tick. And  fleets that are dominated by a few species have a higher exposure, which is what we want.

Plotting the list of fleet diversity.

Least diverse fleets
```{r}
knitr::kable(
  arrange(fleet.exp,shannon.H) %>% head,
  caption="Least diverse fleets",
  booktabs=TRUE
)

```

Most diverse fleets

```{r }
knitr::kable(
  arrange(fleet.exp,shannon.H) %>% tail,
  caption="Most diverse fleets",
  booktabs=TRUE
)
```

Catch diversity in 2016 ranged from zero (where a fleet caught a single resource) to 4.19, where a multitude of different fish and shellfish species were targeted. The lowest diversity of catches was observed for the fleet segments IRL-A27-DRB2440, MLT-A37-PS2440 and PRT-A37-FPO2440, fishing exclusively on Great Atlantic scallop (*Pecten maximus*), Chub mackerel  (*Scomber colias*) and Striped soldier shrimp (*Plesionika edwardsii*) respectively. By contrast, the highest diversity of landings was observed for ESP-A37-DTS1824, with catch records for 746 different species.

### Fleet vulnerability metrics

Visualisation of the distribution of metrics
```{r fig.cap="Employment per vessel"}
flt.vul <- readRDS(here("objects/fleet_metrics/Fleet_vulnerability.rds"))

ggplot(flt.vul,aes(x=Employment.per.vessel))+
  stat_bin()

```
This is a potentially problematic metric, in retrospect, as it is really a metric of vessel size...

QUESTION: Should we retain it? How should we normalise it if we keep it?

```{r fig.cap="Value of landings"}
ggplot(flt.vul,aes(x=Value.of.landings.per.vessel))+
  stat_bin()

```

Hmmm. Similar problem.

```{r,fig.cap="Average wage per FTE"}
ggplot(flt.vul,aes(x=Average.wage.per.FTE))+
  stat_bin()
```

Looks like a couple of outliers there that need to be polished up...

```{r fig.cap="Net profit margin"}
ggplot(flt.vul,aes(x=Net.profit.margin))+
  stat_bin()+
    labs(x="Net profit margin (%)")
```

Hmmm. A rather biased distribution. Lets crunch this figure down a bit...

```{r fig.cap="Net profit margin 2"}
ggplot(flt.vul,aes(x=Net.profit.margin))+
  stat_bin()+
  xlim(c(-100,100))+
  labs(x="Net profit margin (%)")
```

Outliers aside, this is not a bad distribution. 

QUESTION: Shall we rescale it to +/-50, and trim the rest...?

For the sake of this analysis, we have only based vulnerability on the Net Profit Margin, while we decide whether to include the rest..

Looking at the total vulnerability distribution.

```{r fig.cap="Vulnerability distribution"}
ggplot(flt.vul,aes(x=vulnerability))+
  stat_bin()

```

This doesn't look so bad, but at the same time the outliers probably don't help things, and should be fixed.

Checking the correlations with the metrics against vulnerability
```{r fig.cap="Correlation check"}
vul.cor <- 
  flt.vul %>%
  gather("variable","value",-fs_name,-vulnerability)

ggplot(vul.cor,aes(x=value,y=vulnerability))+
  facet_wrap(~variable,scales="free_x")+
  geom_point()
```

Which highlights the problems quite nicely... There is also some issues here with the directionality that we need to fix.

I think we probably need to rethink these metrics. Net profit margin is a very useful metric, but I'm not so sure about the others, particularly as they scale with vessel size, which I'm not sure we realy want...

### Fleet risk

Note that the results here are a bit meaningless until we get the vulnerability under control, but the visualisations will be the same, so we can look at and discuss how we want to approach these.

Firstly, the top and bottom 10

```{r}
flt.risk <- 
  readRDS(here("objects/fleet_metrics/Fleet_risk.rds")) %>%
  arrange(risk) 

knitr::kable(
  bind_rows(head(flt.risk,n=10),tail(flt.risk,n=10)),
  caption="Top and bottom 10 fleets by risk",
  digits=3)


```

Now, viewing by vessel size

```{r, fig.cap=""}
plt.dat <-
  flt.risk %>%
  tidyr::extract(fs_name,
          into=c("country","area","gear","length","geo"),
          "^(.+?) (.+?) ([:alpha:]{1,3})([:alnum:]{4}) *(.*)$",
          remove=FALSE) %>%
  mutate(area=replace(area,area=="A37","FAO Area 37"),
         area=replace(area,area=="A27","FAO Area 27"),
         area=replace(area,area=="OFR","Other Fishing Regions"))
  

ggplot(plt.dat,aes(x=length,y=risk,group=length))+
  stat_boxplot()+
  labs(x="Vessel length range",y="Climate risk")

```

By country and fishing area. 

QUESTION: I'm not quite sure how whether to retain the other fishing region fleets, or just keep it to the FAO27 and FAO37 areas - we don't have very much biological information outside these regions.

QUESTION: I can also plot this as a map, based on the median value...

```{r, fig.cap=""}
plt.dat %>%
  mutate(country=fct_reorder(country,risk))%>%
ggplot(aes(x=country,y=risk))+
  facet_wrap(~area,ncol=1)+
  stat_boxplot()+
  labs(x="Country (sorted by median risk)",y="Climate risk")
```

```{r fig.cap="Fleetwise climate risk for the 23 EU coastal nations"}
cty.sf <- readRDS(here("objects/Geodata/nation_regions.rds"))

#Country risk
geo.plt.dat <- 
  plt.dat %>%
  group_by(country) %>%
  summarise(median.risk=median(risk,na.rm=TRUE)) %>%
  right_join(x=cty.sf,by=c("country_code"="country")) 

ggplot(geo.plt.dat)+
  bg.map+
  geom_sf(aes(fill=median.risk))+
  coord_sf(xlim=c(-20,40),ylim=c(30,70))+
  labs(fill="Risk")
```

TODO: Ireland needs to be investigated - it looks like it is missing some of the flet economic data => no vul => no risk.

TODO: I will separate France and Spain into Atlantic and Mediterranean fleets as well on this map

And by gear. Looks like quite some variability here.

```{r, fig.cap=""}
ggplot(plt.dat,aes(x=gear,y=risk))+
  stat_boxplot()+
  labs(x="Fishing technology",y="Climate risk")
```

A table of gear types, sorted by median risk.

```{r}
#Import gear code table
fishtech.codes <- 
  read_csv(here("data/STECF_Fleet_data/fishing_technology_codes.csv"))

plt.dat %>%
  group_by(gear) %>%
  summarise(median.risk=median(risk,na.rm=TRUE)) %>%
  left_join(y=fishtech.codes,by=c(gear="fishing_tech"))%>%
  arrange(-median.risk) %>%
  select(`Code`=gear,Description=description,Risk=median.risk)%>%
  knitr::kable(digits=3)
```


