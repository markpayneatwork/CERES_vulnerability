# Supplementary Material 

## Exemplar species


```{r}
#Setup --------------------------------------
library(tidyverse)
library(here)
library(sf)
bucket.categories <- read_csv2(here("data/Taxonomic_issues/bucket_categories.csv"))

knitr::kable(
  bucket.categories,
  booktabs = TRUE,
  caption = 'Groups resolved as the Genus level, and associated selection of exemplar species in FAO regions 27 and 37.'
)

```

## Alternative scientific names


```{r}

alt.names <- read_csv2(here("data/Taxonomic_issues/alternative_names.csv"),comment="#")

knitr::kable(
  select(alt.names,FAO_3A_code,Scientific_name,FAO_EN,Alt.sci.name),
  booktabs = TRUE,
  caption = 'Alternative scientific names'
)
```

## EUROSTAT internal consistency

Ideally there should be internal consistency within the EUROSTAT data on catches and landings. Here we check this.

```{r}
#'========================================================================
# Setup ####
#'========================================================================
library(tidyverse)
library(here)
library(sf)
library(ggpubr)

#Stock information
stock.catch <- readRDS(here("objects/EUROSTAT/catch.stock.geo.rds"))
EUROSTAT.landings <-   readRDS(here("objects/EUROSTAT/landings.geo.rds")) 

#Total catch by species
species.geo <-
  stock.catch %>%
  group_by(species,geo) %>%
  summarise(catch=sum(catch))
  
#Landings data
landings.natvessr <- 
  EUROSTAT.landings %>%
  filter(unit=="TPW") %>%
  select(-unit,landings=value) %>%
  #Sum over flag of registration per species
  group_by(species,natvessr) %>%
  summarise(landings=sum(landings))
  
#'========================================================================
# Check ####
#'========================================================================
#Check internal consistency between landings data and catch data reported
#by EUROSTAT. There should be agreement between
# * the catch per species by a country
# * the total presented weight of a specues that is landed by all of the vessels of a given country
intern.consist <- 
  full_join(x=landings.natvessr,y=species.geo,by=c("species",natvessr="geo")) %>%
  mutate(log.ratio=log10(landings/catch))

ggplot(intern.consist,aes(x=landings,y=catch))+
  geom_abline(slope=1,col="red")+
  geom_point()+
  scale_x_log10()+
  scale_y_log10()+
  stat_cor()+
  labs(y="Catch per species / country",
       x="Landings per species / vessel flag")

ggplot(intern.consist,aes(x=log.ratio))+
  stat_bin(binwidth=0.1)+
  labs(x="Log10 (Landings / Catch ) per species country",
       y="Frequency")


```

## EUMOFA vesus EUROSTAT Landings

Ideally, the EUMOFA data should also agree very closely with the EUROSTAT landings data. Here we check these assumptions.

```{r}
#EUMOFA relevant imports
EUMOFA.dat <- readRDS(here("objects/EUMOFA/EUMOFA_data.rds"))
MCS.ERS.key <- readRDS(here("objects/EUMOFA/MCS-ERS_key.rds"))

#Aggregate EUROSTAT data to a common taxonomy with EUMOFA
EUROSTAT.landings.geo.MCS <-
  #Tweak tibble first
  EUROSTAT.landings  %>%
  filter(unit=="EUR") %>%
  #Merge in MCS categories
  right_join(x=MCS.ERS.key,by="species") %>%
  filter(!is.na(MCS)) %>%
  #Aggregate across MCS
  group_by(MCS,geo,.drop=TRUE)%>%
  summarise(EUROSTAT.landings.val=sum(value,na.rm=TRUE))

#EUMOFA
#We assume that all of the landings in a harbour are coming
#from the adjacent FAO region
EUMOFA.landings.geo.MCS <- 
  EUMOFA.dat%>%
  filter(!is.na(CNTR_CODE)) %>%
  #Now aggregate up to the national level
  group_by(MCS,CNTR_CODE) %>%
  summarise(EUMOFA.value=sum(value)) %>%
  ungroup()

# Combine to get external landings consistency
ext.consistency <- 
  left_join(EUMOFA.landings.geo.MCS,EUROSTAT.landings.geo.MCS,
            by=c("MCS",CNTR_CODE="geo")) %>%
  mutate(log.ratio=log10(EUMOFA.value/EUROSTAT.landings.val))

ggplot(ext.consistency,aes(EUMOFA.value,EUROSTAT.landings.val))+
  geom_abline(slope=1,colour="red")+
  geom_point()+
  scale_x_log10()+
  scale_y_log10()+
  stat_cor()+
  labs(x="EUMOFA value (by MCS and country)",
       y="EUROSTAT landigns value (by MCS and country)")

ggplot(ext.consistency,aes(x=log.ratio))+
  stat_bin(binwidth=0.1)+
  labs(x="Log10 (EUMOFA value / EUROSTAT landings value)",
       y="Frequency")

```

## Nearest Neighbour Assumption

In order to relate the landings in a region (EUMOFA data) to the hazard of a stock, we need to know where these landings were caught. We make the assumption here that all landings in EUMOFA are from the adjacent FAO subarea. We can check the validity of this "nearest neighbour" assumption by calculating the landings per stock per country that this implies and comparing it to the EUROSTAT catch data (catch per stock per country)

```{r}
#Aggregate EUROSTAT catch data to a common taxonomy with EUMOFA
EUROSTAT.catch.MCS.fishreg <- 
  stock.catch %>%
  #Merge in MCS categories
  right_join(x=MCS.ERS.key,by="species") %>%
  filter(!is.na(MCS)) %>%
  #Tweak FAO subareas
  mutate(F_CODE=gsub("_",".",fishreg)) %>%
  #Aggregate across MCS
  group_by(MCS,geo,F_CODE,.drop=TRUE)%>%
  summarise(EUROSTAT.catch=sum(catch,na.rm=TRUE))

#Aggregate EUMOFA data to the national level, based on the nearest neighbour assumption
EUMOFA.landings.fishreg.MCS <-
  EUMOFA.dat %>%
  filter(!is.na(CNTR_CODE)) %>%
  group_by(MCS,CNTR_CODE,F_CODE,.drop=TRUE) %>%
  summarise(EUMOFA.landings=sum(landings))

#Now join the two
nn.consistency <-
  left_join(EUMOFA.landings.fishreg.MCS,EUROSTAT.catch.MCS.fishreg,
            by=c("MCS",CNTR_CODE="geo","F_CODE")) %>%
  mutate(log.ratio=log10(EUMOFA.landings / EUROSTAT.catch))

ggplot(nn.consistency,aes(x=EUMOFA.landings,y=EUROSTAT.catch))+
  geom_abline(slope=1,colour="red")+
  geom_point()+
  scale_x_log10()+
  scale_y_log10()+
  stat_cor()+
  labs(x="EUMOFA landings (by MCS, country, FAO subarea)",
       y="EUROSTAT landings (by MCS, country, FAO subarea)")


```

