## Biological metrics


### Species-specific metrics

```{r}
sp.metrics <- readRDS(here("objects/biological_metrics/species_metrics.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))

ggplot(sp.metrics,aes(x=lifespan.score))+
  stat_ecdf()+
  labs(x="Lifespan score",y="Cumulative proportion")
  
```

```{r}
ggplot(sp.metrics,aes(x=factor(habitat.score)))+
  stat_count()+
  labs(x="Habitat score",y="Frequency")
```

As a cross check that we have implemented the coversion from these metrics to a hazard, we plot one against the other, to ensure that the trend is as intended

```{r}
ggplot(stk.haz,aes(x=lifespan.score,y=hazard)) +
  geom_point()+
  stat_smooth()

```
 
So, longer-lived species have a higher hazard score. Tick.
 
```{r}
ggplot(stk.haz,aes(x=habitat.score,y=hazard,group=habitat.score))+
  geom_boxplot()
```

So species with a higher habitat-specificity have a higher hazard. Tick.

### Stock-specific metrics

Small stocks are a potential problem in this analysis. We first check the distribution of stock sizes (expressed as value of landings) relative to the total size (value) of the species.

```{r}
filt.stock.haz <- 
  stock.haz %>%
  filter(!is.na(hazard))

ggplot(filt.stock.haz,aes(x=st.prop)) +
  stat_ecdf()+
  labs(x="Proportion of the species total in the stock, by value",
       y="Cumulative proportion of stocks")+
  scale_x_log10()
```

We can therefore see that there are an awful lot of stocks that don't contribute much landigns value - is is a natural consequence of the way that we have defined a stock in this case. We choose to filter out all stocks that have a landings value less than 5% of the species total.

```{r}
filt.stock.haz <- filt.stock.haz %>%
  filter(st.prop>0.05)

```

This leaves us with `r nrow(filt.stock.haz)` stocks. Looking at the distribution of TSM's of these remaining stocks.

```{r}
ggplot(filt.stock.haz,aes(x=median.TSM))+
  stat_bin()+
  labs(x="Stock TSM (deg C)",y="Frequency")
```

And cross checking the hazard implementation.

```{r}
ggplot(filt.stock.haz,aes(x=median.TSM,y=hazard))+
  geom_point()
```

Low TSMs => higher hazards. Tick. The stripping rises due to the categorical natural of the other metrics.

### Species-level hazard

We can look at our biological analysis by integrating the hazard back up to the species level by weighting by the value of landings of each stock. 

```{r}
sp.hazard <- readRDS(here("objects/biological_metrics/species_hazard.rds"))

ggplot(sp.hazard,aes(x=hazard))+
  stat_bin()


```

Looking at the top and bottom ten species

```{r}

firstNlast <- function(x,n=10) {
  bind_rows(head(x,n=n),tail(x,n=10))
}

knitr::kable(
  sp.hazard %>%
    mutate(rank=rank(-hazard)) %>%
  arrange(rank) %>%
  firstNlast()
)
```

