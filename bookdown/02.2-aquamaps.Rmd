## Biological exposure and sensitivity
```{r echo=FALSE}
#Setup --------------------------------------
library(tidyverse)
library(here)
library(sf)
species.sub <- read_csv2(here("data/Taxonomic_issues/alternative_names.csv"))
trait.db <- readRDS(here("objects/trait_database.rds"))
amap.meta <- readRDS(here("objects/Aquamaps/Aquamaps_meta.rds"))
```

We use habitat maps generated by the website http://www.aquamaps.org to form the basis for calculating the exposure and sensitivty metrics of each species. This website produces standardized distribution maps of over 25 000 species, based on empirically-derived species distribution models. 
We downloaded "native distribution maps" from the Aquamaps website for all of the species selected for further processing. In many cases, Aquamaps contains many multiple distribution maps for the same species, and the map was therefore chosen based on the internal map quality ranking system ("Expert reviewed" > "Team reviewed" > "Computer generated").  


### Use of Aquamaps 

```{r}
#Setup Aquamaps ------------------------------------------------------
#Note that the selection of species is done in script C3, to avoid having to load all of the
#aquamaps here
this.amap <-
  readRDS(here("objects/Aquamaps/selected_map.rds")) %>%
  filter(!is.na(F_CODE)) #Restract to focus regions
this.misc <- readRDS(here("objects/Aquamaps/selected_metrics.rds"))
FAO.regions <- readRDS(here("objects/FAO_polygons.rds"))
FAO.focus <- "27.4"
```
We illustrate the use of Aquamaps to generate data using `r sprintf("%s (*%s*)",this.misc$meta$common.name,this.misc$meta$scientific.name)` as an example. 

The Aquamap for this species looks like so:

```{r fig.cap=paste("Aquamap native distribution map for",this.misc$meta$common.name)}


ggplot(this.amap,aes(Center.Long,Center.Lat,fill=Overall.Probability))+
  geom_raster()+
  annotation_map(map_data("world"),fill="black")+
  coord_quickmap()+
  scale_fill_viridis_c()+
  labs(x="",y="",fill="Probability")
```

The thermal envelope fitted for this species by Aquamaps looks like so.

```{r fig.cap=paste("Thermal preference curve for", this.misc$meta$common.name,"as fitted by Aquamaps. The dashed vertical line indicates the upper-thermal limit applied here.")}
temp.dat <-  tibble(temp=with(this.misc$meta,c(Temp.Min,Temp.Pref.Min..10th.,
                                               Temp.Pref.Max..90th.,Temp.Max)),
                    prob=c(0,1,1,0))
ggplot(temp.dat,aes(temp,prob))+
  geom_line()+
  labs(x="Temperature (deg C)",y="Probability")+
  geom_vline(xintercept=with(this.misc$meta,(Temp.Pref.Max..90th.)),linetype=2)

```

Aquamaps chooses either SST or SBT, depending on the characteristics of the species. 

It is clear that are high temperatures, the probability of a point in space being suitable habitat falls off to zero. In Aquamaps terminology, the point where this starts is the 90th percentile of the distribution, and we use this as the basis for defining the thermal safety margin, TSM, as follows.

$$TSM_i=T_{90^{th}}-T_{i}$$

where $TSM_i$ is the thermal safety margin of pixel *i*, $T_{90^{th}}$ is the 90th percentile and $T_i$ is the temperature at a given pixel.

Aquamaps provides the environmental data that underlies its models. We use this data for all analyses to ensure consistency between the thermal envelope parameters and both the current and projected temperatures. For `r this.misc$meta$common.name`, the distribution of temperature looks like so:

```{r fig.cap=paste("Aquamaps temperature for",this.misc$meta$common.name)}
ggplot(this.amap,aes(Center.Long,Center.Lat,fill=this.temp))+
  geom_raster()+
  annotation_map(map_data("world"),fill="black")+
  coord_quickmap()+
  labs(x="",y="",fill="Temp (deg C)")

```


Combining the temperature with the thermal threshold allows us to calculate, and map, the thermal safety margin (TSM) as a function of space

```{r fig.cap=paste("Aquamaps TSM (deg C) for",this.misc$meta$common.name)}
ggplot()+
  geom_raster(data=this.amap,mapping=aes(Center.Long,Center.Lat,fill=TSM))+
  geom_sf(data=FAO.regions,fill=NA)+
  annotation_map(map_data("world"),fill="black")+
  geom_sf_text(data=FAO.regions,aes(label=F_CODE),colour="blue")+
  labs(x="",y="",fill="TSM (deg C)")+
  scale_fill_distiller(palette = "YlOrBr")+
  coord_sf(ylim=c(40,90))
```

In this case, we have also overlayed the FAO regions, and added the labels. Focusing on a particular FAO region (e.g. `r FAO.focus`), we can examine the distribution of TSMSs

```{r fig.cap=paste("Distribution of TSM values for FAO region",FAO.focus," The dashed vertical line indicates the median value.")}
this.FAO.amap <- this.amap %>%
  filter(F_CODE==FAO.focus) 
ggplot(this.FAO.amap,aes(x=TSM))+
  stat_bin()+
  geom_vline(xintercept=median(this.FAO.amap$TSM),linetype=2)
```

The Aquamaps environmental database also contains temperature projections, based on the IPSL model under IPCC scenario A2. We can use this to calculate the rate of warming for each pixel within the habitat of cod over the period (1999-2050).

```{r fig.cap=paste("Average rate of warming derived from Aquamaps")}
scale.fn <- function(x) {
  c(-max(abs(x)),max(abs(x)))
}
ggplot()+
  geom_raster(data=this.amap,mapping=aes(Center.Long,Center.Lat,fill=this.warm.rate))+
  geom_sf(data=FAO.regions,fill=NA)+
  annotation_map(map_data("world"),fill="black")+
  geom_sf_text(data=FAO.regions,aes(label=F_CODE),colour="blue")+
  coord_sf(ylim=c(40,90))+
  labs(x="",y="",fill="Warming (deg C/yr)")+
  scale_fill_distiller(palette="RdBu",limits=scale.fn)

```

This clearly shows that not all areas are warming, or equally.

```{r fig.cap=paste("Distribution of warming rate values for FAO region",FAO.focus," The dashed vertical line indicates the median value.")}
ggplot(this.FAO.amap,aes(x=this.warm.rate))+
  stat_bin()+
  geom_vline(xintercept=median(this.FAO.amap$this.warm.rate),linetype=2)+
  labs(x="Warming rate (deg C / yr)",y="Number of pixels")
```

Now, we can repeat the exercise for all FAO areas for this species, and plot the two median values of the metrics against each other.

```{r}
ggplot(this.misc$metrics,aes(x=median.TSM,y=median.warm.rate))+
  geom_point()+
  geom_hline(yintercept = 0)  +
  geom_text(aes(label=F_CODE),vjust=-1)+
  labs(x="TSM (deg C)",y="Warming rate (deg C / yr)")
```

This figure forms the basis of defining our exposure and sensitivity metrics for `r this.misc$meta$common.name`. The region with the highest vulnerability is that in the top-left i.e. where the TSM is low and the warming rate is high. Regions with negative warming rates are essentially cooling and therefore should have the lowest vulnerability score.

QUESTION: These are the exposure and sensitivies in the old framework. How do we combine them best?

As an aside, I also considered defining a relative TSM, by normalising the TSM by the rate of warming. i.e.

$$RTSM_i=\frac{T_{90^{th}}-T_{i}}{r_{warm}}$$
where $r_{warm}$ is the rate of warming, in degrees C per year - RTSM therefore has units of years, and could be interpreted as the number of years until the TSM was exceeded. However, although this seemed like a good idea at the time, it didn't really workout in practice very well - the negative and zero warming rates lead to many RTSMs that were extremely large.


