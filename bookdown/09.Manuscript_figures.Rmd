---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Manuscript figures

```{r}
#Setup
library(tidyverse)
library(here)
library(sf)
library(scales)
library(RColorBrewer)
library(ggrepel)
library(gridExtra)
library(grid)
library(ggspatial)
library(gtable)
library(sp)

#Import
sp.db <- readRDS(here("objects/species_database.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
flt.haz <- readRDS(here("objects/fleet_metrics/Fleet_hazard.rds"))
flt.catch <- readRDS(here("objects/catch/STECF_catch_data.rds"))

cty.sf <- readRDS(here("objects/Geodata/nation_regions.rds"))

#Map defaults
library(rnaturalearth)
library(rnaturalearthdata)
wrld <- ne_countries(scale = "medium", returnclass = "sf")

#CERES colours
CERES.div.pal <- c("#006494","#44B4AF","#88D2B1","#CCEDD0","#FFFFFF",
               "#F6CCF9","#ED88CC","#DF4472","#CC1104")
CERES.seq.pal <- c("#00336D","#005E86","#00919E","#00B69E","#04CC87",
                   "#44DF6E","#8DED88","#DFF9CC")
#Fill scale
# map.fill.scale <- scale_fill_gradientn(colours=CERES.seq.pal,
#                        breaks=seq(0,1),
#                        limits=c(0,1),
#                        labels=c("Lowest","Highest"))
map.fill.scale <- 
  scale_fill_viridis_c(breaks=seq(0,1,by=0.25),
                       limits=c(0,1),
                       labels=c("Lowest","","","","Highest"))
map.theme <- 
  list(annotation_map(map_data("world"),fill="lightgrey",colour="grey"),
       map.fill.scale,
       theme_void(),
       theme(panel.border = element_rect(fill=NA)),
       annotation_scale(location = "br", width_hint = 0.25,pad_y=unit(0.1,"cm")))

map.coords <- coord_sf(xlim=c(-22,35),ylim=c(35,70))


#Inset map
inset.map <- function(this.d,this.aes,this.title,zm.factor) {
  #Recalculate xlim and ylim
  this.sp <- 
    this.d %>%
    as_Spatial()
  this.asp <- cos(mean(bbox(this.sp)[2,])*pi/180)
  x.size <- diff(bbox(this.sp)[1,])
  y.size <- diff(bbox(this.sp)[2,])
  this.size <- pmax(x.size*this.asp,y.size)/zm.factor
  xlims <- mean(bbox(this.sp)[1,])+c(-this.size,this.size)/2/this.asp
  ylims <- mean(bbox(this.sp)[2,])+c(-this.size,this.size)/2
  
  ins <- ggplot()+
    #fixed_plot_aspect(ratio = 1/this.asp)+
    geom_sf(data=this.d,mapping=this.aes)+
    coord_sf(xlim=xlims,ylim=ylims,expand=FALSE)+
    map.fill.scale+
    #labs(title=this.title)+
    theme_void()+
    theme(legend.position="none",
     #     panel.background = element_rect(colour="red"),
     #     plot.margin=margin(l=0.1,b=0.1,unit="cm"),
          plot.background=element_rect(fill="white",colour="black"),
          plot.title = element_text(size = rel(0.8)))+
    annotation_scale(location="bl",
                     width_hint = 0.25,
                     style="bar",
                     pad_y=unit(0.1,"cm"),pad_x=unit(0.1,"cm")) +
    annotate("label",x=-Inf,y=Inf,label=this.title,
             hjust="left",
             vjust="top",
             size=3,fill=NA,
             label.padding=unit(0.1,"cm"),label.size=0)
  
  # ins <- ggplot()+
  #   #fixed_plot_aspect(ratio = 1/this.asp)+
  #   geom_sf(data=this.d,mapping=this.aes)+
  #   map.fill.scale+
  #   labs(title=this.title)+
  #   theme_void()+
  #   theme(legend.position="none",
  #         panel.background = element_rect(colour="red"),
  #    #     plot.margin=margin(l=0.1,b=0.1,unit="cm"),
  #         plot.background=element_rect(fill="white",colour="black"),
  #         plot.title = element_text(size = rel(0.8)))+
  #   scale_x_continuous(expand=c(expand[1],expand[1]))+
  #   scale_y_continuous(expand=c(expand[2],expand[2]))+
  #   annotation_scale(location="bl",
  #                    width_hint = 0.25,
  #                    style="bar",
  #                    pad_y=unit(0.1,"cm"),pad_x=unit(0.1,"cm")) 

  return(ins)

}



```

## Country Level Hazard

```{r}


#Plot of the average hazard per country, based on catches
EUROSTAT.catch.stk.geo <-   readRDS(here("objects/EUROSTAT/catch.stock.geo.rds")) 
EUROSTAT.value.sp.geo <- readRDS(here("objects/EUROSTAT/value.species.country.rds"))

geo.haz <- 
  #Stock proportions
  EUROSTAT.catch.stk.geo %>%
  group_by(species,geo) %>%
  mutate(sp.catch=sum(catch),
         stk.prop=catch/sp.catch) %>%
  #Add in the value of the species by coutnry
  left_join(y=EUROSTAT.value.sp.geo,by=c("species","geo")) %>%
  mutate(stk.value=stk.prop*value) %>%
  filter(!is.nan(stk.value)) %>%
  #Add in stock hazard
  left_join(y=stk.haz,by=c("species"="FAO_3A_code","fishreg"="F_CODE")) %>%
  select(species,fishreg,geo,stk.value,hazard) %>%
  filter(!is.na(hazard),
         !is.na(stk.value))

geo.haz.sum <- 
  geo.haz %>%
  #Summarise
  group_by(geo) %>%
  mutate(total.value=sum(stk.value),
         stk.prop.value=stk.value/total.value) %>%
  summarise(mean.haz=sum(stk.prop.value*hazard)) %>%
  mutate(rs.haz=rescale(mean.haz)) %>%
  #Add in countries
  right_join(x=cty.sf,by=c("CNTR_CODE"="geo")) %>%
  arrange(rs.haz)

#Setup map
inset.malta <- 
  inset.map(filter(geo.haz.sum,CNTR_CODE=="MT"),
            aes(fill=rs.haz),
            "Malta",
            zm.factor=0.7)
  
ins.size <- 0.2
malta.grb  <-
    arrangeGrob(inset.malta,
                widths=unit(c(ins.size,1-ins.size),"snpc"),
                heights=unit(c(1-ins.size,ins.size),"snpc"),
                layout_matrix=rbind(c(NA,NA),c(1,NA)))

# inset.bg <- rectGrob(0,0,width=ins.size,height=ins.size,
#                      gp=gpar(),
#                      default.units="npc",
#                      just=c("left","bottom"))



ggplot(geo.haz.sum)+
  map.theme+
  geom_sf(aes(fill=rs.haz),size=0.25,col="black")+
  map.coords+
  labs(fill="Climate\nHazard")+
  #annotation_custom(inset.bg)+
  annotation_custom(malta.grb)

```


## Fleet Analysis

Firstly, the top and bottom 10

```{r}
flt.risk <- 
  readRDS(here("objects/fleet_metrics/Fleet_risk.rds")) %>%
  filter(!is.na(risk),
         !is.infinite(risk)) %>%
  mutate(hazard.rank=rank(hazard),
         exposure.rank=rank(exposure),
         vulnerability.rank=rank(vulnerability),
         risk.rank=rank(risk)) %>%
  arrange(risk) 

flt.tbl <- function(x) {
  knitr::kable(
    x %>%
      select("Fleet segement"=fs_name,
             "Value of landings"=total.val.landings,
             "Hazard rank"=hazard.rank,
             "Exposure rank"=exposure.rank,
             "Vulnerability rank"=vulnerability.rank,
             "Risk rank"=risk.rank),
    caption="Top and bottom 10 fleets by risk",
    digits=0)
}
flt.tbl(head(flt.risk,n=10))
flt.tbl(tail(flt.risk,n=10))
```
Caption: Fleet segments with the top and bottom 10 climate risk scores.

In total, we have been able to assess risk for `r nrow(flt.risk)` fleet segments.

```{r, fig.cap=""}
flt.plt.dat <-
  flt.risk %>%
  mutate(length.class=gsub("^(.{2})(.{2})$","\\1-\\2",length),
         length.class=replace(length.class,length.class=="40-XX",">40"),
         length.class=factor(length.class),
         length.class=fct_relevel(factor(length.class),">40",after=Inf),
         risk.rescale=rescale(risk)) %>%
  mutate(gear=fct_reorder(gear,risk.rescale))

comb.lvls <- c(levels(flt.plt.dat$length.class),levels(flt.plt.dat$gear))



flt.plt.items <- 
  list(
    stat_boxplot(),
    stat_summary(geom="text",
                 fun.data=function(y) {
                   return(data.frame(
                     y = 1,
                     vjust=-0.25,
                     label = length(y)))}),
      scale_y_continuous(limits=c(0,1),breaks=c(0,1),
                         minor_breaks=seq(0,1,by=0.25),labels=c("Lowest","Highest"))
  )

flt.plt.dat %>%
  #Reshape into panel plot
  select("a) Length class (m)"=length.class,"b) Gear type"=gear,risk.rescale) %>%
  gather("metric","value",-risk.rescale) %>%
  mutate(value=factor(value,levels=comb.lvls)) %>%
  ggplot(aes(x=value,y=risk.rescale))+
  flt.plt.items+
  labs(x="",y="Climate risk")+
  facet_wrap(~metric,scales="free_x")+
  theme(axis.text.x = element_text(angle = 45,hjust=1))


```
Caption: Climate risk as a function of the size range of vessels in each fleet segment. Note that the STECF definitions of length range vary between country and therefore have a degree of overlap. The distribution of risk is represented on a linear scale from highest to lowest: the absolute values are not shown, as they have little direct meaning. Risk is shown as a boxplot, where the horizontal line is the median, the box corresponds to the interquartile range (IQR), and the whiskers cover all points less than 1.5 times the IQR from the box. Outliers are plotted as points. The  number of fleet segments in each class is shown at the top: in total there are `r nrow(flt.risk)` fleet segments in the analysis.


```{r results="asis"}
#Import gear code table
fishtech.codes <- 
  read_csv(here("data/STECF_Fleet_data/fishing_technology_codes.csv")) %>%
  filter(fishing_tech %in% flt.plt.dat$gear)

  cat(paste(sprintf("%s: %s",fishtech.codes$fishing_tech,fishtech.codes$description), collapse=", "))
```



QUESTION: I'm not quite sure how whether to retain the other fishing region fleets, or just keep it to the FAO27 and FAO37 areas - we don't have very much biological information outside these regions.

QUESTION: I can also plot this as a map, based on the median value...

```{r, fig.cap=""}
flt.risk.cnty <- 
  flt.risk %>%
  mutate(country=fct_reorder(country_2A,risk),
         gear=fct_reorder(gear,risk))

ggplot(flt.risk.cnty,
       aes(x=country,y=risk))+
  stat_boxplot()+
  flt.plt.items+
  labs(x="Fleet Country (sorted by median risk)",y="Climate risk")
```
CAPTION:

## Regional Analysis

### Components

```{r}
#Import data
reg.risk <- readRDS(here("objects/regional_metrics/regional_risk.rds"))
reg.poly <- readRDS(here("objects/Geodata/region.polys.rds"))


#First make region map of region
#Purpose: Show relative distributons in the three underlying metrics
reg.risk %>%
  select(-risk,-country) %>%
  gather("metric","value",-region) %>%
  mutate(metric=fct_recode(metric,
                           "a) Hazard"="hazard",
                           "b) Exposure"="exposure",
                           "c) Vulnerability"="vulnerability"),
         metric=factor(metric,levels=sort(levels(metric)))) %>%
  right_join(x=reg.poly,by="region") %>%
  ggplot()+
  annotation_map(map_data("world"),fill="lightgrey",colour="grey")+
  geom_sf(aes(fill=value))+
  theme_bw()+
  map.fill.scale+
  #  coord_sf(crs=sf::st_crs(3035))+   #Lambert Azimuthal equal area (3035)
  facet_grid(cols=vars(metric))+
  labs(fill="Metric")

```

Caption: Map of the individual elements of the regional risk analysis. a) Hazard b) Exposure and c) Vulnerability are plotted for each of the regions in the analysis. Each metric is rescaled so that the range between panels is identical. Colour scale is linear in the value of the corresponding score,but is presented without values as they have little direct meaning. National-level borders are shown for reference.

TODO: 

* Reproject to a Lambert Azimuthal Equal-area projections
* Check Iceland problems
* Map inserts for Malta and other small countries
* Could be merged with the overall figure for regional risk, but I think it makes more sense to have it separate. 

### Regional Risk



```{r}
#Purpose: show the relative values and patterns in Risk
region.map.dat <- 
  reg.risk %>%
  right_join(x=reg.poly,by="region") 

inset.malta <- inset.map(filter(region.map.dat,country=="MT"),
                        aes(fill=risk),
                        "Malta",
                        zm.factor = 0.7)

inset.canary <- inset.map(filter(region.map.dat,region=="ES70"),
                        aes(fill=risk),
                        "Canarias (ES)",
                        zm.factor=0.8)


fig.size <- 0.2
f.marg <- 0.01
ag <- 
    arrangeGrob(inset.malta,inset.canary,
                widths=c(f.marg,fig.size,1-fig.size-f.marg),
                heights=c(1-2*fig.size-f.marg,fig.size,fig.size,f.marg),
                layout_matrix=rbind(c(NA,NA,NA),c(NA,1,NA),c(NA,2,NA),c(NA,NA,NA)))

# inset.bg <- rectGrob(0,0,width=fig.size+f.marg,height=2*fig.size,
#                      gp=gpar(),
#                      default.units="npc",
#                      just=c("left","bottom"))



g <- ggplot()+
  map.theme+
  geom_sf(data=region.map.dat,aes(fill=risk),size=0.25,col="black")+
  #  coord_sf(crs=sf::st_crs(3035))+   #Lambert Azimuthal equal area (3035), as recommended by EEA
  map.coords+
  labs(fill="Climate\nRisk")+
  annotation_custom(ag)

print(g)

```

Caption: Map of the regional climate risk.  Colour scale is linear in the value of the corresponding score, but is presented without values, as they have little direct meaning. National-level borders are shown for reference.

TODO: * Reproject to a Lambert Azimuthal Equal-area projections

## Combined analysis

```{r}
reg.risk.med <-
  reg.poly %>%
  st_set_geometry(NULL) %>%
  left_join(x=reg.risk,by="region") %>%
  unite(country.seaboard,country,seaboard,na.rm=TRUE,sep="-") %>%
  group_by(country.seaboard) %>%
  summarise(reg.risk=median(risk))

flt.risk.med <- 
  flt.risk.cnty %>%
  filter(area!="OFR") %>%
  mutate(seaboard=fct_recode(area,"Med"="A37","Atl"="A27"),
         country.seaboard=ifelse(country %in% c("ES","FR"),
                                 paste(country,seaboard,sep="-"),
                                 as.character(country))) %>%
  group_by(country.seaboard) %>%
  summarise(flt.risk=median(risk))

comb.dat <- 
  full_join(x=reg.risk.med,y=flt.risk.med,by="country.seaboard")

ggplot(comb.dat,aes(x=reg.risk,y=flt.risk))+
  geom_vline(xintercept=0.5,col="darkgrey",lty=2)+
  geom_hline(yintercept=0.5,col="darkgrey",lty=2)+
  annotate("label",x=0,y=0,label="Lowest risk",hjust=0,vjust=0)+
  annotate("label",x=1,y=1,label="Highest risk",hjust=1,vjust=1)+
  annotate("label",x=0,y=1,label="Fleet risk dominates",hjust=0,vjust=1)+
  annotate("label",x=1,y=0,label="Regional risk dominates",hjust=1,vjust=0)+  
  geom_text_repel(aes(label=country.seaboard),seed=43)+
  geom_point(col="red")+
  scale_y_continuous(limits=c(0,1),breaks=c(0,1),
                     minor_breaks=seq(0,1,by=0.25),labels=c("Lowest","Highest"))+
  scale_x_continuous(limits=c(0,1),breaks=c(0,1),
                     minor_breaks=seq(0,1,by=0.25),labels=c("Lowest","Highest"))+
  labs(x="Median regional risk",
       y="Median fleet risk")

```

Caption: Note that Iceland and Norway are not shown, as there is no fleet data available for these countries. Note that we use straight medians, rather than weighted medians, as there is no clear value-of-fisheries data available for the regions. Or maybe there is in EUMOFA. Check this.



