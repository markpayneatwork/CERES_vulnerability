---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Manuscript figures

```{r}
#Setup
library(tidyverse)
library(here)
library(sf)
library(scales)

#Import
sp.db <- readRDS(here("objects/species_database.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
flt.haz <- readRDS(here("objects/fleet_metrics/Fleet_hazard.rds"))
flt.catch <- readRDS(here("objects/catch/STECF_catch_data.rds"))

#Map defaults
library("rnaturalearth")
library("rnaturalearthdata")
wrld <- ne_countries(scale = "medium", returnclass = "sf")

#CERES colours
CERES.div.pal <- c("#006494","#44B4AF","#88D2B1","#CCEDD0","#FFFFFF",
               "#F6CCF9","#ED88CC","#DF4472","#CC1104")
CERES.seq.pal <- c("#00336D","#005E86","#00919E","#00B69E","#04CC87",
                   "#44DF6E","#8DED88","#DFF9CC")


```


## Fleet Analysis

## Regional Analysis

### Components

```{r}
#Import data
reg.risk <- readRDS(here("objects/regional_metrics/regional_risk.rds"))
reg.poly <- readRDS(here("objects/Geodata/region.polys.rds"))

bg.map <- 
  list(scale_fill_gradientn(colours=CERES.seq.pal,breaks=c(0,1),labels=c("Lowest","Highest")),
       theme_bw(),
       theme(panel.grid.major = element_line(color = "lightgrey", linetype = "dotted", size = 0.5)))

#First make region map of region
#Purpose: Show relative distributons in the three underlying metrics
reg.risk %>%
  select(-risk,-country) %>%
  gather("metric","value",-region) %>%
  mutate(metric=fct_recode(metric,
                           "a) Hazard"="hazard",
                           "b) Exposure"="exposure",
                           "c) Vulnerability"="vulnerability"),
         metric=factor(metric,levels=sort(levels(metric)))) %>%
  right_join(x=reg.poly,by="region") %>%
  ggplot()+
  annotation_map(map_data("world"),fill="lightgrey",colour="grey")+
  geom_sf(aes(fill=value))+
  bg.map+
  #  coord_sf(crs=sf::st_crs(3035))+   #Lambert Azimuthal equal area (3035)
  facet_grid(cols=vars(metric))+
  labs(fill="Metric")

```

Caption: Map of the individual elements of the regional risk analysis. a) Hazard b) Exposure and c) Vulnerability are plotted for each of the regions in the analysis. Each metric is rescaled so that the range between panels is identical. Colour scale is linear in the value of the corresponding score,but is presented without values as they have little direct meaning. National-level borders are shown for reference.

TODO: 

* Reproject to a Lambert Azimuthal Equal-area projections
* Check Iceland problems
* Map inserts for Malta and other small countries
* Could be merged with the overall figure for regional risk, but I think it makes more sense to have it separate. 

### Regional Risk

```{r}
#Purpose: show the relative values and patterns in Risk
reg.risk %>%
  right_join(x=reg.poly,by="region") %>%
  ggplot()+
  annotation_map(map_data("world"),fill="lightgrey",colour="grey")+
  geom_sf(aes(fill=risk))+
  bg.map+
  #  coord_sf(crs=sf::st_crs(3035))+   #Lambert Azimuthal equal area (3035)
  labs(fill="Climate\nrisk")

```

Caption: Map of the regional climate risk.  Colour scale is linear in the value of the corresponding score, but is presented without values, as they have little direct meaning. National-level borders are shown for reference.

TODO: 

* Reproject to a Lambert Azimuthal Equal-area projections
* Check Iceland problems
* Map inserts for Malta and other small countries



