## Biological Metrics
```{r echo=FALSE}
#Setup --------------------------------------
library(tidyverse)
library(here)
library(sf)
trait.db <- readRDS(here("objects/trait_database.rds"))
manja.dat <- read_csv2(here("data/Traits/Manja/compare metrics.csv"))
amaps.meta <- readRDS(here("objects/Aquamaps/Aquamaps_meta.rds"))


```


### Preselection of Species

European fisheries cover an extremely broad range of biogeographic zones, ranging from the near-tropical waters of North Africa to the near-polar waters of the Barents Sea: distant water fleets expand this range even further to include essentially all of the world's oceans. This results in an unmanagably large number of species that could be included in this analysis. We therefore first performed an initial screening to narrow this set of species down to a more manageable size. We employed the value of landings data provided by the "EUROSTAT catch" dataset to select species that cover 90% of landings by value, both at the European wide level and on a country-by-country basis. This analysis narrowed the 1200 species reported in this database down to `r nrow(manja.dat)` species groups. Entries that were not taxnomically resolved to either species or genus level were removed from the analysis, as it was deemed to be too difficult to extract representative biological information at such a coarse level.

This initial species list contained `r sum(manja.dat$n.xx.in.TAXOCODE>2,na.rm=TRUE)` entries that were only taxonomically resolved to the Genius level ("bucket categories"). For the purpose of defining traits and further analysis, exemplar species were chosen to represent this group. In some cases, it was necessary to use different exemplars for the North Atlantic (FAO 27) and Mediterranean regions (FAO 34) (see supplementary material). Furthermore, two species that are predominately freshwater, European perch (*Perca fluviatilis* FAO code FPE) and Pike-perch (*Sander lucioperca* FAO code FPP) were also removed from the database. Two further groups, Barnacles (*Pollicipes pollicipes* FAO code PCB) and Solen razor clams (*Solen spp* FAO code RAZ) were also removed, as it was not possible to find appropriate Aquamaps or identify suitable exemplars. Alternative (and misspelled) scientific names were also a problem in many cases. A list of corrections is also supplied in the Supplementary Material. 

### Species-specific metrics

TODO: 
* Response of an organism to climate change depends on its inherent characteristics (traits)
* Traits are important short-hand for climate sensitivities and are widely used.

However, a key point that is often overlooked in many climate vulnerability analyses is that biological traits are often correlated. For example, small fish tend to have short life-spans, fast growth rates and sit on relatively low trophic levels, while large fish live longer, grow slower and are near the topic of the foodweb. Disregarding these correlations between traits can therefore bias the analysis.

Previous work (Pecuchet et al. 2017) has shown  that fish communities in European seas can be readily decomposed into three life-history strategies (LHS), based on their traits. Maximum length, lifespan and trophic level were highly correlated with each other  and formed the primary axis discriminating the "opportunistic" LHS identified in this paper. This LHS was also shown to be associated with seasonal and variable environments, and there implies robustness to change and variability. Following from these conclusions, we employed one metric of this axis, the Lifespan, as an indicator of sensitivity to climate change, with shorter lifespans being associated with reduced sensitivity. 

TODO:
* Habitat specificity traits. Three traits were combined and scored (see table)
  + a low score infers low habitat specificity or good adaptive capacity 
  +a high habitat specificity score indicates a species with low adaptive capacity.
  
![](resources/Habitat_table.png)

We used the trait database developed by Pecuchet et al 2017 (TODO: reference to Panagea dataset) and Engelhardt et al 2011 as the primary sources of trait information for the species considered in this work. Traits for species that were not covered by these two databases were filled based on literature searches (e.g. shellfish), primarily from Fishbase and Sealifebase.

### Species-specific metrics
```{r echo=FALSE}
#Setup --------------------------------------
library(tidyverse)
library(here)
library(sf)
species.sub <- read_csv2(here("data/Taxonomic_issues/alternative_names.csv"))
trait.db <- readRDS(here("objects/trait_database.rds"))
amap.meta <- readRDS(here("objects/Aquamaps/Aquamaps_meta.rds"))
```

We use habitat maps generated by the website http://www.aquamaps.org to form the basis for estimating thermal safety margins and for placing species in a spatial context. This website produces standardized distribution maps of over 25 000 species, based on empirically-derived species distribution models. We downloaded "native distribution maps" from the Aquamaps website for all of the species above In many cases, Aquamaps contains many multiple distribution maps for the same species, and the map was therefore chosen based on the internal map quality ranking system ("Expert reviewed" > "Team reviewed" > "Computer generated").  

```{r}
#Setup Aquamaps ------------------------------------------------------
#Note that the selection of species is done in script C3, to avoid having to load all of the
#aquamaps here
this.amap <-
  readRDS(here("objects/Aquamaps/selected_map.rds")) %>%
  filter(!is.na(F_CODE)) #Restract to focus regions
this.misc <- readRDS(here("objects/Aquamaps/selected_metrics.rds"))
FAO.regions <- readRDS(here("objects/Geodata/FAO_polygons.rds"))
FAO.focus <- "27.4"
```
We illustrate the use of Aquamaps to generate data using `r sprintf("%s (*%s*)",this.misc$meta$common.name,this.misc$meta$scientific.name)` as an example. 

The Aquamap for this species looks like so:

```{r fig.cap=paste("Aquamap native distribution map for",this.misc$meta$common.name)}


ggplot(this.amap,aes(Center.Long,Center.Lat,fill=Overall.Probability))+
  geom_raster()+
  annotation_map(map_data("world"),fill="black")+
  coord_quickmap()+
  scale_fill_viridis_c()+
  labs(x="",y="",fill="Probability")
```

The thermal envelope fitted for this species by Aquamaps looks like so.

```{r fig.cap=paste("Thermal preference curve for", this.misc$meta$common.name,"as fitted by Aquamaps. The dashed vertical line indicates the upper-thermal limit applied here.")}
temp.dat <-  tibble(temp=with(this.misc$meta,c(Temp.Min,Temp.Pref.Min..10th.,
                                               Temp.Pref.Max..90th.,Temp.Max)),
                    prob=c(0,1,1,0))
ggplot(temp.dat,aes(temp,prob))+
  geom_line()+
  labs(x="Temperature (deg C)",y="Probability")+
  geom_vline(xintercept=with(this.misc$meta,(Temp.Pref.Max..90th.)),linetype=2)

```

Aquamaps chooses either SST or SBT, depending on the characteristics of the species. 

It is clear that are high temperatures, the probability of a point in space being suitable habitat falls off to zero. In Aquamaps terminology, the point where this starts is the 90th percentile of the distribution, and we use this as the basis for defining the thermal safety margin, TSM, as follows.

$$TSM_i=T_{90^{th}}-T_{i}$$

where $TSM_i$ is the thermal safety margin of pixel *i*, $T_{90^{th}}$ is the 90th percentile and $T_i$ is the temperature at a given pixel.

TODO: Lots of references to the TSM concept

Aquamaps provides the environmental data that underlies its models. We use this data for all analyses to ensure consistency between the thermal envelope parameters and the spatial distribution of temperature used to calculate TSM. We use the habitat distribution from Aquamaps to filter this environmental data to regions where the species of interest is expected to occur. For `r this.misc$meta$common.name`, this looks like so:

```{r fig.cap=paste("Aquamaps temperature for",this.misc$meta$common.name)}
ggplot(this.amap,aes(Center.Long,Center.Lat,fill=this.temp))+
  geom_raster()+
  annotation_map(map_data("world"),fill="black")+
  coord_quickmap()+
  labs(x="",y="",fill="Temp (deg C)")

```


Combining the temperature with the thermal threshold allows us to calculate, and map, the thermal safety margin (TSM) as a function of space

```{r fig.cap=paste("Aquamaps TSM (deg C) for",this.misc$meta$common.name)}
ggplot()+
  geom_raster(data=this.amap,mapping=aes(Center.Long,Center.Lat,fill=TSM))+
  geom_sf(data=FAO.regions,fill=NA)+
  annotation_map(map_data("world"),fill="black")+
  geom_sf_text(data=FAO.regions,aes(label=F_CODE),colour="blue")+
  labs(x="",y="",fill="TSM (deg C)")+
  scale_fill_distiller(palette = "YlOrBr")+
  coord_sf(ylim=c(40,90))
```

In this case, we have also overlayed the FAO regions and labels. Focusing on a particular FAO region (e.g. `r FAO.focus`), we can examine the statistical distributon of the TSM in the pixels that are deemed to be suitable habitat:

```{r fig.cap=paste("Distribution of TSM values for FAO region",FAO.focus," The dashed vertical line indicates the median value.")}
this.FAO.amap <- this.amap %>%
  filter(F_CODE==FAO.focus) 
ggplot(this.FAO.amap,aes(x=TSM))+
  stat_bin()+
  geom_vline(xintercept=median(this.FAO.amap$TSM),linetype=2)
```

The median TSM for this species and area is used as a stock-specific metric of sensitivty to climate change. Stocks with low TSMs are viewed as being senstive, while those with high TSMs are viewed as being insensitive.

Applying this approach across all areas allows us to define a stock-specific TSM:
```{r}
TSM.plt <- right_join(x=FAO.regions,y=this.misc$metrics,by="F_CODE")

ggplot()+
  geom_sf(data=TSM.plt,aes(fill=median.TSM))+
  annotation_map(map_data("world"),fill="black")+
  #geom_sf_text(data=FAO.regions,aes(label=F_CODE),colour="blue")+
  labs(x="",y="",fill="TSM (deg C)")+
  scale_fill_distiller(palette = "YlOrBr")+
  coord_sf(ylim=c(40,90))

```

### Combining metrics

We normalise all metrics on to a scale from 0-1 based on their relative ranks. We then produced a combined biological hazard metric for each stock as follows:

$$ H_{st}= 0.25LS_{sp} + 0.25 HSS_{sp} + 0.5 * TSM_{st} $$
where $H_{st}$ is the stock-specific hazard, $LS_{sp}$ is the lifespan of the species, $HSS_{sp}$ is the habitat-specificity score of the species and $TSM_{st}$ is the stock-specific thermal-safety margin.
