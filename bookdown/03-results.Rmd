# Results

## Geographical coverage

Should probably include a map here of the countries that we have included. Here is a list instead to start with 

```{r}
# Setup ---------------------------------------------------------------------------
library(tidyverse)
library(here)

# Import species database ---------------------------------------------------------
species.db <- readRDS(here("objects/species_database.rds"))
value.sp.geo <- readRDS(here("objects/catch/value.species.country.rds"))

knitr::kable(
  group_by(value.sp.geo,geo) %>%
    summarise(value.of.landings=sum(value)),
  booktabs=TRUE
)
```

I'm not sure what is going wrong with Turkey at the moment.


## Species coverage

```{r}

# Calculate total coverage --------------------------------------------------------
total.value <- sum(value.sp.geo$value)
in.db <- filter(value.sp.geo,species %in% species.db$FAO_3A_code) 
coverage <- sum(in.db$value)/total.value

```

The selected groups included in this analysis cover `r sprintf("%2.1f%%",round(coverage*100,1))` of  the total value of European fisheres landings. This is broken down by country as follows.

```{r}
geo.coverage <- 
  value.sp.geo %>%
  mutate(in.db=species %in% species.db$FAO_3A_code) %>%
  group_by(geo,in.db) %>%
  summarise(total=sum(value)) %>%
  spread(.data$in.db,total) %>%
  mutate(prop=.data$"TRUE"/(.data$"TRUE"+.data$"FALSE")) 

ggplot(geo.coverage,aes(geo,prop))+
  geom_bar(stat="identity")+
  labs(x="Country",y="Proportion of landings by value")+
  coord_cartesian(ylim=c(0,1),expand=FALSE)

```

Looking at the distribution of coverage

```{r}
ggplot(geo.coverage,aes(x=prop))+
  stat_ecdf()+
  geom_rug()+
  labs(x="Proportion of landings by value",y="Proportion of countries")+
  coord_cartesian(xlim=c(0.75,1.0),ylim=c(0,1),expand=FALSE)

min.prop <- 0.90
prop.countries <- ecdf(geo.coverage$prop)(min.prop)
```

We can see that `r sprintf("%2.0f%%", round((1-prop.countries)*100))` of countries  have at least `r sprintf("%2.0f%%",round(min.prop*100))` coverage and all countries have at least `r sprintf("%2.0f%%",floor(min(geo.coverage$prop,na.rm=TRUE)*100))` coverage.


## Biological Adaptive Capacity

```{r}
# Import trait database -----------------------------------------------------------
traits.db <- readRDS(here("objects/trait_database.rds"))

```

Some summary statistics overviewing the distribution of adaptive capacity scores

```{r}
ggplot(traits.db,aes(x=lifespan.score))+
  stat_count()+
  labs(x="Lifespan score",y="Frequency")
  
```

```{r}
ggplot(traits.db,aes(x=habitat.score))+
  stat_count()+
  labs(x="Habitat score",y="Frequency")
```

## Biological exposure and sensitivity

We define exposure and sensitivty of the organisms based on two metrics derived from our analyses of Aquamaps. Exposure is defined as the warming rate (degrees C per year), while sensitivity is defined as the thermal safety margin (TSM).  We can also calculate these metrics at two different biological resolutions. Firstly, on a stock level (ie. species for a given FAO area). Removing minor stocks from the dataset, we get the following plot. Species / stocks below the line are less of a worry, as they are cooling. 

```{r}
stock.sens.exp <- readRDS(here("objects/biological_metrics/stock_exp_sens.rds")) %>%
  filter(!(is.na(sensitivity) | is.na(exposure))) %>% #Remove NAs
  filter(prop.value.in.F_CODE>0.05)

ggplot(stock.sens.exp,aes(sensitivity,exposure))+
  geom_point() +
  labs(x="Sensitivity (Median Thermal Safety Margin, deg C)",
       y="Exposure (Median warming rate, deg C /yr)")+
  geom_hline(yintercept=0)

```

The most problematic stocks here are those at top-left (high warming rates, low thermal safety margins).

Secondly, we can look at this  on a species level, where the total species score is produced by weighting the stock scores by the value of landings in each area.

```{r}
sp.sens.exp <- readRDS(here("objects/biological_metrics/species_exp_sens.rds"))

ggplot(sp.sens.exp)+
  geom_text(aes(sensitivity,exposure,label=FAO_3A_code))+
  geom_hline(yintercept=0)+
  labs(x="Sensitivity (Thermal Safety Margin, deg C)",
       y="Exposure (Warming rate, deg C /yr)")

```

