---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Results

## Coverage

### Geographical coverage

Should probably include a map here of the countries that we have included. Here is a list instead to start with 

```{r}
# Setup ---------------------------------------------------------------------------
library(tidyverse)
library(here)
library(sf)

# Import data ---------------------------------------------------------------------
stock.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
value.sp.geo.in <- readRDS(here("objects/EUROSTAT/value.species.country.rds"))

bg.map <- 
  list(annotation_map(map_data("world"),fill="grey",colour="darkgrey"),
       scale_fill_viridis_c())
  

# Calculate proportion of landings & landings value covered ----------------------------------------
prop.catch.covered  <- 
  stock.haz %>%
  mutate(missing.haz=is.na(hazard)) %>%
  group_by(FAO_3A_code,missing.haz) %>%
  summarise(prop.sp.covered=sum(st.prop)) %>%
  filter(!missing.haz)

#Merge into value.sp.geo
value.sp.geo <-
  value.sp.geo.in %>%
  rename(FAO_3A_code=species) %>%
  left_join(y=prop.catch.covered,by="FAO_3A_code") %>%
  mutate(prop.sp.covered=ifelse(is.na(prop.sp.covered),0,prop.sp.covered),
         covered.value=value*prop.sp.covered) %>%
  rename(full.value=value)

# Calculate total coverage --------------------------------------------------------
total.value <- sum(value.sp.geo$full.value)
coverage <- sum(value.sp.geo$covered.value)/total.value

```

The selected groups included in this analysis cover `r sprintf("%2.1f%%",round(coverage*100,1))` of  the total value of European fisheres landings. This is broken down by country as follows.

```{r}
geo.coverage <- 
  value.sp.geo %>%
  group_by(geo) %>%
  summarise(total.covered=sum(covered.value),
            total=sum(full.value)) %>%
  mutate(prop=total.covered/total) 

ggplot(geo.coverage,aes(geo,prop))+
  geom_bar(stat="identity")+
  labs(x="Country",y="Proportion of landings by value")+
  coord_cartesian(ylim=c(0,1),expand=FALSE)

min.prop <- 0.90
prop.countries <- ecdf(geo.coverage$prop)(min.prop)

```

We can see that `r sprintf("%2.0f%%", round((1-prop.countries)*100))` of countries  have at least `r sprintf("%2.0f%%",round(min.prop*100))` coverage and all countries have at least `r sprintf("%2.0f%%",floor(min(geo.coverage$prop,na.rm=TRUE)*100))` coverage. 

Basically the Black Sea countries seem to be missing some important species. The Romanian fishery data is dominated by veing rapa whelk (*Rapana venosa* FAO Code RPW), while the Bulgarian data is dominated by sea snails (*Rapana spp* FAO Code RPW). The Aquamap that we are using for these two species appears to be the incorrect one, centered on Japan.

### Fleet Coverage

```{r}
flt.risk <- readRDS(here("objects/fleet_metrics/Fleet_risk.rds"))

```
We should also check the coverage by fleet segment. We are able to do the full analysis for `r nrow(flt.risk)` fleet segments, although the coverage of some of these units can be pretty poor.
```{r}
ggplot(flt.risk,aes(x=1-prop.missing))+
  stat_ecdf()+
  labs(x="Proportion of landings value covered",
       y="Cumulative proportion of fleet segments")+
  scale_x_reverse()
```

Nevertheless, we still cover 75% or more of the landings value for more than 70% of fleets. We should probably filter this at some point to focus on the most important and/or best covered fleets.

## Biological metrics


### Species-specific metrics

```{r}
sp.metrics <- readRDS(here("objects/biological_metrics/species_metrics.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))

ggplot(sp.metrics,aes(x=lifespan.score))+
  stat_count()+
  labs(x="Lifespan score",y="Frequency")
  
```

```{r}
ggplot(sp.metrics,aes(x=habitat.score))+
  stat_count()+
  labs(x="Habitat score",y="Frequency")
```

As a cross check that we have implemented the coversion from these metrics to a hazard, we plot one against the other, to ensure that the trend is as intended

```{r}
ggplot(stk.haz,aes(x=lifespan.score,y=hazard,group=lifespan.score)) +
  geom_boxplot()

```
 
So, longer-lived species have a higher hazard score. Tick.
 
```{r}
ggplot(stk.haz,aes(x=habitat.score,y=hazard,group=habitat.score))+
  geom_boxplot()
```

So species with a higher habitat-specificity have a higher hazard. Tick.

### Stock-specific metrics

Small stocks are a potential problem in this analysis. We first check the distribution of stock sizes (expressed as value of landings) relative to the total size (value) of the species.

```{r}
filt.stock.haz <- 
  stock.haz %>%
  filter(!is.na(hazard))

ggplot(filt.stock.haz,aes(x=st.prop)) +
  stat_ecdf()+
  labs(x="Proportion of the species total in the stock, by value",
       y="Cumulative proportion of stocks")+
  scale_x_log10()
```

We can therefore see that there are an awful lot of stocks that don't contribute much landigns value - is is a natural consequence of the way that we have defined a stock in this case. We choose to filter out all stocks that have a landings value less than 5% of the species total.

```{r}
filt.stock.haz <- filt.stock.haz %>%
  filter(st.prop>0.05)

```

This leaves us with `r nrow(filt.stock.haz)` stocks. Looking at the distribution of TSM's of these remaining stocks.

```{r}
ggplot(filt.stock.haz,aes(x=median.TSM))+
  stat_bin()+
  labs(x="Stock TSM (deg C)",y="Frequency")
```

And cross checking the hazard implementation.

```{r}
ggplot(filt.stock.haz,aes(x=median.TSM,y=hazard))+
  geom_point()
```

Low TSMs => higher hazards. Tick. The stripping rises due to the categorical natural of the other metrics.

### Species-level hazard

We can look at our biological analysis by integrating the hazard back up to the species level by weighting by the value of landings of each stock. 

```{r}
sp.hazard <- readRDS(here("objects/biological_metrics/species_hazard.rds"))

ggplot(sp.hazard,aes(x=hazard))+
  stat_bin()


```

Looking at the top and bottom ten species

```{r}

firstNlast <- function(x,n=10) {
  bind_rows(head(x,n=n),tail(x,n=10))
}

knitr::kable(
  sp.hazard %>%
    mutate(rank=rank(-hazard)) %>%
  arrange(rank) %>%
  firstNlast()
)
```

## Fleet metrics

### Fleet hazard metrics

Fleets with the top and bottom 10 hazard scores

```{r}
fleet.haz <- 
  readRDS(here("objects/fleet_metrics/Fleet_hazard.rds")) %>%
  arrange(hazard)
n <- 10

knitr::kable(
  bind_rows(head(fleet.haz,n),tail(fleet.haz,n)),
  caption="Top and botton 10 fleets by hazard "
  
)
```

```{r fig.cap="Distribution of hazard metrics"}
ggplot(fleet.haz,aes(x=hazard))+
  stat_bin()+
  labs(x="Fleetwise Hazard score",y="Frequency")

```

### Fleet exposure metrics

We use the Shannon diversity and the Simpson Dominance metrics to characterise the diversity of species that a fishing fleet catching. The distribution of these metrics is as follows. 

```{r fig.cap="Fleetwsie Shannon Diversity index" }
# Import fleet data -----------------------------------------------------------
fleet.exp <- readRDS(here("objects/fleet_metrics/Fleet_exposure.rds")) 

ggplot(fleet.exp,aes(x=shannon.H))+
  stat_bin()+
  labs(x="Fleet Shannon Diversity index",y="Frequency")
```

```{r, fig.cap="Fleetwise Simpson Dominance"}
ggplot(fleet.exp,aes(x=simpsons.D))+
  stat_bin()+
  labs(x="Fleet Simpson Dominance index",y="Frequency")

```

A correlation between these two metrics is expected.

```{r fig.cap="Relationship between Shannon Diversity H’ and Simpson’s Dominance D of fishery landings, for EU fleet segments in 2016"}
# Plot ----------------------------------------------------------------------------
ggplot(fleet.exp,aes(shannon.H,simpsons.D))+
  geom_point()+
  labs(x="Shannon diversity",y="Simpson's dominance (D)")

```

 Clearly there is a strong relationship between Shannon diversity  of fishery landings and Simpson’s dominance (D), although this is not linear (figure 1).
 
We combine the two metrics together into a into exposure metrics. Checking that we have done this correctly:

```{r fig.cap="Exposure vs Shannon Index"}
ggplot(fleet.exp,aes(x=shannon.H,y=exposure))+
  geom_point()+
  labs(x="Fleetwise Shannon Diversity index",y="Fleetwise exposure")

```

So fleets with higher diversity have lower exposure. Tick.

```{r, fig.cap="Exposure vs Simpsons Dominance"}
ggplot(fleet.exp,aes(x=simpsons.D,y=exposure))+
  geom_point()+
  labs(x="Fleetwise Simpsons Dominance",y="Fleetwise exposure")

```

So, fleets that are dominated by a few species have a higher exposure, which is what we want.

Ploitting the list of fleet diversity.

Least diverse fleets
```{r}
knitr::kable(
  arrange(fleet.exp,shannon.H) %>% head,
  caption="Least diverse fleets",
  booktabs=TRUE
)

```

Most diverse fleets

```{r }
knitr::kable(
  arrange(fleet.exp,shannon.H) %>% tail,
  caption="Most diverse fleets",
  booktabs=TRUE
)
```

Catch diversity in 2016 ranged from zero (where a fleet caught a single resource) to 4.19, where a multitude of different fish and shellfish species were targeted. The lowest diversity of catches was observed for the fleet segments IRL-A27-DRB2440, MLT-A37-PS2440 and PRT-A37-FPO2440, fishing exclusively on Great Atlantic scallop (*Pecten maximus*), Chub mackerel  (*Scomber colias*) and Striped soldier shrimp (*Plesionika edwardsii*) respectively. By contrast, the highest diversity of landings was observed for ESP-A37-DTS1824, with catch records for 746 different species.

### Fleet vulnerability metrics

Visualisation of the distribution of metrics
```{r fig.cap="Employment per vessel"}
flt.vul <- readRDS(here("objects/fleet_metrics/Fleet_vulnerability.rds"))

ggplot(flt.vul,aes(x=Employment.per.vessel))+
  stat_bin()

```
This is a potentially problematic metric, in retrospect, as it is really a metric of vessel size...

QUESTION: Should we retain it? How should we normalise it if we keep it?

```{r fig.cap="Value of landings"}
ggplot(flt.vul,aes(x=Value.of.landings.per.vessel))+
  stat_bin()

```

Hmmm. Similar problem.

```{r,fig.cap="Average wage per FTE"}
ggplot(flt.vul,aes(x=Average.wage.per.FTE))+
  stat_bin()
```

Looks like a couple of outliers there that need to be polished up...

```{r fig.cap="Net profit margin"}
ggplot(flt.vul,aes(x=Net.profit.margin))+
  stat_bin()+
    labs(x="Net profit margin (%)")
```

Hmmm. A rather biased distribution. Lets crunch this figure down a bit...

```{r fig.cap="Net profit margin 2"}
ggplot(flt.vul,aes(x=Net.profit.margin))+
  stat_bin()+
  xlim(c(-100,100))+
  labs(x="Net profit margin (%)")
```

Outliers aside, this is not a bad distribution. 

QUESTION: Shall we rescale it to +/-100, and trim the rest...?

```{r fig.cap="Vulnerability distribution"}
ggplot(flt.vul,aes(x=vulnerability))+
  stat_bin()

```

This doesn't look so bad, but at the same time the outliers probably don't help things, and should be fixed.

Checking the correlations with the metrics against vulnerability
```{r fig.cap="Correlation check"}
vul.cor <- 
  flt.vul %>%
  gather("variable","value",-fs_name,-vulnerability)

ggplot(vul.cor,aes(x=value,y=vulnerability))+
  facet_wrap(~variable,scales="free_x")+
  geom_point()
```

Which highlights the problems quite nicely... There is also some issues here with the directionality that we need to fix.

I think we probably need to rethink these metrics. Net profit margin is a very useful metric, but I'm not so sure about the others, particularly as they scale with vessel size, which I'm not sure we realy want...

### Fleet risk

Note that the results here are a bit meaningless until we get the vulnerability under control, but the visualisations will be the same, so we can look at and discuss how we want to approach these.

Firstly, the top and bottom 10

```{r}
flt.risk <- 
  readRDS(here("objects/fleet_metrics/Fleet_risk.rds")) %>%
  arrange(risk) 

knitr::kable(
  bind_rows(head(flt.risk,n=10),tail(flt.risk,n=10)),
  caption="Top and bottom 10 fleets by risk",
  digits=3)


```

Now, viewing by vessel size

```{r, fig.cap=""}
plt.dat <-
  flt.risk %>%
  tidyr::extract(fs_name,
          into=c("country","area","gear","length","geo"),
          "^(.+?) (.+?) ([:alpha:]{1,3})([:alnum:]{4}) *(.*)$",
          remove=FALSE) %>%
  mutate(area=replace(area,area=="A37","FAO Area 37"),
         area=replace(area,area=="A27","FAO Area 27"),
         area=replace(area,area=="OFR","Other Fishing Regions"))
  

ggplot(plt.dat,aes(x=length,y=risk,group=length))+
  stat_boxplot()+
  labs(x="Vessel length range",y="Climate risk")

```

By country and fishing area. 

QUESTION: I'm not quite sure how whether to retain the other fishing region fleets, or just keep it to the FAO27 and FAO37 areas - we don't have very much biological information outside these regions.

QUESTION: I can also plot this as a map, based on the median value...

```{r, fig.cap=""}
ggplot(plt.dat,aes(x=country,y=risk))+
  facet_wrap(~area,ncol=1)+
  stat_boxplot()+
  labs(x="Country",y="Climate risk")
```

```{r fig.cap="Fleetwise climate risk for the 23 EU coastal nations"}
cty.sf <- readRDS(here("objects/Geodata/nation_regions.rds"))

#Country risk
geo.plt.dat <- 
  plt.dat %>%
  group_by(country) %>%
  summarise(median.risk=median(risk,na.rm=TRUE)) %>%
  right_join(x=cty.sf,by=c("country_code"="country")) 

ggplot(geo.plt.dat)+
  bg.map+
  geom_sf(aes(fill=median.risk))+
  coord_sf(xlim=c(-20,40),ylim=c(30,70))+
  labs(fill="Risk")
```

TODO: Ireland needs to be investigated - it looks like it is missing some of the flet economic data => no vul => no risk.

TODO: I will separate France and Spain into Atlantic and Mediterranean fleets as well on this map

And by gear. Looks like quite some variability here.

```{r, fig.cap=""}
ggplot(plt.dat,aes(x=gear,y=risk))+
  stat_boxplot()+
  labs(x="Fishing technology",y="Climate risk")
```

A table of gear types, sorted by median risk.

```{r}
#Import gear code table
fishtech.codes <- 
  read_csv(here("data/STECF_Fleet_data/fishing_technology_codes.csv"))

plt.dat %>%
  group_by(gear) %>%
  summarise(median.risk=median(risk,na.rm=TRUE)) %>%
  left_join(y=fishtech.codes,by=c(gear="fishing_tech"))%>%
  arrange(-median.risk) %>%
  select(`Code`=gear,Description=description,Risk=median.risk)%>%
  knitr::kable(digits=3)
```


## Regional Metrics

### Regional hazard

```{r}
#Import data
reg.hazard <- readRDS(here("objects/regional_metrics/regional_hazard.rds"))
reg.poly <- readRDS(here("objects/Geodata/region.polys.rds"))

#Merge
left_join(reg.poly,reg.hazard,by="region") %>%
  ggplot()+
  bg.map+
  geom_sf(aes(fill=hazard))+
  labs(fill="Hazard\nscore")

```


### Regional exposure

Similar relationships between the catch dominance and catch diversity are seen at the regional levels as are seen for the fleets.

```{r}
#Import data
reg.exp <- readRDS(here("objects/regional_metrics/regional_exposure.rds"))

ggplot(reg.exp,aes(shannon.H,simpsons.D))+
  geom_point()+
  labs(x="Shannon Diversity (H)",y="Simpson's Dominance (D)")


```

Plotting the exposure (diversity) geographically

```{r}
#Plot
right_join(reg.poly,reg.exp,by="region") %>%
ggplot()+
  bg.map+
  geom_sf(aes(fill=shannon.H))+
  labs(fill="Shannon H")

```

Note the clear north-south gradient here. Several countries are still missing from this analysis, as we don't have data resolved by NUTS regions for them (e.g. Norway, Finland, parts of Sweden, SE Europe). We need to find a strategy how to deal with this.

### Regional vulnerability

Currently this is only based on GDP per capita. Other metrics can be added.

```{r}
#Import NUTS vulnerability metrics
NUTS.vul <- 
  readRDS(here("objects/regional_metrics/regional_vulnerability.rds")) %>%
  right_join(x=NUTS.regions,by=c("NUTS_ID"))

ggplot(NUTS.vul)+
  annotation_map(map_data("world"),fill="grey")+
  geom_sf(aes(fill=gdp.percap),col=NA)+
  scale_fill_viridis_c()+
  labs(fill="GDP per capita")+
  coord_sf(xlim=c(-20,30),ylim=c(30,70))
```

Can anyone spot the City of London?

### Regional risk



