---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Results

## Coverage

### Geographical coverage

Should probably include a map here of the countries that we have included. Here is a list instead to start with 

```{r}
# Setup ---------------------------------------------------------------------------
library(tidyverse)
library(here)

# Import data ---------------------------------------------------------------------
stock.mets <- readRDS(here("objects/biological_metrics/stock_exp_sens.rds"))
value.sp.geo.in <- readRDS(here("objects/catch/value.species.country.rds"))

# Calculate proportion of landings & landings value covered ----------------------------------------
prop.catch.covered  <- 
  stock.mets %>%
  mutate(missing.exp.sens=is.na(sensitivity)| is.na(exposure)) %>%
  group_by(FAO_3A_code,missing.exp.sens) %>%
  summarise(prop.sp.catch=sum(prop.sp.catch)) %>%
  filter(!missing.exp.sens)

#Merge into value.sp.geo
value.sp.geo <-
  value.sp.geo.in %>%
  rename(FAO_3A_code=species) %>%
  left_join(y=prop.catch.covered,by="FAO_3A_code") %>%
  mutate(prop.sp.catch=ifelse(is.na(prop.sp.catch),0,prop.sp.catch),
         covered.value=value*prop.sp.catch) %>%
  rename(full.value=value)


knitr::kable(
  group_by(value.sp.geo,geo) %>%
    summarise(value.of.landings=sum(full.value))%>%
    arrange(value.of.landings),
  booktabs=TRUE
)
```

I'm not sure what is going wrong with Turkey at the moment.


### Species coverage

```{r}

# Calculate total coverage --------------------------------------------------------
total.value <- sum(value.sp.geo$full.value)
coverage <- sum(value.sp.geo$covered.value)/total.value

```

The selected groups included in this analysis cover `r sprintf("%2.1f%%",round(coverage*100,1))` of  the total value of European fisheres landings. This is broken down by country as follows.

```{r}
geo.coverage <- 
  value.sp.geo %>%
  group_by(geo) %>%
  summarise(total.covered=sum(covered.value),
            total=sum(full.value)) %>%
  mutate(prop=total.covered/total) 

ggplot(geo.coverage,aes(geo,prop))+
  geom_bar(stat="identity")+
  labs(x="Country",y="Proportion of landings by value")+
  coord_cartesian(ylim=c(0,1),expand=FALSE)

```

Looking at the distribution of coverage

```{r}
ggplot(geo.coverage,aes(x=prop))+
  stat_ecdf()+
  geom_rug()+
  labs(x="Proportion of landings by value",y="Proportion of countries")+
  coord_cartesian(xlim=c(0,1.0),ylim=c(0,1),expand=FALSE)

min.prop <- 0.90
prop.countries <- ecdf(geo.coverage$prop)(min.prop)
```

We can see that `r sprintf("%2.0f%%", round((1-prop.countries)*100))` of countries  have at least `r sprintf("%2.0f%%",round(min.prop*100))` coverage and all countries have at least `r sprintf("%2.0f%%",floor(min(geo.coverage$prop,na.rm=TRUE)*100))` coverage. 

Basically the Black Sea countries seem to be missing some important species. The Romanian fishery data is dominated by veing rapa whelk (*Rapana venosa* FAO Code RPW), while the Bulgarian data is dominated by sea snails (*Rapana spp* FAO Code RPW). The Aquamap that we are using for these two species appears to be the incorrect one, centered on Japan.


## Biological metrics


### Biological Adaptive Capacity

```{r}
# Import trait database -----------------------------------------------------------
traits.db <- readRDS(here("objects/trait_database.rds"))

```

Some summary statistics overviewing the distribution of adaptive capacity scores

```{r}
ggplot(traits.db,aes(x=lifespan.score))+
  stat_count()+
  labs(x="Lifespan score",y="Frequency")
  
```

```{r}
ggplot(traits.db,aes(x=habitat.score))+
  stat_count()+
  labs(x="Habitat score",y="Frequency")
```

### Biological exposure and sensitivity

We define exposure and sensitivty of the organisms based on two metrics derived from our analyses of Aquamaps. Exposure is defined as the warming rate (degrees C per year), while sensitivity is defined as the thermal safety margin (TSM).  We can also calculate these metrics at two different biological resolutions. Firstly, on a stock level (ie. species for a given FAO area). Removing minor stocks from the dataset, we get the following plot. Species / stocks below the line are less of a worry, as they are cooling. 

```{r}
stock.sens.exp <- readRDS(here("objects/biological_metrics/stock_exp_sens.rds")) %>%
  filter(!(is.na(sensitivity) | is.na(exposure))) %>% #Remove NAs
  filter(prop.sp.catch>0.05)

ggplot(stock.sens.exp,aes(sensitivity,exposure))+
  geom_point() +
  labs(x="Sensitivity (Median Thermal Safety Margin, deg C)",
       y="Exposure (Median warming rate, deg C /yr)")+
  geom_hline(yintercept=0)

```

The most problematic stocks here are those at top-left (high warming rates, low thermal safety margins).

Secondly, we can look at this  on a species level, where the total species score is produced by weighting the stock scores by the value of landings in each area.

```{r}
sp.sens.exp <- readRDS(here("objects/biological_metrics/species_exp_sens.rds"))

ggplot(sp.sens.exp)+
  geom_text(aes(sensitivity,exposure,label=FAO_3A_code))+
  geom_hline(yintercept=0)+
  labs(x="Sensitivity (Thermal Safety Margin, deg C)",
       y="Exposure (Warming rate, deg C /yr)")

```

## Fleet metrics

I am able to reproduce John's results perfectly. John writes:

Clearly there is a strong relationship between Shannon diversity (H’) of fishery landings and Simpson’s dominance (D), although this is not linear (figure 1).Catch diversity in 2016 ranged from zero (where a fleet caught a single resource) to 4.19, where a multitude of different fish and shellfish species were targeted. The lowest diversity of catches was observed for the fleet segments IRL-A27-DRB2440, MLT-A37-PS2440and PRT-A37-FPO2440, fishing exclusively on Great Atlantic scallopPecten maximus, Chub mackerelScomber coliasand Striped soldier shrimpPlesionika edwardsiirespectively. By contrast, the highest diversity of landings was observed for ESP-A37-DTS1824, with catch records for 746different species

```{r fig.cap="Relationship between Shannon Diversity H’ and Simpson’s Dominance D of fishery landings, for EU fleet segments in 2016"}
# Import fleet data -----------------------------------------------------------
fleet.exp <- readRDS(here("objects/fleet_metrics/STECF.fleet_exposure.rds")) %>%
  select(-sum.prop,-sum.value)

# Plot ----------------------------------------------------------------------------
ggplot(fleet.exp,aes(shannon.H,simpsons.D))+
  geom_point()+
  labs(x="Shannon diversity (H')",y="Simpson's dominance (D)")

```

Least diverse fleets
```{r}
knitr::kable(
  arrange(fleet.exp,shannon.H) %>% head,
  booktabs=TRUE
)

```

Most diverse fleets

```{r}
knitr::kable(
  arrange(fleet.exp,-shannon.H) %>% head,
  booktabs=TRUE
)
```

```

