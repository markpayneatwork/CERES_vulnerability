---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Results

## Coverage

### Geographical coverage

Should probably include a map here of the countries that we have included. Here is a list instead to start with 

```{r}
# Setup ---------------------------------------------------------------------------
library(tidyverse)
library(here)
library(sf)

# Import data ---------------------------------------------------------------------
stock.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
value.sp.geo.in <- readRDS(here("objects/catch/value.species.country.rds"))

# Calculate proportion of landings & landings value covered ----------------------------------------
prop.catch.covered  <- 
  stock.haz %>%
  mutate(missing.haz=is.na(hazard)) %>%
  group_by(FAO_3A_code,missing.haz) %>%
  summarise(prop.sp.covered=sum(st.prop)) %>%
  filter(!missing.haz)

#Merge into value.sp.geo
value.sp.geo <-
  value.sp.geo.in %>%
  rename(FAO_3A_code=species) %>%
  left_join(y=prop.catch.covered,by="FAO_3A_code") %>%
  mutate(prop.sp.covered=ifelse(is.na(prop.sp.covered),0,prop.sp.covered),
         covered.value=value*prop.sp.covered) %>%
  rename(full.value=value)

# Calculate total coverage --------------------------------------------------------
total.value <- sum(value.sp.geo$full.value)
coverage <- sum(value.sp.geo$covered.value)/total.value

```

The selected groups included in this analysis cover `r sprintf("%2.1f%%",round(coverage*100,1))` of  the total value of European fisheres landings. This is broken down by country as follows.

```{r}
geo.coverage <- 
  value.sp.geo %>%
  group_by(geo) %>%
  summarise(total.covered=sum(covered.value),
            total=sum(full.value)) %>%
  mutate(prop=total.covered/total) 

ggplot(geo.coverage,aes(geo,prop))+
  geom_bar(stat="identity")+
  labs(x="Country",y="Proportion of landings by value")+
  coord_cartesian(ylim=c(0,1),expand=FALSE)

min.prop <- 0.90
prop.countries <- ecdf(geo.coverage$prop)(min.prop)

```

We can see that `r sprintf("%2.0f%%", round((1-prop.countries)*100))` of countries  have at least `r sprintf("%2.0f%%",round(min.prop*100))` coverage and all countries have at least `r sprintf("%2.0f%%",floor(min(geo.coverage$prop,na.rm=TRUE)*100))` coverage. 

Basically the Black Sea countries seem to be missing some important species. The Romanian fishery data is dominated by veing rapa whelk (*Rapana venosa* FAO Code RPW), while the Bulgarian data is dominated by sea snails (*Rapana spp* FAO Code RPW). The Aquamap that we are using for these two species appears to be the incorrect one, centered on Japan.

### Fleet Coverage

```{r}
flt.risk <- readRDS(here("objects/fleet_metrics/Fleet_risk.rds"))

```
We should also check the coverage by fleet segment. We are able to do the full analysis for `r nrow(flt.risk)` fleet segments, although the coverage of some of these units can be pretty poor.
```{r}
ggplot(flt.risk,aes(x=1-prop.missing))+
  stat_ecdf()+
  labs(x="Proportion of landings value covered",
       y="Cumulative proportion of fleet segments")+
  scale_x_reverse()
```

Nevertheless, we still cover 75% or more of the landings value for more than 70% of fleets. We should probably filter this at some point to focus on the most important and/or best covered fleets.

## Biological metrics


### Species-specific metrics

```{r}
sp.metrics <- readRDS(here("objects/biological_metrics/species_metrics.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))

ggplot(sp.metrics,aes(x=lifespan.score))+
  stat_count()+
  labs(x="Lifespan score",y="Frequency")
  
```

```{r}
ggplot(sp.metrics,aes(x=habitat.score))+
  stat_count()+
  labs(x="Habitat score",y="Frequency")
```

As a cross check that we have implemented the coversion from these metrics to a hazard, we plot one against the other, to ensure that the trend is as intended

```{r}
ggplot(stk.haz,aes(x=lifespan.score,y=hazard,group=lifespan.score)) +
  geom_boxplot()

```
 
So, longer-lived species have a higher hazard score. Tick.
 
```{r}
ggplot(stk.haz,aes(x=habitat.score,y=hazard,group=habitat.score))+
  geom_boxplot()
```

So species with a higher habitat-specificity have a higher hazard. Tick.

### Stock-specific metrics

Small stocks are a potential problem in this analysis. We first check the distribution of stock sizes (expressed as value of landings) relative to the total size (value) of the species.

```{r}
filt.stock.haz <- 
  stock.haz %>%
  filter(!is.na(hazard))

ggplot(filt.stock.haz,aes(x=st.prop)) +
  stat_ecdf()+
  labs(x="Proportion of the species total in the stock, by value",
       y="Cumulative proportion of stocks")+
  scale_x_log10()
```

We can therefore see that there are an awful lot of stocks that don't contribute much landigns value - is is a natural consequence of the way that we have defined a stock in this case. We choose to filter out all stocks that have a landings value less than 5% of the species total.

```{r}
filt.stock.haz <- filt.stock.haz %>%
  filter(st.prop>0.05)

```

This leaves us with `r nrow(filt.stock.haz)` stocks. Looking at the distribution of TSM's of these remaining stocks.

```{r}
ggplot(filt.stock.haz,aes(x=median.TSM))+
  stat_bin()+
  labs(x="Stock TSM (deg C)",y="Frequency")
```

And cross checking the hazard implementation.

```{r}
ggplot(filt.stock.haz,aes(x=median.TSM,y=hazard))+
  geom_point()
```

Low TSMs => higher hazards. Tick. The stripping rises due to the categorical natural of the other metrics.

### Species-level hazard

We can look at our biological analysis by integrating the hazard back up to the species level by weighting by the value of landings of each stock. 

```{r}
sp.hazard <- readRDS(here("objects/biological_metrics/species_hazard.rds"))

ggplot(sp.hazard,aes(x=hazard))+
  stat_bin()


```

Looking at the top and bottom ten species

```{r}

firstNlast <- function(x,n=10) {
  bind_rows(head(x,n=n),tail(x,n=10))
}

knitr::kable(
  sp.hazard %>%
    mutate(rank=rank(-hazard)) %>%
  arrange(rank) %>%
  firstNlast()
)
```

## Fleet metrics

### Fleet catch diversity

I am able to reproduce John's results perfectly. John writes:

Clearly there is a strong relationship between Shannon diversity (H’) of fishery landings and Simpson’s dominance (D), although this is not linear (figure 1).Catch diversity in 2016 ranged from zero (where a fleet caught a single resource) to 4.19, where a multitude of different fish and shellfish species were targeted. The lowest diversity of catches was observed for the fleet segments IRL-A27-DRB2440, MLT-A37-PS2440and PRT-A37-FPO2440, fishing exclusively on Great Atlantic scallopPecten maximus, Chub mackerelScomber coliasand Striped soldier shrimpPlesionika edwardsiirespectively. By contrast, the highest diversity of landings was observed for ESP-A37-DTS1824, with catch records for 746different species

```{r fig.cap="Relationship between Shannon Diversity H’ and Simpson’s Dominance D of fishery landings, for EU fleet segments in 2016"}
# Import fleet data -----------------------------------------------------------
fleet.exp <- readRDS(here("objects/fleet_metrics/Fleet_exposure.rds")) %>%
  select(-sum.prop,-sum.value)

# Plot ----------------------------------------------------------------------------
ggplot(fleet.exp,aes(shannon.H,simpsons.D))+
  geom_point()+
  labs(x="Shannon diversity (H')",y="Simpson's dominance (D)")

```

Least diverse fleets
```{r}
knitr::kable(
  arrange(fleet.exp,shannon.H) %>% head,
  booktabs=TRUE
)

```

Most diverse fleets

```{r}
knitr::kable(
  arrange(fleet.exp,-shannon.H) %>% head,
  booktabs=TRUE
)
```

## Regional Metrics

### Regional Catch Diversity

Similar relationships between the catch dominance and catch diversity are seen at the NUTS regional levels as are seen for the fleets.

```{r}
#Import data
NUTS.div <- readRDS(here("objects/regional_metrics/regional_exposure.rds"))
NUTS.regions <- readRDS(here("objects/Geodata/NUTS_regions.rds")) %>%
  select(NUTS_ID,CNTR_CODE,NUTS_NAME)

ggplot(NUTS.div,aes(shannon.H,simpsons.D))+
  geom_point()+
  labs(x="Shannon Diversity (H)",y="Simpson's Dominance (D)")


```

Plotting the diversity geographically

```{r}

#Merge the two
NUTS.div <- right_join(NUTS.regions,NUTS.div,by=c(NUTS_ID="region.ID"))

#Plot
ggplot(NUTS.div)+
  annotation_map(map_data("world"),fill="grey")+
  geom_sf(aes(fill=shannon.H))+
  scale_fill_viridis_c()+
  labs(fill="Shannon H")

```

Note the clear north-south gradient here. Several countries are still missing from this analysis, as we don't have data resolved by NUTS regions for them (e.g. Norway, Finland, parts of Sweden, SE Europe). We need to find a strategy how to deal with this.

### Regional vulnerability

Currently this is only based on GDP per capita. Other metrics can be added.

```{r}
#Import NUTS vulnerability metrics
NUTS.vul <- 
  readRDS(here("objects/regional_metrics/regional_vulnerability.rds")) %>%
  right_join(x=NUTS.regions,by=c("NUTS_ID"))

ggplot(NUTS.vul)+
  annotation_map(map_data("world"),fill="grey")+
  geom_sf(aes(fill=gdp.percap),col=NA)+
  scale_fill_viridis_c()+
  labs(fill="GDP per capita")+
  coord_sf(xlim=c(-20,30),ylim=c(30,70))
```

Can anyone spot the City of London?
