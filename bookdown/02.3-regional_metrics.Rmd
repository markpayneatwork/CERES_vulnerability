## Regional Metrics
```{r echo=FALSE}
#Setup --------------------------------------
library(tidyverse)
library(sf)
library(here)
library(ggrepel)
```

### Regional units

TODO: Desirable to have a higher spatial resolution than national level.

The EU Market Obsevatory for Fisheries and Aquaculture (EUMOFA) provides monthly "First-sale" records on a harbour-by-harbour basis for 16 European countries. We take advantage of this high spatial resolution to examine the climate hazard on a sub-national level, focusing on the NUTS2 regional units where possible. We first excluded Norwegian and Swedish from this analysis, as it was not on the same harbour-level resolution as for the other countries.  We  merged the EUMOFA first-sales data with geographical metadata (the longitude and latitude of each harbour) provided by EUMOFA, and used this spatial context to associate the harbour with the corresponding NUTS2 region. 

For countries not covered by EUMOFA, we generated a comparable database of landings based on the "EUROSTAT landings" dataset. We first aggregated the species resolution in EUROSTAT data from FAO species codes to the "Main commercial species" (MCS) groupings used by EUMOFA, based on correlation keys provided by EUMOFA, to ensure comparability between these data sets. We then associated these landings with the coastal NUTS2 regions in each country. In some cases (e.g. Iceland, Malta, Cyprus) there was only one NUTS2 region: however in other cases (notably Bulgaria) we generated new "regions" based on the union of multiple coastal NUTS2 regions. The new NUTS2 regions selected in each of these cases can be seen below:

```{r}
NUTS.poly <- readRDS(here("objects/Geodata/NUTS_regions.rds"))
NUTS.reg.key <- readRDS(here("objects/Geodata/NUTS.reg.key.rds"))

#Visualise region selection
NUTS.poly %>%
  filter(CNTR_CODE %in% NUTS.reg.key$CNTR_CODE) %>%
  mutate(CNTR_CODE=as.character(CNTR_CODE),
         is.sel=NUTS_ID %in% NUTS.reg.key$NUTS_ID,
         is.sel=factor(is.sel)) %>%
  group_by(CNTR_CODE) %>%
  group_walk(function(x,id) {
    g<- ggplot(x)+
      annotation_map(map_data("world"))+
      geom_sf(aes(fill=is.sel))+
      geom_label_repel(mapping=aes(label=NUTS_ID,colour=is.sel,geometry=geometry),
                       stat="sf_coordinates",
                       min.segment.length = 0,
                       segment.colour="black",
                       size=3)+
      scale_fill_discrete(drop=FALSE)+
      scale_colour_discrete(drop=FALSE)+
      labs(title=sprintf("Country code : %s",id),fill="Selected?",colour="Selected?")
    print(g)
    return(invisible(NULL))
  })
```

The final full set of "regions" for further analysis can be seen below.

```{r}
regions.poly <- readRDS(here("objects/Geodata/region.polys.rds"))

ggplot(regions.poly)+
  annotation_map(map_data("world"),fill="grey")+
  geom_sf(fill="blue")+
  annotation_map(map_data("world"),fill=NA,colour="black")+
  theme_bw()

```


### Regional hazard

Calculating a regional climate-hazard score requires information about the fisheries and landings at this spatial scale. Due the fact that we are basing this risk analysis and our hazard definition on stocks, rather than species,  this implies that we need not just information about the composition of landings in each region, but also the fishing area (FAO Subarea) where these fish were caught. We have two sources of information that approach this level of detail. The EUMOFA catch data gives species composition at the harbour level (which can then be aggregated into NUTS2 regions), but there is no indication where these fish were caught, making it difficult to link up to a stock. Alternatively, the "EUROSTAT catch" data provides catches by species and fishing region, but is only resolved at the national level. 

We therefore need to infer the distribution of stocks making up the landings of that species in that region region. We make the assumption that the landings in each region come from the waters (specifically the FAO subregion) immediately adjacent. For example,  a harbour fronting on to the North Sea will see landings of North Sea cod and herring, rather than Barents Sea cod and Norwegian Sea herring. Matching up the terrestial  regions with the nearest stocks allows the stock composition for each species in a region to be set, and therefore the regional hazard calculated. 

We can test the validity of this assumption using an internal consistency test. The "EUROSTAT catch" database provides the catch per country from each stock. If this assumption is corect, then these per stock catches should in principle match the total landings per species and FAO subarea when summed across all regions. Differences between the two will arise from stocks further away being landed in a region i.e. non adjacent regions, but also from discards, misreporting and general inconsistencies between the EUMOFA and EUROSTAT datasets. 

The results of this internal consistency check are shown in the Supplementary material, and how that there is reasonable correlation (R=0.83) between these two metrics, supporting the validity of our assumption. In the end it may not be all that important because the only thing that varies by region (stock) is the safety margin and that of course is highly correlated in space so it may not matter at the end of the day.


### Regional exposure

 Following the approach applied to the fleet segments, Shannon diversity indices (H) and Simpson's dominance indices (D) were then calculated for each NUTS2 region, and the combined metric used as measures of regional exposure.


### Regional vulnerability

Metrics

### Regional risk

* Combination
* Visualisations