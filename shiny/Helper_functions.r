#'========================================================================
# Shiny_figures
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Code to make figures for use in shiny apps and associated reports.
# All figures are defined as functions, which can then we called from 
# either the Shiny app or report (pdf) generation scripts.
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#  - Manually calculate densities using from, to, extract and plot results
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
#One common setup used to ensure compatability
library(tidyverse)
library(shiny)
library(shinydashboard)
library(sp)
library(sf)
library(scales)
library(mapdata)
library(shinyWidgets)
library(here)
library(RColorBrewer)

#'========================================================================
# Setup ####
#'========================================================================
#Import data
sp.db <- readRDS(here("objects/species_database.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
stk.haz.all <- readRDS(here("objects/biological_metrics/stock_hazard_all.rds"))
val.sp.geo <- readRDS(here("objects/EUROSTAT/value.species.country.rds"))
flt.catch <- readRDS(here("objects/catch/STECF_catch_data.rds"))

#Restrict FAO polygons
FAO.areas <- 
  readRDS(here("objects/Geodata/FAO_polygons.rds")) %>%
  filter(F_AREA %in% c(37,27))

#Import storylines
storylines <- 
  read_csv2(here("shiny/objects/Storylines.csv")) %>%
  mutate(FAO_areas=purrr::map(FAO_areas,~str_split(.x,pattern=", ")[[1]]),
         Species=purrr::map(Species,~str_split(.x,pattern=", ")[[1]]))

#CERES palettes
CERES.div.pal <- c("#006494","#44B4AF","#88D2B1","#CCEDD0","#FFFFFF",
                   "#F6CCF9","#ED88CC","#DF4472","#CC1104")
CERES.seq.pal <- c("#00336D","#005E86","#00919E","#00B69E","#04CC87",
                   "#44DF6E","#8DED88","#DFF9CC")
CERES.qual.pal <- c("#006494","#FEC739","#FF805E","#998450","#FF8B1F","#04CC87")
CERES.qual.pal <- brewer.pal(4,"Dark2")

#Setup fleet risk profiles
ptile <- function(x) {(rank(x)-0.5)/length(x)}
flt.risk <- 
  readRDS(here("objects/fleet_metrics/Fleet_risk.rds")) %>%
  filter(!is.na(risk),
         !is.infinite(risk)) %>%
  mutate(hazard.ptile=ptile(hazard),
         exposure.ptile=ptile(exposure),
         vulnerability.ptile=ptile(vulnerability),
         risk.ptile=ptile(risk)) %>%
  arrange(risk.ptile) #%>%
  # extract(fs_name,
  #         into=c("country","area","gear","size","area2"),
  #         regex="^([[:alpha:]]{3}) ([[:alnum:]]{3}) ([[:alpha:]]{2,3})([[:alnum:]]{4})(.*)$",
  #         remove=FALSE)

#Plot format
cust.theme <-     theme_bw(base_size=16)+
                  theme(panel.grid = element_blank(),
                        panel.border = element_blank(),
                        axis.text.y=element_blank(),
                        axis.ticks.length.y = unit(0,"pt"),
                        axis.line.x.bottom = element_line(),
                        strip.background = element_blank(),
                        strip.text = element_text(hjust=0))

#Add in value of species
val.sp <- 
  val.sp.geo %>%
  group_by(species) %>%
  summarise(value=sum(value))

##Species selection options
sci.names <-
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", Scientific_name,FAO_EN)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe()
FAO.EN.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_EN,Scientific_name)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 
FAO.3A.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_3A_code,FAO_EN)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 


#Select a storyline to work with (debugging)
n.sel <- 1
FAO.areas.sel <- storylines$FAO_areas[[n.sel]]
sp.sel <- storylines$Species[[n.sel]]


#'========================================================================
# Plots ####
#'========================================================================


#' Selected FAO areas --------------------------------------------------------------
#'
#' @param FAO.areas.sel Vector of FAO subarea codes, used to define the spatial areas
#' to include
#'
#' @return GGplot2
#' @export
plt.sel.FAO <- function(FAO.areas.sel) {
  FAO.areas %>%
    mutate(selected = factor(F_CODE %in% FAO.areas.sel,c(FALSE,TRUE))) %>%
    ggplot()+
    geom_sf(aes(fill=selected),colour="black")+
    annotation_map(map_data("worldLores"),fill="black",colour="black")+
    scale_fill_manual(values=c("white",
                               rgb(0.48,0.61,0.78,1)),
                               #rgb(0.149,0.212,0.475,1)),
                      drop=FALSE,guide=FALSE)+
    coord_sf(expand=FALSE)+
#    coord_sf(expand=FALSE,crs=sf::st_crs(3035))+   #Lambert Azimuthal equal area (3035)
    theme_bw()+
    theme(plot.background = element_blank())
}


#' Stock hazard plot -------------------------------------------------------------
#'
#' @param FAO.areas.sel Vector of FAO subarea codes, used to define the spatial areas
#' to include
#' @param sp.sel Vector of FAO 3A codes, used to define the species to include
#'
#' @return GGPlot2 figure
plt.stk.haz <- function(FAO.areas.sel,sp.sel) {

  sel.stks <-
    stk.haz %>%
    mutate(Stocks=FAO_3A_code,
           hazard.ptile=ptile(hazard)) %>%
    filter(FAO_3A_code %in% sp.sel) %>%
           #F_CODE %in% FAO.areas.sel) %>%
    separate(F_CODE,into=c("FAO.area","FAO.subarea"),sep="\\.",remove=FALSE,convert=TRUE) %>%
    mutate(F_CODE_sort=sprintf("%02i.%02i",FAO.area,FAO.subarea),
           F_CODE=factor(F_CODE,levels=gsub("\\.0","\\.",unique(sort(F_CODE_sort)))),
           F_CODE=fct_rev(F_CODE)) %>%
    left_join(y=val.sp,by=c(FAO_3A_code="species")) %>%
    mutate(st.val=value*st.prop/1e6)
    
  #Plot
  # ggplot(sel.stks)+
  #   geom_point(aes(x=hazard.ptile,y=F_CODE,size=st.val,color=FAO_3A_code))+
  #   theme_bw()+
  #   theme(panel.grid = element_blank(),
  #         panel.border = element_blank(),
  #         axis.line.x.bottom = element_line())+
  #   scale_size_area(max_size=20)+
  #   labs(colour="Species",size="Catch value\n(Mil. euros)",
  #        x="Climate risk",y="FAO Subarea")+
  #   scale_x_continuous(breaks=c(0,0.25,0.5,0.75,1),
  #                      labels=c("Lowest","","","","Highest"))+
  #   coord_cartesian(xlim=c(0,1))
  # 
  #Dodge
  ggplot(sel.stks)+
    geom_point(aes(y=hazard.ptile,x=0,size=st.val,color=FAO_3A_code),
               position=position_dodge(width=1))+
    cust.theme+
    scale_size_area(max_size=20)+
    labs(colour="Species",size="Catch value\n(Mil. euros)",
         y="Climate risk",x="")+
    scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1),
                       labels=c("Lowest","","","","Highest"))+
    coord_flip(xlim=c(-1,1),ylim=c(0,1))
  
  
  #Beeswarm
  # ggplot(sel.stks)+
  #   geom_beeswarm(aes(x=hazard.ptile,y=0,size=st.val,color=FAO_3A_code),
  #                 groupOnX = FALSE,
  #                 dodge.width=0.5)+
  #   theme_bw()+
  #   theme(panel.grid = element_blank(),
  #         panel.border = element_blank(),
  #         axis.line.y = element_blank(),
  #         axis.text.y=element_blank(),
  #         axis.line.x.bottom = element_line())+
  #   scale_size_area(max_size=20)+
  #   labs(colour="Species",size="Catch value\n(Mil. euros)",
  #        x="Climate risk")+
  #   scale_x_continuous(breaks=c(0,0.25,0.5,0.75,1),
  #                      labels=c("Lowest","","","","Highest"))+
  #   coord_cartesian(xlim=c(0,1),ylim=c(-1,1))
  
}



# Fleet Risk plot -----------------------------------------------------------------
#'
#' @param FAO.areas.sel Vector of FAO subarea codes, used to define the spatial areas
#' to include
#' @param sp.sel Vector of FAO 3A codes, used to define the species to include
#'
#' @return GGPlot2 figure
plt.flt.risk <- function(FAO.areas.sel,sp.sel) {
  
  #Get fleets that fish in this area on this species
  sel.fleets <- 
    flt.catch %>%
    ungroup() %>%
    filter(F_SUBAREA %in% FAO.areas.sel,
           species_code %in% sp.sel) 
    
  risk.mets <- 
    #Select fleet risk metrics
    flt.risk %>% 
    filter(fs_name %in% sel.fleets$fs_name) %>%
    #Make tidy
    select(fs_name,hazard.ptile,exposure.ptile,vulnerability.ptile,risk.ptile) %>%
    rename("a) Hazard"=hazard.ptile,
           "b) Exposure"=exposure.ptile,
           "c) Vulnerability"=vulnerability.ptile,
           "d) Climate Risk"=risk.ptile) %>%
    gather("metric","value",-fs_name) %>%
    mutate(metric=factor(metric)) %>%
    #Remove empty values
    filter(!is.na(value)) 
  
  #Apply bandwidth filtering manually
  #geom_density cuts off values outside of the range of interest. To get the full
  #coverage we need to do this manually
  risk.dens <- 
    risk.mets %>%
    select(-fs_name) %>%
    group_by(metric) %>%
    nest() %>%
    mutate(dens.obj=purrr::map(data, ~ density(.$value,from=0,to=1,cut=Inf)),
           dens.x=purrr::map(dens.obj,~.$x),
           dens.y=purrr::map(dens.obj,~.$y)) %>%
    select(-data,-dens.obj) %>%
    unnest() %>%
    group_by(metric) %>%
    mutate(dens.y=dens.y/max(dens.y))

  #Make plots
  
  plot.opts <- list(
    cust.theme,
    theme(axis.title = element_blank(),
          axis.line.x = element_line()),
    coord_cartesian(xlim=c(0,1),expand=TRUE,clip="off"),
    scale_x_continuous(breaks=c(0,0.25,0.5,0.75,1),
                       labels=NULL))

  x.lbls <- tibble(x=c(0,1),
                   lbl=c("Lowest","Highest"),
                   hjust=c(0,1),
                   metric="c) Vulnerability")
  
  components.plt <- 
    risk.dens %>%
    filter(metric!="d) Climate Risk") %>%
    ggplot()+
    geom_ribbon(aes(x=dens.x,ymin=0,ymax=dens.y,fill=metric))+
    facet_wrap(~metric,ncol=1)+
    scale_fill_manual(values=CERES.qual.pal[1:3])+
    guides(fill=FALSE)+
    plot.opts+
    geom_text(aes(x=x, y = -Inf, label = lbl,hjust=hjust), data = x.lbls,vjust=2)  

  x.lbls <- tibble(x=c(0,1),
                   lbl=c("Lowest","Highest"),
                   hjust=c(0,1),
                   metric="d) Climate Risk")
  
  risk.plt <- 
    risk.dens %>%
    filter(metric=="d) Climate Risk") %>%
    ggplot()+
    geom_ribbon(aes(x=dens.x,ymin=0,ymax=dens.y,fill=metric))+
    guides(fill=FALSE)+
    facet_wrap(~metric)+
    scale_fill_manual(values=CERES.qual.pal[4])+
    plot.opts +
  geom_text(aes(x=x, y = -Inf, label = lbl,hjust=hjust), data = x.lbls,vjust=2)  

  
  
  ggplot() +
    coord_cartesian(xlim = c(0, 4), ylim = c(0, 1), expand = FALSE) +
    annotation_custom(ggplotGrob(components.plt), 
                    xmin = 0, xmax = 1, 
                    ymin = 0.1, ymax = 1) +
    annotation_custom(ggplotGrob(risk.plt), 
                    xmin = 1, xmax = 4, 
                    ymin = 0.1, ymax = 1) +
    theme_void()
}

#'========================================================================
# Tables and text ####
#'========================================================================
# Selected species table ----------------------------------------------------------
#'
#' @param sp.sel Vector of FAO 3A codes, used to define the species to include
#'
#' @return Table of selected species
tbl.sel.sp <- function(sp.sel) {
  sp.db %>%
    filter(FAO_3A_code %in% sp.sel) %>%
    arrange(FAO_3A_code) %>%
    select("FAO Code"=FAO_3A_code,
           "Common name"=FAO_EN,
           "Scientific name"=Scientific_name) 
}


# Storyline risk text ----------------------------------------------------------
storyline.risk.txt <- function(i) {
  sprintf("Fleets in this storyline have a %s climate risk. %s\n\n",
              storylines$Climate_risk[i],
              storylines$Desc[i])
}




#'========================================================================
# Misc ####
#'========================================================================
make.report <- function(report.title=NULL,report.subtitle=NULL,
                        FAO.areas=NULL,species=NULL,
                        output_file="Report.pdf") {
  these.params <- list()
  these.params$report.title <- report.title
  these.params$report.subtitle <- report.subtitle
  these.params$FAO.areas <- FAO.areas
  these.params$species <- species
  rmarkdown::render(here("shiny/Report.Rmd"), 
                    params =these.params,
                    output_file=output_file,
                    output_dir=here("outputs/reports"),
                    output_format="pdf_document")
}


make.storyline.reports <- function() {
  storylines %>%
    mutate(report.title=Name,
           report.subtitle=sprintf("CERES Storyline #%s",Number),
           output_file=sprintf("Storyline_%i.pdf",Number)) %>%
    select(-Number,-Name,FAO.areas=FAO_areas,species=Species) %>%
  pmap(make.report)
}

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
