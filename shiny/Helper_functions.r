#'========================================================================
# Shiny_figures
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Code to make figures for use in shiny apps and associated reports.
# All figures are defined as functions, which can then we called from 
# either the Shiny app or report (pdf) generation scripts.
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
#One common setup used to ensure compatability
library(tidyverse)
library(shiny)
library(shinydashboard)
library(sp)
library(sf)
library(scales)
library(mapdata)
library(shinyWidgets)
library(lubridate)
library(here)

#'========================================================================
# Setup ####
#'========================================================================
#Import data
sp.db <- readRDS(here("objects/species_database.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
flt.risk <- readRDS(here("objects/fleet_metrics/Fleet_risk.rds"))
flt.catch <- readRDS(here("objects/catch/STECF_catch_data.rds"))

#Restrict FAO polygons
FAO.areas <- 
  readRDS(here("objects/Geodata/FAO_polygons.rds")) %>%
  filter(F_AREA %in% c(37,27))

#Import storylines
storylines <- 
  read_csv2(here("data/Storylines.csv")) %>%
  mutate(FAO_areas=purrr::map(FAO_areas,~str_split(.x,pattern=", ")[[1]]),
         Species=purrr::map(Species,~str_split(.x,pattern=", ")[[1]]))

#'========================================================================
# Plots ####
#'========================================================================


#' Selected FAO areas --------------------------------------------------------------
#'
#' @param FAO.areas.sel Vector of FAO subarea codes, used to define the spatial areas
#' to include
#'
#' @return GGplot2
#' @export
plt.sel.FAO <- function(FAO.areas.sel) {
  FAO.areas %>%
  mutate(selected = factor(F_CODE %in% FAO.areas.sel,c(FALSE,TRUE))) %>%
  ggplot()+
  geom_sf(aes(fill=selected),colour="blue")+
  annotation_map(map_data("worldLores"),fill="black")+
  scale_fill_manual(values=c("white","grey"),drop=FALSE,guide=FALSE)+
  coord_sf(expand=FALSE)+
  theme_bw()+
  theme(plot.background = element_blank())
}


#' Stock hazard plot -------------------------------------------------------------
#'
#' @param FAO.areas.sel Vector of FAO subarea codes, used to define the spatial areas
#' to include
#' @param sp.sel Vector of FAO 3A codes, used to define the species to include
#'
#' @return GGPlot2 figure
plt.stk.haz <- function(FAO.areas.sel,sp.sel) {
  
  sel.stks <- 
    stk.haz %>%
    filter(F_CODE %in% FAO.areas.sel) %>%
    mutate(Stocks="All in region(s)")
  
  sel.stks %>%
    filter(FAO_3A_code %in% sp.sel) %>%
    mutate(Stocks=FAO_3A_code) %>%
    bind_rows(sel.stks) %>%  #Add in rest of stocks
    mutate(Stocks=fct_relevel(Stocks,"All in region(s)"),
           hazard=rescale(hazard)) %>%
    #Plot
    ggplot(aes(x=hazard,fill=Stocks))+
    geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
    theme_void()+
    theme(axis.text.x=element_text())+
    scale_x_continuous(breaks=c(0,1),labels=c("Lowest","Highest"))
}


# Fleet Risk plot -----------------------------------------------------------------
#'
#' @param FAO.areas.sel Vector of FAO subarea codes, used to define the spatial areas
#' to include
#' @param sp.sel Vector of FAO 3A codes, used to define the species to include
#'
#' @return GGPlot2 figure
plt.flt.risk <- function(FAO.areas.sel,sp.sel) {
  #Get fleets that fish in this area
  sel.fleets <-
    flt.catch %>%
    filter(F_SUBAREA %in% FAO.areas.sel) %>%
    group_by(fs_name) %>%
    summarise(catches.sp=any(species_code %in% sp.sel)) %>%
    left_join(y=flt.risk,by="fs_name") %>%
    mutate(Fleets="All in region(s)")
  
  #Merge with risk metrics for all fleets this region
  risk.mets <- 
    sel.fleets %>%
    filter(catches.sp) %>%
    mutate(Fleets="Catch sel. species") %>%
    bind_rows(sel.fleets) %>%
    mutate(Fleets=fct_relevel(Fleets,"All in region(s)")) %>%
    #Make tidy
    select(fs_name,hazard,exposure,vulnerability,risk,Fleets) %>%
    rename("a) Hazard"=hazard,
           "b) Exposure"=exposure,
           "c) Vulnerability"=vulnerability,
           "d) Risk"=risk) %>%
    gather("metric","value",-fs_name,-Fleets) %>%
    #Rescale
    group_by(metric) %>%
    mutate(value=rescale(value)) %>%
    ungroup()
  
  #Make plots
  plot.opts <- list(
    theme_void())

  
  risk.plt <- 
    risk.mets %>%
    filter(metric=="d) Risk") %>%
    ggplot(aes(x=value,fill=Fleets))+
    geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
    facet_wrap(~metric)+
    plot.opts
  
  
  components.plt <- 
    risk.mets %>%
    filter(metric!="d) Risk") %>%
    ggplot(aes(x=value,fill=Fleets))+
    geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
    facet_wrap(~metric,ncol=1)+
    guides(fill=FALSE)+
    plot.opts
  
  
  
  ggplot() +
    coord_cartesian(xlim = c(0, 4), ylim = c(0, 1), expand = FALSE) +
    annotation_custom(ggplotGrob(components.plt), 
                      xmin = 0, xmax = 1, 
                      ymin = 0, ymax = 1) +
    annotation_custom(ggplotGrob(risk.plt), 
                      xmin = 1, xmax = 4, 
                      ymin = 0, ymax = 1) +
    theme_void()
}

#'========================================================================
# Tables ####
#'========================================================================
# Selected species table ----------------------------------------------------------
#'
#' @param sp.sel Vector of FAO 3A codes, used to define the species to include
#'
#' @return Table of selected species
tbl.sel.sp <- function(sp.sel) {
  sp.db %>%
    filter(FAO_3A_code %in% sp.sel) %>%
    arrange(FAO_3A_code) %>%
    select("FAO Code"=FAO_3A_code,
           "Common name"=FAO_EN,
           "Scientific name"=Scientific_name) 
}


#'========================================================================
# Misc ####
#'========================================================================
make.report <- function(report.title=NULL,output_file="Report.pdf",FAO.areas=NULL,species=NULL) {
  these.params <- list()
  these.params$report.title <- report.title
  these.params$FAO.areas <- FAO.areas
  these.params$species <- species
  rmarkdown::render(here("shiny/Report.Rmd"), 
                    params =these.params,
                    output_file=output_file,
                    output_dir=here("outputs/reports"),
                    output_format="pdf_document")
}


make.storyline.reports <- function() {
  storylines %>%
    mutate(report.title=sprintf("#%s, %s",Number,Name),
           output_file=sprintf("Storyline_%i.pdf",Number)) %>%
    select(-Number,-Name,FAO.areas=FAO_areas,species=Species) %>%
  pmap(make.report)
}

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
