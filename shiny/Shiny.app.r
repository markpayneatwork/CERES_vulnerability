#'========================================================================
# Shiny.app.r
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Tue Oct  8 09:39:59 2019
#
# Shiny app for visualising the SIDS Predictability results 
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","Shiny.app.r"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3];

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)

library(shiny)
library(shinydashboard)
library(sp)
library(sf)
library(scales)
library(mapdata)
library(shinyWidgets)
library(lubridate)
library(here)

#'========================================================================
# Setup ####
#'========================================================================
#Import data
sp.db <- readRDS(here("objects/species_database.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
flt.haz <- readRDS(here("objects/fleet_metrics/Fleet_hazard.rds"))
flt.catch <- readRDS(here("objects/catch/STECF_catch_data.rds"))
FAO.poly <- readRDS(here("objects/Geodata/FAO_polygons.rds"))

#Setup species and area selections
sel.sp <- 
  sp.db %>%
  filter(grepl("Merluccius",Scientific_name) | grepl("[Hh]ake",FAO_EN))
sel.areas <- c("37.1","37.2","37.3","37.4")
storyline.name <- "Hake"

#'========================================================================
# UI ####
#'========================================================================
# Title row -----------------------------------------------------------------------
ui.hdr <- 
  HTML('<table style="width:100%">
          <tr>
         <td valign="center"> 
           <img src="CERES_logo.png"  height=35px />
         </td> 
         <td valign="center"> 
           <h1>CERES Climate Risk Analysis </h1> 
         </td> 
         </table>')



# by Species Tab ------------------------------------------------------------------
#Species selection
sci.names <-
  sp.db %>%
    mutate(disp.name=sprintf("%s (%s)", Scientific_name,FAO_EN)) %>%
    select(disp.name,FAO_3A_code) %>%
    arrange(disp.name) %>%
    deframe()
FAO.EN.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_EN,Scientific_name)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 
FAO.3A.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_3A_code,FAO_EN)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 

sp.sel.box.ctrls <- list(radioButtons(inputId="sp.select.by",
                                      label="Select species by",
                                      choices=c("Scientific name"="sci",
                                                "Common Name"="common",
                                                "FAO Code"="FA03A"),
                                      selected="FAO Code"),
                         pickerInput(inputId = "sp.sel",
                                     multiple=TRUE,
                                     choices = sci.names,
                                     selected=c("ALB","BFT")))

#Area selection
FAO.areas.sel <- 
  FAO.poly %>%
  filter(F_AREA %in% c(37,27)) %>%
  mutate(selected=FALSE)

sp.sidebar.panel <- sidebarPanel(width=4,
                                 sp.sel.box.ctrls,
                                 plotOutput("area.sel",click="area.sel.click"),
                                 actionButton("areas.toggle.button","Toggle"),
                                 actionButton("areas.reset.button","Reset"))

#Results panel

sp.main.panel <- mainPanel(h2("Configuration"),
                           h4("Selected FAO Subareas"),
                           textOutput("sp.sel.area.tbl"),
                           h4("Selected species"),
                           tableOutput("sp.sel.sp.tbl"),
                           h2("Climate Hazard to Stocks"),
                           plotOutput(outputId = "stock.hazard"),
                           h2("Climate Risk to Fleets"),
                           plotOutput(outputId = "fleet.risk"))

# Tab setup -----------------------------------------------------------------------
# tab.panels.l <- list(              
#   tabPanel("About", plotOutput("plot")),
#   tabPanel("Storylines", verbatimTextOutput("summary")),
#   #tabPanel("by Species", sidebarLayout(sp.sidebar.panel,sp.main.panel)),
#   tabPanel("by Fleet", verbatimTextOutput("summary")))

# Bring it all together -----------------------------------------------------------
# ui <- fluidPage(ui.hdr,sidebarLayout(sp.sidebar.panel,sp.main.panel))

ui <- fluidPage(ui.hdr,
                tabsetPanel(tabPanel("About", plotOutput("plot")),
                            tabPanel("Storylines", verbatimTextOutput("summary")),
                            tabPanel("by Species", sidebarLayout(sp.sidebar.panel,sp.main.panel)),
                            tabPanel("by Fleet", verbatimTextOutput("asdfadf")),
                            selected="by Species"))

#'========================================================================
# Server ####
#'========================================================================

server <- function(input, output, session) { 

  # Species selection method -----------------------------------------------------
  observeEvent(input$sp.select.by,{
    sel.by <- switch(input$sp.select.by,
                     sci=sci.names,
                     common=FAO.EN.names,
                     FAO.3A.names)
    updatePickerInput(session,
                      "sp.sel",
                      choices=sel.by)
  })

  #Species selection
  sel.sp <- reactive({
    sp.db %>%
      filter(FAO_3A_code %in% input$sp.sel)
    })

  
  #Selected species table
  output$sp.sel.sp.tbl <- renderTable({
    sel.sp() %>%
      arrange(FAO_3A_code) %>%
      select("FAO Code"=FAO_3A_code,
             "Common name"=FAO_EN,
             "Scientific name"=Scientific_name) 
  })
  
  
  # Area selection ------------------------------------------------------------------
  # Reactive list of selected areas and codes
  sel.area <- reactiveValues(
    selected = rep(TRUE, nrow(FAO.areas.sel)),
    codes = FAO.areas.sel$F_CODE)
  observeEvent(sel.area$selected, {  #Update codes on change
    sel.area$codes <- FAO.areas.sel$F_CODE[sel.area$selected]
  })

  #Make plot
  output$area.sel <- renderPlot({
    FAO.areas.sel %>%
      mutate(selected = factor(sel.area$selected,c(FALSE,TRUE))) %>%
      ggplot()+
      geom_sf(aes(fill=selected),colour="blue")+
      annotation_map(map_data("world"),fill="black")+
      #geom_sf_text(aes(label=F_CODE))+
      scale_fill_manual(values=c("grey","red"),drop=FALSE,guide=FALSE)+
      theme_bw()
  })
  
  #Clicking in an area toggles that area
  observeEvent(input$area.sel.click, {
    this.point <- st_as_sf(data.frame(x=input$area.sel.click$x,
                                      y=input$area.sel.click$y),
                           coords = c("x","y"),crs=4326)
    this.idx  <- st_within(this.point,FAO.areas.sel)
    if(length(this.idx[[1]])==1){
      sel.area$selected[this.idx[[1]]] <- !sel.area$selected[this.idx[[1]]]
    }
  })
  
  # Clicking toggle inverts everything 
  observeEvent(input$areas.toggle.button, {
    sel.area$selected <- !sel.area$selected
  })
  
  # Reset all points
  observeEvent(input$areas.reset.button, {
    sel.area$selected[] <- FALSE
  })
  
  #Selected area table
  output$sp.sel.area.tbl <- renderText({
    sort.tbl <- 
      tibble(FAO.code=sel.area$codes) %>%
      tidyr::separate(FAO.code,c("AREA","SUBAREA"),sep="\\.",remove=FALSE) %>%
      mutate(SUBAREA=as.numeric(SUBAREA)) %>%
      arrange(AREA,SUBAREA) 
    paste(sort.tbl$FAO.code,collapse=", ")
  })
  
  
  #Select stocks in these selected areas
  sel.stks <- reactive({
    stk.haz %>%
      filter(F_CODE %in% sel.area$codes) %>%
      mutate(Stocks="All in region(s)")
  })
  
  # Stock hazard plot -------------------------------------------------------------

  #Plot the species risks of interest
  output$stock.hazard <- renderPlot({
    sel.stks() %>%
      filter(FAO_3A_code %in% input$sp.sel) %>%
      mutate(Stocks=FAO_3A_code) %>%
      bind_rows(sel.stks()) %>%  #Add in rest of stocks
      mutate(Stocks=fct_relevel(Stocks,"All in region(s)"),
             hazard=rescale(hazard)) %>%
      #Plot
      ggplot(aes(x=hazard,fill=Stocks))+
      geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
      theme_void()+
      theme(axis.title=element_text(),
            axis.text.x=element_text(),
            axis.title.x=element_text())+
      scale_x_continuous(breaks=c(0,1),labels=c("Lowest","Highest"))+
      labs(x="Climate Hazard",y="")
  })

  # Fleet Hazard plot ---------------------------------------------------------------
  
  #Make plot
  output$fleet.risk <- renderPlot({
    #Get fleets that fish in this area
    sel.fleets <-
        flt.catch %>%
        filter(F_SUBAREA %in% sel.area$codes) %>%
        group_by(fs_name) %>%
        summarise(catches.sp=any(species_code %in% input$sp.sel)) %>%
        left_join(y=flt.haz,by="fs_name") %>%
        mutate(Fleets="All in region(s)")

    #Get the hazard for all fleets this region
    sel.fleets %>%
      filter(catches.sp) %>%
      mutate(Fleets="Catch sel. species") %>%
      bind_rows(sel.fleets) %>%
      mutate(Fleets=fct_relevel(Fleets,"All in region(s)")) %>%
      #Plot
      ggplot(aes(x=hazard,fill=Fleets))+
      geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
      theme_void()+
      theme(axis.title=element_text(),axis.title.x=element_text())+
      labs(x="Climate Hazard",y="")
  })
  
  # Country map -----------------------------------------------------

  #choice of the country
  # new.GeoName <- reactive({
  #   input$zone
  # })
  
  # codeZone <-  reactive({
  #   as.character(eez.sf$MRGID[eez.sf$GeoName==new.GeoName()])
  # })
  

  # #Setup mapping 
  # EEZ.sel <- reactive({
  #   filter(eez.sf,MRGID==codeZone())
  # })

  # xtent <- reactive({
  #   raster::extend(raster::extent(EEZ.sel()),10)
  # })
  # 
  ### MAP ###
  # output$map <- renderPlot({
  #   ggplot() + 
  #     annotation_map(map_data("worldHires"),fill="black",colour="grey") + 
  #     geom_sf(data=EEZ.sel()) + 
  #     coord_sf(xlim=xtent()[1:2],ylim=xtent()[3:4]) +
  #     ggtitle(as.character(new.GeoName())) + 
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           panel.grid.major=element_blank(),
  #           panel.grid.minor = element_blank()) 
  # })
  
  
  # Skill plot ----------------------------------------------------------------------
  #Select relevant skill metrics
  # skill.plt.dat <- reactive({
  #   skill.mets %>%
  #   filter(sp.subdomain==codeZone(),
  #          skill.metric=="cor") %>%
  #   spread(skill.type,value)
  # })
  # 
  # output$skill.plot <- renderPlot({
  #   
  #   # need(!is.null(forsys()), message = paste("You must choose at least one forecast system."))
  #   
  #   ggplot(skill.plt.dat(),mapping=aes(x=t,group=name))+
  #     geom_vline(xintercept=1,colour="darkgrey")+
  #     geom_ribbon(aes(ymin=min.skill,ymax=max.skill,fill=type),alpha=0.25)+
  #     geom_line(aes(y=mean.skill,col=type),size=1)+
  #     coord_cartesian(ylim=c(0,1),expand=FALSE)+
  #     scale_linetype_manual(values=c("solid","dotted"))+
  #     scale_size_manual(values=c(2,0.5))+
  #     scale_x_continuous(breaks=x.lbls$t,
  #                        labels=x.lbls$lbl,
  #                        minor_breaks = x.minor$t)+
  #     labs(x="Lead time (months / years)",
  #          y="Correlation coefficient (r)",
  #          colour="Forecast System",
  #          fill="Forecast System")+
  #     ggtitle("Skill metrics") + 
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           axis.title.x = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           axis.title.y = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           legend.title = element_text(size=12,face="bold"),
  #           legend.position = "bottom") 
  # })

  # Forecasts -----------------------------------------------------------------------
  #Select relevant forecast metrics
  # forecast.plt.dat <- reactive({
  #   forecasts %>%
  #     filter(sp.subdomain==codeZone()) 
  # })
  # 
  # obs.limit <- reactive({
  #   input$time
  # })
  # 
  # plot.line <- reactive({
  #   input$plot.line
  # })
  # 
  # 
  # obs.plt.dat <- reactive({
  #     obs %>%
  #       filter(sp.subdomain==codeZone(),
  #              year(date)>=obs.limit()) 
  #   })
  
  # output$forecast.plot <- renderPlot({
  #   
  #   # need(!is.null(forsys()), message = paste("You must choose at least one forecast system."))
  #   
  #   # forecast.plt.dat <- filter(forecasts,sp.subdomain=="21787")
  #   #obs.plt.dat <- filter(obs,sp.subdomain=="21787")
  #   
  #    if(plot.line()) {
  #      obs.layer <- geom_line(data=obs.plt.dat(),aes(colour="Observations",size="Observations"))
  #   } else {
  #     obs.layer <- geom_point(data=obs.plt.dat(),aes(colour="Observations",size="Observations"))
  #   }
  #   
  #   
  #   ggplot(mapping=aes(x=date,y=value,group=name))+
  #     #Grid lines
  #     geom_hline(yintercept=0)+
  #     #Forecast lines
  #     geom_line(data=filter(forecast.plt.dat(),name!="NMME-ensmean"),
  #               mapping=aes(colour="Models",
  #                           size="Models"))+
  #     geom_line(data=filter(forecast.plt.dat(),name=="NMME-ensmean"),
  #               mapping=aes(colour="Ensmean",
  #                           size="Ensmean"))+
  #     #Observations
  #     obs.layer+
  #     geom_smooth(data=obs.plt.dat(),se=FALSE)+
  #     #Misc
  #     scale_size_manual(values=c(2,0.25,1))+
  #     guides(size=FALSE)+
  #     labs(title="Observations and Forecasts",
  #          x="Date",
  #          y="SST Anomaly (deg C)",
  #          colour="")+
  #     facet_wrap(~dat.type,scale="free_x")+
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           axis.title.x = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           axis.title.y = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           legend.title = element_text(size=12,face="bold"),
  #           legend.position="bottom") 
  # })
  # 
    
}




#'========================================================================
# Go! ####
#'========================================================================


shinyApp(ui, server)



# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
