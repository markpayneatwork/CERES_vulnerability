#'========================================================================
# Shiny.app.r
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Tue Oct  8 09:39:59 2019
#
# Shiny app for visualising the SIDS Predictability results 
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise ####
#'========================================================================
source(here::here("shiny/Helper_functions.r"))

#'========================================================================
# UI ####
#'========================================================================
# Title row -----------------------------------------------------------------------
ui.hdr <- 
  HTML('<table style="width:100%">
          <tr>
         <td valign="center"> 
           <img src="CERES_logo.png"  height=35px />
         </td> 
         <td valign="center" align="left"> 
           <h1>CERES Climate Risk Analysis </h1> 
         </td> 
         </table>')

# About Tab -----------------------------------------------------------------------
about.tab <- 
  HTML('<p>The source code for both this application and the associated analysis are stored under 
  version control on GitHub at 
  <a href="https://github.com/markpayneatwork/CERES_vulnerability" class="uri">https://github.com/markpayneatwork/CERES_vulnerability</a></p>

  <p>This work is licensed under the <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>
  
  <p>This work has recevied funding from the European Unionâ€™s Horizon 2020 research and innovation programme under 
  grant agreement No 678193 (CERES, Climate Change and European Aquatic Resources).</p>

  <center>
    <img src="Logo_transparent.png" height="100px">
    <img src="flag_yellow_high-Kopie-300x200.jpg" height="100px")
  </center>')

# by Species Tab ------------------------------------------------------------------
#Species selection
sci.names <-
  sp.db %>%
    mutate(disp.name=sprintf("%s (%s)", Scientific_name,FAO_EN)) %>%
    select(disp.name,FAO_3A_code) %>%
    arrange(disp.name) %>%
    deframe()
FAO.EN.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_EN,Scientific_name)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 
FAO.3A.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_3A_code,FAO_EN)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 

sp.sel.box.ctrls <- list(radioButtons(inputId="sp.select.by",
                                      label="Select species by",
                                      choices=c("Scientific name"="sci",
                                                "Common Name"="common",
                                                "FAO Code"="FA03A"),
                                      selected="FAO Code"),
                         pickerInput(inputId = "sp.sel",
                                     multiple=TRUE,
                                     choices = sci.names,
                                     selected=c("ALB","BFT")))

#Area selection
sp.sidebar.panel <- sidebarPanel(width=4,
                                 sp.sel.box.ctrls,
                                 HTML('<label class="control-label" for="sp.area.sel">Click to select FAO subarea</label>'),
                                 plotOutput("sp.area.sel",click="sp.area.sel.click",height="250px"),
                                 actionButton("sp.toggle.button","Toggle"),
                                 actionButton("sp.reset.button","Reset"))

#Results panel
sp.main.panel <- mainPanel(h3("Selected species"),
                           tableOutput("sp.sel.sp.tbl"),
                           h3("Climate Hazard to Stocks"),
                           plotOutput(outputId = "sp.stock.hazard"),
                           h3("Climate Risk to Fleets"),
                           plotOutput(outputId = "sp.fleet.risk"))

# Storylines tab ------------------------------------------------------------------
#Storyline selection
storyline.choices <- seq(nrow(storylines))
names(storyline.choices) <- storylines$Name

sty.sel.box.ctrls <- list(radioButtons(inputId="sty.select",
                                      label="Select storyline",
                                      choices=storyline.choices,
                                      selected=1))
#Area selection
sty.sidebar.panel <- sidebarPanel(width=4,
                                  sty.sel.box.ctrls)

#Results panel
sty.main.panel <- mainPanel(h2(textOutput("sty.title")),
                           h3("Species"),
                           tableOutput("sty.sel.sp.tbl"),
                           h3("FAO Subareas"),
                           plotOutput("sty.sel.area"),
                           h3("Climate Hazard to Stocks"),
                           plotOutput(outputId = "sty.stock.hazard"),
                           h3("Climate Risk to Fleets"),
                           plotOutput(outputId = "sty.fleet.risk"))


# Bring it all together -----------------------------------------------------------
ui <- fluidPage(ui.hdr,
                tabsetPanel(tabPanel("About", about.tab),
                            tabPanel("Storylines", sidebarLayout(sty.sidebar.panel,sty.main.panel)),
                            tabPanel("by Species", sidebarLayout(sp.sidebar.panel,sp.main.panel)),
                            tabPanel("by Fleet", verbatimTextOutput("asdfadf")),
                            selected="by Species"))

#'========================================================================
# Server ####
#'========================================================================
server <- function(input, output, session) { 
  
  # Storylines Tab ------------------------------------------------------------------
  #First configure a reactive value based on the storyline radio buttons
  storyline.cfg <- reactiveValues(FAO_areas=NA,Species=NA,Storyline.name=NA)
  observeEvent(input$sty.select, {
    #Extract configuration
    storyline.cfg$FAO_areas <- storylines[input$sty.select,]$FAO_areas[[1]]
    storyline.cfg$Species <- storylines[input$sty.select,]$Species[[1]]
    storyline.cfg$Name <- storylines[input$sty.select,]$Name[[1]]
  })
  
  #Then update plots
  output$sty.title <- renderText({storyline.cfg$Name})
  output$sty.sel.sp.tbl <-  renderTable({tbl.sel.sp(storyline.cfg$Species)})
  output$sty.sel.area <- renderPlot({plt.sel.FAO(storyline.cfg$FAO_areas)})
  output$sty.stock.hazard <- renderPlot({plt.stk.haz(storyline.cfg$FAO_areas, storyline.cfg$Species)})
  output$sty.fleet.risk <- renderPlot({plt.flt.risk(storyline.cfg$FAO_areas, storyline.cfg$Species)})


  # by Species tab ---------------------------------------------------------------
  # Species Selection method
  observeEvent(input$sp.select.by,{
    sel.by <- switch(input$sp.select.by,
                     sci=sci.names,
                     common=FAO.EN.names,
                     FAO.3A.names)
    updatePickerInput(session,
                      "sp.sel",
                      choices=sel.by)
  })

  #Selected species table
  output$sp.sel.sp.tbl <- renderTable({tbl.sel.sp(input$sp.sel)})

  # Area selection 
  # Reactive list of selected areas and codes
  sp.sel.area <- reactiveValues(
    selected = rep(TRUE, nrow(FAO.areas)),
    codes = FAO.areas$F_CODE)
  observeEvent(sp.sel.area$selected, {  #Update codes on change
    sp.sel.area$codes <- FAO.areas$F_CODE[sp.sel.area$selected]
  })

  #Make area selection plot
  output$sp.area.sel <- renderPlot(bg="transparent",{plt.sel.FAO(sp.sel.area$codes)})
  
  #Clicking in an area toggles that area
  observeEvent(input$sp.area.sel.click, {
    this.point <- st_as_sf(data.frame(x=input$sp.area.sel.click$x,
                                      y=input$sp.area.sel.click$y),
                           coords = c("x","y"),crs=4326)
    this.idx  <- st_within(this.point,FAO.areas)
    if(length(this.idx[[1]])==1){
      sp.sel.area$selected[this.idx[[1]]] <- !sp.sel.area$selected[this.idx[[1]]]
    }
  })
  
  # Clicking toggle inverts everything 
  observeEvent(input$sp.toggle.button, {sp.sel.area$selected <- !sp.sel.area$selected})
  
  # Reset all points
  observeEvent(input$sp.reset.button, {sp.sel.area$selected[] <- FALSE})
  
  # Stock hazard plot 
  output$sp.stock.hazard <- renderPlot({plt.stk.haz(sp.sel.area$codes, input$sp.sel)})

  # Fleet Hazard plot 
  output$sp.fleet.risk <- renderPlot({plt.flt.risk(sp.sel.area$codes, input$sp.sel)})

}

#'========================================================================
# Go! ####
#'========================================================================

shinyApp(ui, server)



# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
