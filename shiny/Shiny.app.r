#'========================================================================
# Shiny.app.r
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Tue Oct  8 09:39:59 2019
#
# Shiny app for visualising the SIDS Predictability results 
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","Shiny.app.r"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3];

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)

library(shiny)
library(shinydashboard)
library(sp)
library(sf)
library(scales)
library(mapdata)
library(shinyWidgets)
library(lubridate)
library(here)

#'========================================================================
# Setup ####
#'========================================================================
#Import data
sp.db <- readRDS(here("objects/species_database.rds"))
stk.haz <- readRDS(here("objects/biological_metrics/stock_hazard.rds"))
flt.haz <- readRDS(here("objects/fleet_metrics/Fleet_hazard.rds"))
flt.catch <- readRDS(here("objects/catch/STECF_catch_data.rds"))

#Setup species and area selections
sel.sp <- 
  sp.db %>%
  filter(grepl("Merluccius",Scientific_name) | grepl("[Hh]ake",FAO_EN))
sel.areas <- c("37.1","37.2","37.3","37.4")
storyline.name <- "Hake"

#'========================================================================
# UI ####
#'========================================================================
# Title row -----------------------------------------------------------------------
ui.hdr <- 
  HTML('<table style="width:100%">
          <tr>
         <td valign="center"> 
           <img src="CERES_logo.png"  height=35px />
         </td> 
         <td valign="center"> 
           <h1>CERES Climate Risk Analysis </h1> 
         </td> 
         </table>')


# Species selection ---------------------------------------------------------------
#Configure selection box
# tags$head(tags$style("
#                   .jhr{
#                   display: inline;
#                   vertical-align: middle;
#                   padding-left: 10px;
#                   }",
#                      type = "text/css", '
#       .irs-line-mid{
#         background: #428bca ;
#         border: 1px solid #428bca ;
#       }
#       .irs-line-right{
#         background: #428bca ;
#       }
#       .irs-bar {
#         background: linear-gradient(to bottom, #DDD -50%, #FFF 150%);
#         border-top: 1px solid #CCC ;
#         border-bottom: 1px solid #CCC ;
#       }
#       .irs-bar-edge {
#         background: inherit ;
#         border: inherit ;
#       }
# 
#     '))

sci.names <-
  sp.db %>%
    mutate(disp.name=sprintf("%s (%s)", Scientific_name,FAO_EN)) %>%
    select(disp.name,FAO_3A_code) %>%
    arrange(disp.name) %>%
    deframe()
FAO.EN.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_EN,Scientific_name)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 
FAO.3A.names <- 
  sp.db %>%
  mutate(disp.name=sprintf("%s (%s)", FAO_3A_code,FAO_EN)) %>%
  select(disp.name,FAO_3A_code) %>%
  arrange(disp.name) %>%
  deframe() 

sel.box.ctrls <- list( 
  radioButtons("select.by","Select species by",
               c("Scientific name"="sci",
                 "Common Name"="common",
                 "FAO Code"="FA03A")),
  pickerInput(inputId = "sp.sel",
              choices = sci.names))

# ui.l$sp.sel.box <- fluidRow(
#   column(4,wellPanel(sel.box.ctrls)),
#   column(8,plotOutput(outputId = "Stock.hazard")))

ui.sidebar.panel <- 
  sidebarPanel(width=4,sel.box.ctrls)

ui.main.panel <- mainPanel(
  plotOutput(outputId = "Stock.hazard"),
  plotOutput(outputId = "Stock.hazard2"),
  plotOutput(outputId = "Stock.hazard3"))

ui <- fluidPage(ui.hdr,sidebarLayout(ui.sidebar.panel,ui.main.panel))

#'========================================================================
# Server ####
#'========================================================================

server <- function(input, output, session) { 
  
  # Species selection switching -----------------------------------------------------
  observeEvent(input$select.by,{
    sel.by <- switch(input$select.by,
                     sci=sci.names,
                     common=FAO.EN.names,
                     FAO.3A.names)
    updatePickerInput(session,
                      'sp.sel',
                      choices=sel.by)
  })

  #Setup species and area selections
  sel.sp <- reactive({
    sp.db %>%
      filter(FAO_3A_code==input$sp.sel)
    })
  
  sel.areas <- c("37.1","37.2","37.3","37.4")
  storyline.name <- "Hake"
  
  #Select stocks in these regions
  stk.sel <-
    stk.haz %>%
    filter(F_CODE %in% sel.areas) %>%
    mutate(Stocks="All in region")

  # Stock hazard plot -------------------------------------------------------------

  #Plot the species hazard of interest
  output$Stock.hazard <- renderPlot({
    stk.sel %>%
      filter(FAO_3A_code %in%  sel.sp()$FAO_3A_code) %>%
      mutate(Stocks=storyline.name) %>%
      bind_rows(stk.sel) %>%
      #Plot
      ggplot(aes(x=hazard,fill=Stocks))+
      geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
      theme_void()+
      theme(axis.title=element_text(),axis.title.x=element_text())+
      labs(x="Climate Hazard",y="")
  })

  output$Stock.hazard2 <- renderPlot({
    stk.sel %>%
      filter(FAO_3A_code %in%  sel.sp()$FAO_3A_code) %>%
      mutate(Stocks=storyline.name) %>%
      bind_rows(stk.sel) %>%
      #Plot
      ggplot(aes(x=hazard,fill=Stocks))+
      geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
      theme_void()+
      theme(axis.title=element_text(),axis.title.x=element_text())+
      labs(x="Climate Hazard",y="")
  })

  output$Stock.hazard3 <- renderPlot({
    stk.sel %>%
      filter(FAO_3A_code %in%  sel.sp()$FAO_3A_code) %>%
      mutate(Stocks=storyline.name) %>%
      bind_rows(stk.sel) %>%
      #Plot
      ggplot(aes(x=hazard,fill=Stocks))+
      geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
      theme_void()+
      theme(axis.title=element_text(),axis.title.x=element_text())+
      labs(x="Climate Hazard",y="")
  })
  
  # Fleet Hazard plot ---------------------------------------------------------------

  
  # #Get fleets that fish on this species, in this area
  # flts.in.area <- 
  #   flt.catch %>%
  #   filter(F_SUBAREA %in% sel.areas)
  # flts.catching.sp <- 
  #   flts.in.area %>%
  #   filter(species_code %in% sel.sp$FAO_3A_code)
  # 
  # #Now prepare hazard data
  # sel.flt.haz <-
  #   flt.haz %>%
  #   filter(fs_name %in% flts.in.area$fs_name) %>%
  #   mutate(Fleets="All in region")
  # 
  # sel.flt.haz %>%
  #   filter(fs_name %in% flts.catching.sp$fs_name) %>%
  #   mutate(Fleets="Catching Hake") %>%
  #   bind_rows(sel.flt.haz) %>%
  #   #Plot
  #   ggplot(aes(x=hazard,fill=Fleets))+
  #   geom_density(aes(y=..scaled..),colour=NA,alpha=0.75)+
  #   theme_void()+
  #   theme(axis.title=element_text(),axis.title.x=element_text())+
  #   labs(x="Climate Hazard",y="")
  
  # output$map <- renderPlot({
  #   ggplot() + 
  #     annotation_map(map_data("worldHires"),fill="black",colour="grey") + 
  #     geom_sf(data=EEZ.sel()) + 
  #     coord_sf(xlim=xtent()[1:2],ylim=xtent()[3:4]) +
  #     ggtitle(as.character(new.GeoName())) + 
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           panel.grid.major=element_blank(),
  #           panel.grid.minor = element_blank()) 
  # })
  
  
  

  # Country map -----------------------------------------------------

  #choice of the country
  # new.GeoName <- reactive({
  #   input$zone
  # })
  
  # codeZone <-  reactive({
  #   as.character(eez.sf$MRGID[eez.sf$GeoName==new.GeoName()])
  # })
  

  # #Setup mapping 
  # EEZ.sel <- reactive({
  #   filter(eez.sf,MRGID==codeZone())
  # })

  # xtent <- reactive({
  #   raster::extend(raster::extent(EEZ.sel()),10)
  # })
  # 
  ### MAP ###
  # output$map <- renderPlot({
  #   ggplot() + 
  #     annotation_map(map_data("worldHires"),fill="black",colour="grey") + 
  #     geom_sf(data=EEZ.sel()) + 
  #     coord_sf(xlim=xtent()[1:2],ylim=xtent()[3:4]) +
  #     ggtitle(as.character(new.GeoName())) + 
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           panel.grid.major=element_blank(),
  #           panel.grid.minor = element_blank()) 
  # })
  
  
  # Skill plot ----------------------------------------------------------------------
  #Select relevant skill metrics
  # skill.plt.dat <- reactive({
  #   skill.mets %>%
  #   filter(sp.subdomain==codeZone(),
  #          skill.metric=="cor") %>%
  #   spread(skill.type,value)
  # })
  # 
  # output$skill.plot <- renderPlot({
  #   
  #   # need(!is.null(forsys()), message = paste("You must choose at least one forecast system."))
  #   
  #   ggplot(skill.plt.dat(),mapping=aes(x=t,group=name))+
  #     geom_vline(xintercept=1,colour="darkgrey")+
  #     geom_ribbon(aes(ymin=min.skill,ymax=max.skill,fill=type),alpha=0.25)+
  #     geom_line(aes(y=mean.skill,col=type),size=1)+
  #     coord_cartesian(ylim=c(0,1),expand=FALSE)+
  #     scale_linetype_manual(values=c("solid","dotted"))+
  #     scale_size_manual(values=c(2,0.5))+
  #     scale_x_continuous(breaks=x.lbls$t,
  #                        labels=x.lbls$lbl,
  #                        minor_breaks = x.minor$t)+
  #     labs(x="Lead time (months / years)",
  #          y="Correlation coefficient (r)",
  #          colour="Forecast System",
  #          fill="Forecast System")+
  #     ggtitle("Skill metrics") + 
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           axis.title.x = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           axis.title.y = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           legend.title = element_text(size=12,face="bold"),
  #           legend.position = "bottom") 
  # })

  # Forecasts -----------------------------------------------------------------------
  #Select relevant forecast metrics
  # forecast.plt.dat <- reactive({
  #   forecasts %>%
  #     filter(sp.subdomain==codeZone()) 
  # })
  # 
  # obs.limit <- reactive({
  #   input$time
  # })
  # 
  # plot.line <- reactive({
  #   input$plot.line
  # })
  # 
  # 
  # obs.plt.dat <- reactive({
  #     obs %>%
  #       filter(sp.subdomain==codeZone(),
  #              year(date)>=obs.limit()) 
  #   })
  
  # output$forecast.plot <- renderPlot({
  #   
  #   # need(!is.null(forsys()), message = paste("You must choose at least one forecast system."))
  #   
  #   # forecast.plt.dat <- filter(forecasts,sp.subdomain=="21787")
  #   #obs.plt.dat <- filter(obs,sp.subdomain=="21787")
  #   
  #    if(plot.line()) {
  #      obs.layer <- geom_line(data=obs.plt.dat(),aes(colour="Observations",size="Observations"))
  #   } else {
  #     obs.layer <- geom_point(data=obs.plt.dat(),aes(colour="Observations",size="Observations"))
  #   }
  #   
  #   
  #   ggplot(mapping=aes(x=date,y=value,group=name))+
  #     #Grid lines
  #     geom_hline(yintercept=0)+
  #     #Forecast lines
  #     geom_line(data=filter(forecast.plt.dat(),name!="NMME-ensmean"),
  #               mapping=aes(colour="Models",
  #                           size="Models"))+
  #     geom_line(data=filter(forecast.plt.dat(),name=="NMME-ensmean"),
  #               mapping=aes(colour="Ensmean",
  #                           size="Ensmean"))+
  #     #Observations
  #     obs.layer+
  #     geom_smooth(data=obs.plt.dat(),se=FALSE)+
  #     #Misc
  #     scale_size_manual(values=c(2,0.25,1))+
  #     guides(size=FALSE)+
  #     labs(title="Observations and Forecasts",
  #          x="Date",
  #          y="SST Anomaly (deg C)",
  #          colour="")+
  #     facet_wrap(~dat.type,scale="free_x")+
  #     theme_bw() +
  #     theme(plot.title = element_text(size=15,face="bold",hjust=0.5),
  #           axis.title.x = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           axis.title.y = element_text(color="DarkSlateGray", size=13, face="bold"),
  #           legend.title = element_text(size=12,face="bold"),
  #           legend.position="bottom") 
  # })
  # 
    
}




#'========================================================================
# Go! ####
#'========================================================================


shinyApp(ui, server)



# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
