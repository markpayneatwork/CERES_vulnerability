#'========================================================================
# Shiny.app.r
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Tue Oct  8 09:39:59 2019
#
# Shiny app for visualising the SIDS Predictability results 
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================


#'========================================================================
# Server ####
#'========================================================================
shinyServer(function(input, output, session) { 
  
  # Storylines Tab ------------------------------------------------------------------
  #First configure a reactive value based on the storyline radio buttons
  storyline.cfg <- reactiveValues(FAO_areas=NA,Species=NA,Storyline.name=NA)
  observeEvent(input$sty.select, {
    #Extract configuration
    storyline.cfg$FAO_areas <- storylines[input$sty.select,]$FAO_areas[[1]]
    storyline.cfg$Species <- storylines[input$sty.select,]$Species[[1]]
    storyline.cfg$Name <- storylines[input$sty.select,]$Name[[1]]
    storyline.cfg$i <- input$sty.select
  })
  
  #Then update plots
  output$sty.title <- renderText({storyline.cfg$Name})
  output$sty.sel.sp.tbl <-  renderTable({tbl.sel.sp(storyline.cfg$Species)})
  output$sty.sel.area <- renderPlot({plt.sel.FAO(storyline.cfg$FAO_areas)})
  output$sty.stock.hazard <- renderPlot({plt.stk.haz(storyline.cfg$FAO_areas, storyline.cfg$Species)})
  output$sty.fleet.risk <- renderPlot({plt.flt.risk(storyline.cfg$FAO_areas, storyline.cfg$Species)})
  output$sty.risk.txt <- renderText({storyline.risk.txt(as.numeric(storyline.cfg$i))})


  # by Species tab ---------------------------------------------------------------
  # Species Selection method
  observeEvent(input$sp.select.by,{
    sel.by <- switch(input$sp.select.by,
                     sci=sci.names,
                     common=FAO.EN.names,
                     FAO.3A.names)
    updatePickerInput(session,
                      "sp.sel",
                      choices=sel.by)
  })

  #Selected species table
  output$sp.sel.sp.tbl <- renderTable({tbl.sel.sp(input$sp.sel)})

  # Area selection 
  # Reactive list of selected areas and codes
  sp.sel.area <- reactiveValues(
    selected = rep(TRUE, nrow(FAO.areas)),
    codes = FAO.areas$F_CODE)
  observeEvent(sp.sel.area$selected, {  #Update codes on change
    sp.sel.area$codes <- FAO.areas$F_CODE[sp.sel.area$selected]
  })

  #Make area selection plot
  output$sp.area.sel <- renderPlot(bg="transparent",{plt.sel.FAO(sp.sel.area$codes)})
  
  #Clicking in an area toggles that area
  observeEvent(input$sp.area.sel.click, {
    this.point <- st_as_sf(data.frame(x=input$sp.area.sel.click$x,
                                      y=input$sp.area.sel.click$y),
                           coords = c("x","y"),crs=4326)
    this.idx  <- st_within(this.point,FAO.areas)
    if(length(this.idx[[1]])==1){
      sp.sel.area$selected[this.idx[[1]]] <- !sp.sel.area$selected[this.idx[[1]]]
    }
  })
  
  # Clicking toggle inverts everything 
  observeEvent(input$sp.toggle.button, {sp.sel.area$selected <- !sp.sel.area$selected})
  
  # Reset all points
  observeEvent(input$sp.reset.button, {sp.sel.area$selected[] <- FALSE})
  
  # Stock hazard plot 
  output$sp.stock.hazard <- renderPlot({plt.stk.haz(sp.sel.area$codes, input$sp.sel)})

  # Fleet Hazard plot 
  output$sp.fleet.risk <- renderPlot({plt.flt.risk(sp.sel.area$codes, input$sp.sel)})
  
  # by Fleet ------------------------------------------------------------------------
  
  


})


# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
