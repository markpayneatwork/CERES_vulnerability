#'========================================================================
# F1.Prepare regional catch data
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Tue Sep 10 09:02:17 2019
#
# This script merges and harmonises data for use in calculating regional
# metrics i.e. EUMOFA data at the NUTS scale for 14/16 countries, and 
# EUROSTAT landings data at the national level for 26 countries. 
#
# A further complication is added by the fact that the approach to taxonomy is
# different between the two data sets - EUMOFA deals with species groups, while
# EUROSTAT is more species centric. This would, in principle, make a direct 
# comparison between the diversity metrics a little tricky (I'm not sure, I
# don't really know them well enough). We therefore aggregate EUROSTAT data to
# the same groups used by EUMOFA.
#
# This script creates metrics of regional exposure by first linking the 
# EUMOFA harbours to the NUTS regions. The EUMOFA data is then integrated to
# creates of exposure at the NUTS level.
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","F1.Prepare regional catch data"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3];

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)
library(sf)
library(units)
library(purrr)
library(reshape2)

#'========================================================================
# Configure ####
#'========================================================================
#Import EUMOFA
EUMOFA.dat <- readRDS("objects/EUMOFA/EUMOFA_data.rds")
MCS.ERS.key <- readRDS("objects/EUMOFA/MCS-ERS_key.rds")

#EUROSTAT data
EUROSTAT.landings <- readRDS("objects/EUROSTAT/landings.geo.rds")

#Regional polygons
NUTS.poly <- readRDS("objects/Geodata/NUTS_regions.rds")

#Manually specified country FAO codes, which are needed to do the stock lockups
cnty.FAO <- read_csv2("data/Country_F_Code.csv",
                      col_types = list(.default=col_character()))


#'========================================================================
# Tidy up EUMOFA data ####
#'========================================================================
#Aggregate ports to NUTS regions
EUMOFA.reg <- 
  EUMOFA.dat %>%
  rename(region=NUTS_ID)%>%
  filter(!is.na(region))%>%
  group_by(region,MCS,F_CODE) %>%
  summarise(value=sum(value),
            landings=sum(landings)) %>%
  #Add country info
  mutate(country=str_extract(region,"^.{2}")) %>%
  ungroup() %>%
  #Explicity drop some countries from EUMOFA - Norway and Sweden
  filter(!country %in% c("NO","SE"))

#Select NUTS regions that have EUMOFA data
EUMOFA.NUTS.poly <-
  NUTS.poly %>%
  filter(NUTS_ID %in% EUMOFA.reg$region) %>%
  select(region=NUTS_ID)

#'========================================================================
# EUROSTAT landings ####
#'========================================================================
#Aggregate EUROSTAT landings to MCS taxonomy
EUROSTAT.landings.geo.MCS <- 
  EUROSTAT.landings %>%
  #Select total landings in a country (not by vessels from a country) %>%
  filter(unit %in% c("EUR","TPW"),
         natvessr=="TOTAL") %>% #Across all vessels
  #Spread it out
  spread(unit,value) %>%
  #Merge in MCS and aggregate species into MCS bins
  left_join(y=MCS.ERS.key,by="species") %>%
  filter(!is.na(MCS)) %>%  #The NAs are generally the Fxx categories from FAO, plus RJQ and CYA
  group_by(MCS,geo) %>%
  summarise_if(is.numeric,sum) 

#'========================================================================
# Define regions ####
#'========================================================================
#'The approach that we take here is that countries that are not covered by
#'EUMOFA are covered by the EUROSTAT landings data instead. Ensuring compatability
#'between the national and NUTS level analyses requires some care however.
#'We would also like to have the NUTS regions being relevant, by removing 
#'large Hinterland areas that don't have much to do with the coast or fisheries
#'This is particularly an issue for Romania and Bulgaria. We therefore define
#'"regions", which are an amalgm of NUTS2 and national levels

#We also choose to default to EUROSTAT landings data, unless EUMOFA can provide
#sub-national resolution. Hence, we only use data from EUMOFA that gives us more
#than one NUTS region in a country. 
#Note that Norway and Sweden have already been dropped
EUMOFA.cnty <- 
  EUMOFA.reg %>% 
  ungroup() %>% 
  distinct(country,region) %>% 
  count(country) %>%
  filter(n>1)

#Manually specify the regions to include
#Not specifing will include all regions
manual.NUTS.sel <- 
  list(SI="SI04",
       RO="RO22",
       #NO=sprintf("NO%02i",2:7),  #Drop Oslo
       HR="HR03",
       BG=c("BG34","BG33")) %>%
  melt(value.name="NUTS_ID")

#Get NUTS regions for the remaining countries to be handled manually
manual.NUTS.poly <- 
  NUTS.poly %>%
  filter(!CNTR_CODE %in% EUMOFA.cnty$country,
         CNTR_CODE %in% EUROSTAT.landings$geo) %>%    #Only countries where we have landings data e.g. drop CH
  #Apply manual selections
  filter(NUTS_ID %in% manual.NUTS.sel$NUTS_ID | !CNTR_CODE %in% manual.NUTS.sel$L1) 

#Extract the NUTS - region key - save it
NUTS.reg.key <- 
  manual.NUTS.poly %>%
  as_tibble() %>%
  select(region=CNTR_CODE,NUTS_ID)

saveRDS(NUTS.reg.key,file="objects/Geodata/NUTS.reg.key.rds")

#Interactive plot for getting region names
# library(ggrepel)
# NUTS.poly %>%
#   filter(CNTR_CODE %in% c("ES"),
#          !grepl("^FRY",NUTS_ID))%>%
#   ggplot()+
#   annotation_map(map_data("world"),fill="black")+
#   geom_sf()+
#   geom_label_repel(mapping=aes(label=NUTS_ID,geometry=geometry),
#                    stat="sf_coordinates",
#                    min.segment.length = 0)+
#   geom_point(aes(geometry=geometry),col="red",stat="sf_coordinates")
#   
#Atlantic vs  med seaboards
seaboard.df <-
  list(Atl=c("FRE1","FRE2","FRD2","FRD1","FRH0","FRG0","FRI3","FRI1",
             "ES11","ES12","ES13","ES21"),
       Can="ES70",
       Med=c("FRJ1","FRJ0","FRM0",
             "ES61","ES62","ES51","ES52","ES53","ES63","ES64")) %>%
  enframe(value="region",name="seaboard") %>%
  unnest(region)

#Make a final set of regional polys for further processing
region.poly <- 
  #Merge manually selected NUTS to give regions
  manual.NUTS.poly %>%
  group_by(CNTR_CODE) %>%
  summarise() %>%
  #Merge with the other NUTS regions in EUMOFA
  select(region=CNTR_CODE)%>%
  rbind(EUMOFA.NUTS.poly) %>%
  mutate(region=as.character(region)) %>%
  #Add in seaboards
  left_join(y=seaboard.df,by="region") 

ggplot(region.poly) +
  geom_sf(aes(fill=seaboard))


saveRDS(region.poly,file="objects/Geodata/region.polys.rds")

#'========================================================================
# Merge landings data sets ####
#'========================================================================
#Countries that are not covered by EUMOFA should be covered by EUROSTAT
EUROSTAT.sel <-
  EUROSTAT.landings.geo.MCS %>%
  filter(!geo %in% EUMOFA.cnty$country) %>%
  mutate(region=geo,
         country=geo) %>%
  select(MCS,-geo,value=EUR,landings=TPW,region) %>%
  #Merge in F_CODES
  left_join(y=cnty.FAO,by="region")


#Merge
regional.landings <-
  list(EUMOFA=EUMOFA.reg,
       EUROSTAT=EUROSTAT.sel) %>%
  bind_rows(.id="src") %>%
  select(-country)


#Check mapping of areas
# plot.FAO <- 
#   FAO.poly %>%
#   filter(F_CODE %in% regional.landings$F_CODE) %>%
#   mutate(F_CODE=factor(F_CODE,levels=sample(unique(F_CODE),length(unique(F_CODE)))))
# regional.landings %>%
#   distinct(region,F_CODE) %>%
#   left_join(y=region.poly,by=c(region="NUTS_ID")) %>%
#   mutate(F_CODE=factor(F_CODE,levels=levels(plot.FAO$F_CODE))) %>%
#   ggplot()+
#   geom_sf(data=plot.FAO,aes(fill=F_CODE),show.legend = FALSE)+
#   geom_sf(aes(geometry=geometry,fill=F_CODE))+
#   geom_sf(data=filter(region.poly,LEVL_CODE==2),fill=NA)+
#   geom_sf(data=filter(region.poly,LEVL_CODE==0),fill=NA,colour="black")

saveRDS(regional.landings,file="objects/regional_metrics/regional_landings_value.rds")


#'========================================================================
# Complete ####
#'========================================================================
#Turn off the lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
