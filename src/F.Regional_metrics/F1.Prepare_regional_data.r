#'========================================================================
# F1.Prepare regional catch data
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Tue Sep 10 09:02:17 2019
#
# This script merges and harmonises data for use in calculating regional
# metrics i.e. EUMOFA data at the NUTS scale for 14/16 countries, and 
# EUROSTAT landings data at the national level for 26 countries. 
#
# A further complication is added by the fact that the approach to taxonomy is
# different between the two data sets - EUMOFA deals with species groups, while
# EUROSTAT is more species centric. This would, in principle, make a direct 
# comparison between the diversity metrics a little tricky (I'm not sure, I
# don't really know them well enough). We therefore aggregate EUROSTAT data to
# the same groups used by EUMOFA.
#
# This script creates metrics of regional exposure by first linking the 
# EUMOFA harbours to the NUTS regions. The EUMOFA data is then integrated to
# creates of exposure at the NUTS level.
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","F1.Prepare regional catch data"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3];

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)
library(sf)
library(units)
library(purrr)
library(reshape2)

#'========================================================================
# Configure ####
#'========================================================================
#Import EUMOFA
EUMOFA.dat <- readRDS("objects/EUMOFA/EUMOFA_data.rds")
MCS.ERS.key <- readRDS("objects/EUMOFA/MCS-ERS_key.rds")

#EUROSTAT data
#EUROSTAT.landings <- readRDS("objects/EUROSTAT/landings.geo.rds")
EUROSTAT.stock.catch <- readRDS("objects/EUROSTAT/catch.stock.geo.rds")

#Regional polygons
NUTS.poly <- readRDS("objects/Geodata/NUTS_regions.rds")

#'========================================================================
# Define NUTS-regions mapping ####
#'========================================================================
#'The approach that we take here is that countries that are not covered by
#'EUMOFA are covered by the EUROSTAT landings data instead. Ensuring compatability
#'between the national and NUTS level analyses requires some care however.
#'We would also like to have the NUTS regions being relevant, by removing 
#'large Hinterland areas that don't have much to do with the coast or fisheries
#'This is particularly an issue for Romania and Bulgaria. We therefore define
#'"regions", which are an amalgm of NUTS2 and national levels

#Interactive plot for getting region names
# library(ggrepel)
# NUTS.poly %>%
#   filter(CNTR_CODE %in% c("BE"),
#          !grepl("^FRY",NUTS_ID))%>%
#   ggplot()+
#   annotation_map(map_data("world"),fill="black")+
#   geom_sf()+
#   geom_label_repel(mapping=aes(label=NUTS_ID,geometry=geometry),
#                    stat="sf_coordinates",
#                    min.segment.length = 0)+
#   geom_point(aes(geometry=geometry),col="red",stat="sf_coordinates")

#We choose to default to EUROSTAT landings data, unless EUMOFA can provide
#sub-national resolution. Hence, we only use data from EUMOFA that gives us more
#than one NUTS region in a country. 
regions.use.EUMOFA <-
  EUMOFA.dat %>% 
  #Drop locations where we don't have a matchup
  filter(!is.na(CNTR_CODE)) %>%  
  #Get number of NUTS regions
  distinct(CNTR_CODE,NUTS_ID) %>%
  mutate_all(as.character) %>%
  group_by(CNTR_CODE) %>%
  mutate(n.NUTS=n()) %>%
  ungroup() %>%
  #Drop coutnries where there is no-subnational resolution
  filter(n.NUTS>1) %>%
  #Polish
  transmute(region=NUTS_ID,NUTS_ID,CNTR_CODE)

#Specify merging / subsetting of NUTS2 units into regions
regions.manual <- 
  list(BG=c("BG33","BG34"),
       BE="BE25",
       HR="HR03",
       RO="RO22",
       SI="SI04",
       TR=c("TR21","TR10","TR42","TR81","TR82","TR83","TR90",  #Black sea
            "TR22","TR31","TR32","TR41","TR61","TR62","TR63")) %>% #Med
  enframe("region","NUTS_ID") %>% 
  unnest(NUTS_ID) %>%
  #Get country associated with the NUTS region
  left_join(y=NUTS.poly) %>%
  transmute(region,NUTS_ID,CNTR_CODE=as.character(CNTR_CODE))

#Countries that are not included in EUMOFA or specified explicitly should also have their
#NUTS2 units merged into one region
regions.whole.country <-
  NUTS.poly %>%
  #Only countries that we have EUROSTAT data
  filter(CNTR_CODE %in% EUROSTAT.stock.catch$geo) %>%
  #But exclude countries where we have EUMOFA data or have specified manually
  filter(!(CNTR_CODE %in% regions.manual$CNTR_CODE),
          !CNTR_CODE %in% regions.use.EUMOFA$CNTR_CODE) %>%
  #Drop extras
  st_set_geometry(NULL) %>%
  transmute(region=as.character(CNTR_CODE),NUTS_ID,CNTR_CODE=as.character(CNTR_CODE)) %>%
  as_tibble()

#Merge these regions
NUTS.reg.key <-
  bind_rows(regions.use.EUMOFA,regions.manual,regions.whole.country)
saveRDS(NUTS.reg.key,file="objects/Geodata/NUTS.reg.key.rds")

#' #'========================================================================
#' # Define region-FCODE keys ####
#' #'========================================================================
#' #' To be able to use the EUROSTAT landings data (rather than the catch data),
#' #' we need to associate an FAO subarea with the landings of each species (to
#' #' define a stock). This is easier to do for EUMOFA data, where we have the
#' #' harbour coordinates, but here we do it manually.
#' region.FCODE.key <- 
#'   list(BG="37.4",
#'        CY="37.3",
#'        EL="37.3",
#'        FI="27.3",
#'        HR="37.2",
#'        IS="27.5",
#'        MT="37.2",
#'        NO="27.2",
#'        RO="37.4",
#'        SE="27.3",
#'        SI="37.2",
#'        TR=c("37.3","37.4"),
#'        LT="27.3",
#'        LV="27.3",
#'        EE="27.3",
#'        BE=c("27.4","27.7")) %>%
#'   enframe("region","F_CODE") 
#' stop("Need to find a way forward here")
#' #Note - we only need to define these if there is no way forward via the catch data
#' #instead. How big is the difference between landings in a coutnry vs catch by?

# Merge polygons  -----------------------------------------------------------------
#Define Atlantic vs  med seaboards
seaboard.df <-
  list(A=c("FRE1","FRE2","FRD2","FRD1","FRH0","FRG0","FRI3","FRI1",
             "ES11","ES12","ES13","ES21"),
       C="ES70",
       M=c("FRJ1","FRJ0","FRL0","FRM0",
             "ES61","ES62","ES51","ES52","ES53","ES63","ES64")) %>%
  enframe(value="region",name="seaboard") %>%
  unnest(region)

#Merge polygons
region.poly <- 
  NUTS.reg.key %>%
  inner_join(x=NUTS.poly,by="NUTS_ID") %>%
  #Merge polygons
  group_by(region) %>%
  summarise(name=first(NUTS_NAME)) %>%
  #Add in seaboards
  left_join(y=seaboard.df,by="region") %>%
  #Calculate area of polygon for reference
  mutate(area=st_area(geometry),
         area=as.numeric(set_units(area,"km^2")))

ggplot(region.poly) +
  annotation_map(map_data("world"),fill="black")+
  geom_sf(aes(fill=area)) 

saveRDS(region.poly,file="objects/Geodata/region.polys.rds")

#'========================================================================
# Merge regional catch/landings data sets ####
#'========================================================================
# Aggregate ports to NUTS regions -------------------------------------------------
EUMOFA.reg.landings <- 
  #Drop data from countries where we are using EUROSTAT in preference
  EUMOFA.dat %>%
  filter(CNTR_CODE %in% regions.use.EUMOFA$CNTR_CODE) %>%
  rename(region=NUTS_ID)%>%
  filter(!is.na(region))%>%
  #Aggregate to MCS
  group_by(region,MCS,F_CODE) %>%
  summarise(value=sum(value),
            landings=sum(landings)) %>%
  #Add country info
  mutate(country=str_extract(region,"^.{2}")) %>%
  ungroup() %>%
  #Explicity drop some countries from EUMOFA - Norway and Sweden
  filter(!country %in% c("NO","SE")) %>%
  #Tidy 
  mutate(region=as.character(region)) %>%
  rename(CNTR_CODE="country") %>%
  select(CNTR_CODE,region,MCS,F_CODE,value)

# Aggregate EUROSTAT catch to MCS taxonomy -------------------------------------
# Note that we make the heroic assumption that landings = catch. This is a
# necessary evil, but one that is largely justified, given the close correlation
# between the two anyway
EUROSTAT.catch.geo.MCS <- 
  EUROSTAT.stock.catch %>%
  #Only take countries not covered by EUMOFA
  filter(!geo %in% regions.use.EUMOFA$CNTR_CODE ) %>%
  #Merge in MCS and aggregate species into MCS bins
  left_join(y=MCS.ERS.key,by="species") %>%
  filter(!is.na(MCS)) %>%  #The NAs are generally the Fxx categories from FAO, plus RJQ and CYA
  group_by(MCS,geo,fishreg) %>%
  summarise_if(is.numeric,sum,na.rm=TRUE) %>%
  #Tidy
  select(CNTR_CODE=geo,
         region=geo,
         MCS,
         F_CODE=fishreg,
         value)
 
# Merge data ----------------------------------------------------------------------
#Merge with EUMOFA data
regional.value <-
  list(EUMOFA=EUMOFA.reg.landings,
       EUROSTAT=EUROSTAT.catch.geo.MCS) %>%
  bind_rows(.id="src")


#Check mapping of areas
# plot.FAO <-
#   FAO.poly %>%
#   filter(F_CODE %in% regional.landings$F_CODE) %>%
#   mutate(F_CODE=factor(F_CODE,levels=sample(unique(F_CODE),length(unique(F_CODE)))))
# regional.landings %>%
#   distinct(region,F_CODE) %>%
#   left_join(y=region.poly,by=c(region="NUTS_ID")) %>%
#   mutate(F_CODE=factor(F_CODE,levels=levels(plot.FAO$F_CODE))) %>%
#   ggplot()+
#   geom_sf(data=plot.FAO,aes(fill=F_CODE),show.legend = FALSE)+
#   geom_sf(aes(geometry=geometry,fill=F_CODE))+
#   geom_sf(data=filter(region.poly,LEVL_CODE==2),fill=NA)+
#   geom_sf(data=filter(region.poly,LEVL_CODE==0),fill=NA,colour="black")

saveRDS(regional.value,file="objects/regional_metrics/regional_value.rds")


#'========================================================================
# Complete ####
#'========================================================================
#Turn off the lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
