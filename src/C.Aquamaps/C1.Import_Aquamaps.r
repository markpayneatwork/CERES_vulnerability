#'========================================================================
# A5.Import_Aquamaps
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Mon Aug 19 09:24:38 2019
#
# Imports data from Aquamaps
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","A5.Import_Aquamaps"))
cat(sprintf("Analysis performed %s\n\n",base::date()))

#Do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)

#'========================================================================
# Configure ####
#'========================================================================
src.dir <- "data/Aquamaps/maps"

#'========================================================================
# Setup ####
#'========================================================================
#Get list of files
fnames <- dir(src.dir,full.names=TRUE,pattern="*.csv")

#Write a PDF of the maps as well
#pdf(file="plots/Aquamaps.pdf",paper="A4")

#'========================================================================
# Import ####
#'========================================================================
res <- list()
pb <- progress_estimated(length(fnames))
pb$print()
for(f in fnames) {
  #Read contents and find markers
  l <- readLines(f,encoding="latin1")
  map.start.idxs <- grep("Genus,Species",l)
  stopifnot(length(map.start.idxs)==2)
  env.start.idx <- grep("Species Envelope \\(HSPEN\\)",l)
  occurrence.start.idx <- grep("Occurrence cells",l)
  
  #Create a data structure to store the results
  d <- list()
  
  #Extract names
  d$scientific.name <- str_match(l[1],"^Mapping parameters for (.+) \\((.+)\\).*$")[,2]
  d$common.name <- str_match(l[1],"^Mapping parameters for (.+) \\((.+)\\).*$")[,3]
  
  #Extract metadata
  meta <- tibble(str=l[4:(env.start.idx-1)]) %>%
          separate(str,c("x","value"),sep=":") %>%
          filter(!is.na(x),!is.na(value)) %>%
          mutate(x=gsub(pattern=" ",replacement="_",x))
  d[meta$x] <- meta$value
  
  #Extract envelope
  d$envelope <- 
    read.csv(text=l[(env.start.idx+1):(map.start.idxs[1]-1)]) %>% 
    as_tibble()
          
  
  #Extract map
  d$map <-
    read.csv(text=l[(map.start.idxs[1]):(occurrence.start.idx-1)]) %>%
    as_tibble()
          
  #Plot for good measure

    
  #Store results
  res[[basename(f)]] <- d
  
  pb$tick()$print()
}
pb$stop()$print()

#Save imported files
saveRDS(res,file="objects/Aquamaps/Aquamaps.rds")

#'========================================================================
# Extract Aquamaps metadata ####
#'========================================================================
aquamaps.meta <- 
  #Extract data from list
  purrr::map(res,function(.x) {
    c(.x[c("scientific.name","common.name","Map_type","Pelagic",
           "Layer_used_to_generate_probabilities")],
      Temp=.x$envelope[grepl("^Temperature",.x$envelope$X),],
      Depth=.x$envelope[grepl("^Depth",.x$envelope$X),])}) %>%
  purrr::map(as_tibble) %>%
  bind_rows(.id="fname") %>%
  #Polish
  rename(Layer=Layer_used_to_generate_probabilities) %>%
  mutate_at(c("Pelagic","Layer","Map_type"),
            function(x) gsub("^ |[,.]","",x)) %>%
  mutate(Pelagic=as.logical(Pelagic))


saveRDS(aquamaps.meta,file="objects/Aquamaps/Aquamaps_meta.rds")


#'========================================================================
# Complete ####
#'========================================================================
#Turn off the lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
