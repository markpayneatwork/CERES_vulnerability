#/*##########################################################################*/
#' Comparison of ICES and EUROSTAT statistics
#' ==========================================================================
#'
#' by Mark R Payne  
#' DTU-Aqua, Charlottenlund, Denmark  
#' http://www.staff.dtu.dk/mpay  
#'
#' Wed Feb 22 15:42:30 2017
#'
#' Compares the landings statistics for ICES and EUROSTAT data sources to make sure
#' that they are vaguely similar. In particular, I am worried about data sources
#' from outside FAO27, which could in theory be in the EUROSTAT data, but shouldn't
#' be in the ICES data.
#' 
#' Produces a final set of weightings by combining these two data sets
#
#  This work is subject to a Creative Commons "Attribution" "ShareALike" License.
#  You are largely free to do what you like with it, so long as you "attribute" 
#  me for my contribution. See the fine print at the end for exact details.
#
#  To do:
#
#  Notes:
# - While this script contains reminants of RMarkdown, it is not in a state
#    where it can be compiled in a meaningful manner
#/*##########################################################################*/

#/*======================================================================*/
#  Initialise system
#/*======================================================================*/
cat(sprintf("\n%s\n","Compare EUROSTAT and ICES landings"))
cat(sprintf("Analysis performed %s\n\n",base::date()))

#Configure markdown style, do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
                              flush.console();return(invisible(NULL))}
#library()

library(ggplot2)
library(reshape2)

#/*======================================================================*/
#  Configuration
#/*======================================================================*/
#Load data sets
load("objects/EUROSTAT_data.RData")
load("objects/ICES_data.RData")

#/*======================================================================*/
#' Merge data sets
#/*======================================================================*/
#Melt
EUROSTAT.m <- melt(EUROSTAT.landings.species.geo,id.vars = c("species","geo.time"),
                   variable.name = "year",na.rm = TRUE)
ICES.m <- melt(ICEScatch.species.geo,id.vars = c("Species","Country"),
               variable.name="year",na.rm=TRUE)

#The mega merge
dat <- merge(ICES.m,EUROSTAT.m,
             by.x=c("Species","Country","year"),
             by.y=c("species","geo.time","year"),
             suffixes=c(".ICES",".EUROSTAT"))

#Setup for plotting
lod.log <- function(x) {ifelse(x==0,0.1,log10(x))}
dat$value.ICES.log10 <- lod.log(dat$value.ICES)
dat$value.EUROSTAT.log10 <- lod.log(dat$value.EUROSTAT)
dat$log10.ratio <- dat$value.ICES.log10 -dat$value.EUROSTAT.log10

#Visualise
plot(value.ICES.log10 ~ value.EUROSTAT.log10,dat)
hist(dat$log10.ratio,breaks=1000)

#Are there some countries that are worse hit by the discrepancy than others?
ggplot(dat)+geom_histogram(aes(log10.ratio),bins=250)+
  facet_wrap(~Country,scale="free_y")

ggplot(dat)+geom_histogram(aes(log10.ratio),bins=250)+
  facet_wrap(~year,scale="free_y")

#I have to admit, I'm at a bit of a loss to explain the differences. It's probably
#safest to go for the ICES data to start with, as we know where it comes from
#and then use the EUROSTAT data for prices only (???). That is the approach that
#we take to produce the weightings

#/*======================================================================*/
#  Produce weightings
#  These are the relative contribution of each species to the value of
#  all fish products landed in that country, averaged over the period
#  common to both the ICES and EUROSTAT data. We trust ICES for landings
#  but EUROSTAT for prices per tonne, then combine the two to estimate the
#  value of landings by species in that country, and then normalise to 
#  give a weighting factor for further use. Similarly, we also calculate 
#  an area-based weighting i.e. where the value of the fisheries landings
#  for a particularl country comes from
#/*======================================================================*/
#First, identify the years common to both data sets
EUROSTAT.yrs <- grep("^X[0-9]{4}$",colnames(EUROSTAT.price.species),value = TRUE)
ICES.yrs <- grep("^X[0-9]{4}$",colnames(ICEScatch.species.geo),value = TRUE)
common.yrs <- intersect(EUROSTAT.yrs,ICES.yrs)
n.common <- length(common.yrs)

#Calculate the median price per tonne of each species over the common yrs
price.species.dat <- EUROSTAT.price.species[,c("species",common.yrs)]
price.species.dat$median.price <- apply(price.species.dat[,common.yrs],
                                        1,median,na.rm=TRUE)
price.species <- price.species.dat
price.species[,common.yrs] <- NULL

#Now calculate the value of landings based on ICES data
landings.m <- ICEScatch.species.geo
landings.m$annual.mean <- NULL   #Recalculate using common years
landings.m$mean.landings <- rowSums(landings.m[,common.yrs],na.rm = TRUE)/n.common
landings.m[,common.yrs] <- NULL
landings <- merge(landings.m, price.species,
                  by.x="Species",by.y = "species")
landings$value <- landings$mean.landings*landings$median.price
landings.geo <- tapply(landings$value,landings[,"Country"],sum,na.rm=TRUE)
landings$national.total <- landings.geo[landings$Country]
landings$value.proportion <- landings$value/landings$national.total

#Ready for output
landings.prop <- landings[,c("Species","Country","value.proportion")]
save(landings.prop,file="objects/proportion_of_landed_value.RData")

#/*======================================================================*/
#  Complete
#/*======================================================================*/
#+ results='asis'
#Turn off thte lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

#' -----------
#' <small>*This work by Mark R Payne is licensed under a  Creative Commons
#' Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
#' For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
#' Basically, this means that you are free to "share" and "remix" for 
#' non-commerical purposes as you see fit, so long as you "attribute" me for my
#' contribution. Derivatives can be distributed under the same or 
#' similar license.*</small>
#'
#' <small>*This work comes with ABSOLUTELY NO WARRANTY or support.*</small>
#'
#' <small>*This work should also be considered as BEER-WARE. For details, see
#' http://en.wikipedia.org/wiki/Beerware*</small>
#' 
#' -----------
