#'========================================================================
# A7.Import_trait_data
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Mon Aug 19 13:48:38 2019
#
# Imports the trait data for defining species adaptive capacity from the 
# various sources, and then constrains the species list further. This is a loose
# reimplementation of Manja's Species_traits.R code.
#
# Note that the species included here were originally selected based on the criteria
# that they must cover the top 90% of catches in each country for which we have
# data, extracted using the script in B2. Manja then refined this further by
# excluding grouped species and those for which we have no Aquamaps or similar.
# This script then ends up being the original definition of the species list, even if
# it is inspired by other scripts elsewhere.
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","Import_trait_data"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3] 

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)

#'========================================================================
# Configure ####
#'========================================================================
#Manja's raw traitbase (essentially untouched)
manja.dat <- read_csv2("data/Traits/Manja/compare metrics.csv")

#Alternative scientific names and bucket categories
alt.names <- read_csv2("data/Taxonomic_issues/alternative_names.csv",comment="#") %>%
             select(FAO_3A_code,Alt.sci.name)
bucket.categories <- read_csv2("data/Taxonomic_issues/bucket_categories.csv") %>%
              select(FAO_3A_code,exemplar.FAO27="Area 27",exemplar.FAO37="Area 37")

#'========================================================================
# Setup ####
#'========================================================================
#Check for correct import
stop_for_problems(manja.dat)
stop_for_problems(alt.names)
stop_for_problems(bucket.categories)

#'========================================================================
# Filter Manjas data ####
# Apply the same constraints that Manja applied
#'========================================================================
#'
#'Group selection ------------------------------------------
trait.db <- 
  # Remove all groups that are of a higher order than genus except caproidae (BOR)
  manja.dat %>%
  mutate(n.xx.in.TAXOCODE=str_count(TAXOCODE,"X")) %>%
  filter((!n.xx.in.TAXOCODE>2) | (FAO_3A_code=="BOR")) %>%
  # Remove some specific species 
  #FPE - European Perch - Freshwater species
  #FPP - Pike-perch - Freshwater species
  #PCB - Barnacle - No Aquamap
  #RAZ  - Solen razor clams nei - no Aquamap
  filter(!FAO_3A_code %in% c("FPE","FPP","PCB","RAZ")) %>%
  #Some simple renaming as well
  rename(migratory.cat=mobility.fishbase)

#' Trait modification -----------------------------------------------------
trait.db <-
  trait.db %>%
  #Set mobility for SPI, SOS
  mutate(Mobility=replace(Mobility,FAO_3A_code%in%c("SPI","SOS"),"Mobile")) %>%
  #All benethic species are demersal
  mutate(vertical.habitat=ifelse(vertical.habitat=="Benthic","Demersal",vertical.habitat))

#' Lifespan corrections-------------------------
lifespan.correct <- readRDS("data/Traits/Manja/Manual_lifespan_edits.rds")
trait.db <- 
  select(lifespan.correct,FAO_3A_code,correct.Lifespan.n=Lifespan.n) %>%
  left_join(x=trait.db,by="FAO_3A_code") %>%
  mutate(Lifespan.n=ifelse(is.na(Lifespan.n),correct.Lifespan.n,Lifespan.n)) %>%
  #Set NAs to zero
  mutate(Lifespan.n=ifelse(is.na(Lifespan.n),0,Lifespan.n))

#' Handle bucket categories and inconsistent naming--------------------------
trait.db <- 
  trait.db %>%
  left_join(y=bucket.categories,by="FAO_3A_code") %>%
  left_join(y=alt.names,by="FAO_3A_code") %>%
  mutate(is.bucket=n.xx.in.TAXOCODE>=2,
         use.this.name=ifelse(is.na(Alt.sci.name),Scientific_name,Alt.sci.name),
         exemplar.FAO27=ifelse(is.bucket,exemplar.FAO27,use.this.name),
         exemplar.FAO37=ifelse(is.bucket,exemplar.FAO37,use.this.name))

# Save species db -----------------------------------------------------------------
species.db <- 
  trait.db %>%
  select(FAO_3A_code,Scientific_name,FAO_EN,exemplar.FAO27,exemplar.FAO37)
saveRDS(species.db,file="objects/species_database.rds")  


#'========================================================================
# Convert to adaptive capacity scores ####
#'========================================================================

#Habitat scoring ------------------------------------------------------
#Apply the habitat scoring in the form of a subsetting loop
scored.db <- 
  mutate(trait.db,
         hab.score=2, #Default
         hab.score=ifelse(horizontal.habitat=="Oceanic",1,hab.score),
         hab.score=ifelse(Mobility=="Highly migratory",1,hab.score),
         hab.score=ifelse(Mobility=="Mobile" &
                            vertical.habitat=="Bathydemersal" &
                            horizontal.habitat=="Slope",1,hab.score),
         hab.score=ifelse(Mobility=="Mobile" &
                            vertical.habitat=="Mesopelagic" &
                            horizontal.habitat=="Slope",1,hab.score),
         hab.score=ifelse(Mobility=="Sedentary" &
                            horizontal.habitat=="Coastal",4,hab.score),
         hab.score=ifelse(Mobility=="Sedentary" &
                            vertical.habitat=="Demersal",4,hab.score),
         hab.score=ifelse(vertical.habitat=="Reef-associated",4,hab.score),
         hab.score=ifelse(migratory.cat %in% c("Catadromous","Anadromous"),3,hab.score),
         hab.score=ifelse(horizontal.habitat=="Inner shelf" &
                            vertical.habitat=="Demersal",3,hab.score),
         hab.score=ifelse(horizontal.habitat=="Inner shelf" &
                            vertical.habitat=="Benthopelagic",3,hab.score),
         hab.score=ifelse(horizontal.habitat=="Coastal" &
                            vertical.habitat=="Benthopelagic",3,hab.score)) %>%
  #Rescale
  mutate(hab.score=(hab.score-1)/3)

# Lifespan scoring ------------------------------------------
# Cut into percentiles - not used anymore. Just use lifespans directly
scored.db <-
  mutate(scored.db,
         #ls.perc=(rank(Lifespan.n)-0.5)/nrow(scored.db),
         #ls.score=as.numeric(cut(ls.perc,breaks=c(0,0.25,0.5,0.75,1))),
         #ls.score=as.numeric(cut(Lifespan.n,c(-Inf,fivenum(Lifespan.n)[2:5]))),
         ls.score=percent_rank(Lifespan.n)) #Will be converted to rankings when combining

#'========================================================================
# Output ####
#'========================================================================
trait.db <- 
  scored.db %>%
  select(FAO_3A_code,
         FAO_EN,horizontal.habitat,
         vertical.habitat,
         migratory.cat,
         Mobility,
         lifespan=Lifespan.n,
         lifespan.score=ls.score,
         habitat.score=hab.score)

write_csv(trait.db,"outputs/trait_database.csv")
saveRDS(trait.db,"objects/trait_database.rds") #TODO: Include in manuscript

out.db <-
  trait.db %>%
  select(FAO_3A_code,FAO_EN,lifespan.score,habitat.score) 
saveRDS(out.db,file="objects/biological_metrics/species_metrics.rds")

#Turn off the lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or# Remove all groups that are of a higher order than genus except caproidae

# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
