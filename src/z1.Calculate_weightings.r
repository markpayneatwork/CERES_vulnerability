#/*##########################################################################*/
#' Calculate weighting factors
#' ==========================================================================
#'
#' by Mark R Payne  
#' DTU-Aqua, Charlottenlund, Denmark  
#' http://www.staff.dtu.dk/mpay  
#'
#' Wed Feb 22 15:42:30 2017
#'
#' Produces a final set of weightings by combining the data sets
#
#  This work is subject to a Creative Commons "Attribution" "ShareALike" License.
#  You are largely free to do what you like with it, so long as you "attribute" 
#  me for my contribution. See the fine print at the end for exact details.
#
#  To do:
#
#  Notes:
# - While this script contains reminants of RMarkdown, it is not in a state
#    where it can be compiled in a meaningful manner
#/*##########################################################################*/

#/*======================================================================*/
#  Initialise system
#/*======================================================================*/
cat(sprintf("\n%s\n","Calculate weighting factors"))
cat(sprintf("Analysis performed %s\n\n",base::date()))

#Configure markdown style, do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
                              flush.console();return(invisible(NULL))}
#library()

library(stringr)
library(reshape2)
library(tidyverse)

#/*======================================================================*/
#  Configuration
#/*======================================================================*/
#Load data sets
load("objects/EUROSTAT_data.RData")
load("objects/ICES_data.RData")
load("objects/LHS_strategies.RData")

#/*======================================================================*/
#  Produce national weightings by species
#  These are the relative contribution of each species to the value of
#  all fish products landed in that country, averaged over the period
#  common to both the ICES and EUROSTAT data. We trust ICES for landings
#  but EUROSTAT for prices per tonne, then combine the two to estimate the
#  value of landings by species in that country, and then normalise to 
#  give a weighting factor for further use. 
#  Normalisation is only done over the species where we have life-history
#  data though, to make sure that everything lines up correctly.
#/*======================================================================*/
#First, identify the years common to both data sets
EUROSTAT.yrs <- grep("^X[0-9]{4}$",colnames(EUROSTAT.price.species),value = TRUE)
ICES.yrs <- grep("^X[0-9]{4}$",colnames(ICEScatch.species.geo),value = TRUE)
common.yrs <- intersect(EUROSTAT.yrs,ICES.yrs)
n.common <- length(common.yrs)

#Calculate the median price per tonne of each species over the common yrs
price.species.dat <- EUROSTAT.price.species[,c("species",common.yrs)]
price.species.dat$median.price <- apply(price.species.dat[,common.yrs],
                                        1,median,na.rm=TRUE)
price.species <- price.species.dat %>%
                  as.tibble() %>%
                  transmute(Species=species,median.price)

#Now focus on the ICES landings data that is relevant
landings.m <- ICEScatch.species.geo
landings.m$annual.mean <- NULL   #Recalculate using common years
landings.m$mean.landings <- rowSums(landings.m[,common.yrs],na.rm = TRUE)/n.common
landings.m[,common.yrs] <- NULL
landings.focus <- landings.m %>%
  as.tibble() %>%
  subset(Species %in% LHS.dat$FAO_code)  #Drop species that are not focal species

#Calcuate the value of the landings
landings.value <- landings.focus %>%  #Merge in price data
                  left_join(price.species,by="Species") %>%
                  mutate(value=mean.landings*median.price)
landings.value.geo <- tapply(landings.value$value,landings.value[,"Country"],sum,na.rm=TRUE)
landings.value <- landings.value %>% 
                  mutate(national.total=landings.value.geo[as.character(landings.value$Country)],
                         propval=value/national.total)


#Get ready for output
#Do some tidying, then drop species / country combinations where there is no data
propval.species.country <- landings.value %>% 
                            subset(!is.na(propval))

#/*======================================================================*/
#  Produce species weightings by catch area
#  These are the relative distributions of the species across each FAO area
#  as judged by the landings proportions in that area. Not perfect, but
#  a relatively useful proxy for the large scales that we are dealing with.
#/*======================================================================*/
#First identify the FAO areas in question. 
ICES.areas <- data.frame(area=unique(ICEScatch.area.geo.yr$Area))
ICES.areas$hier.level <- str_count(ICES.areas$area,"\\.|_")
ICES.areas <- ICES.areas[order(ICES.areas$hier.level),]
ICES.areas.sel <- subset(ICES.areas,hier.level==1 & !grepl("_NK",area)) #FAO Subareas

#Extract out the data by area and common year, then sum over landings
#to get the landings per area
sp.dat <- subset(ICEScatch.area.geo.yr,Area %in% ICES.areas.sel$area &
                   year %in% common.yrs)
landings.area.species <- tapply(sp.dat$landings,sp.dat[,c("Species","Area")],sum)

#Now normalise to get proportions
landings.area.species[is.na(landings.area.species)] <- 0
landings.species <- rowSums(landings.area.species)
landings.area.species.prop <- sweep(landings.area.species,1,1/landings.species,"*")
propland.area.species <- melt(landings.area.species.prop[landings.species!=0,],
                              as.is=TRUE,value.name="propland")

#/*======================================================================*/
#  Complete
#/*======================================================================*/
save(propval.species.country,propland.area.species,
     file="objects/proportion_of_landed_value.RData")

#Turn off thte lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

#' -----------
#' <small>*This work by Mark R Payne is licensed under a  Creative Commons
#' Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
#' For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
#' Basically, this means that you are free to "share" and "remix" for 
#' non-commerical purposes as you see fit, so long as you "attribute" me for my
#' contribution. Derivatives can be distributed under the same or 
#' similar license.*</small>
#'
#' <small>*This work comes with ABSOLUTELY NO WARRANTY or support.*</small>
#'
#' <small>*This work should also be considered as BEER-WARE. For details, see
#' http://en.wikipedia.org/wiki/Beerware*</small>
#' 
#' -----------
