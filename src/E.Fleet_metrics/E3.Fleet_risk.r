#'========================================================================
# E3.Fleet_risk
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Wed Sep 11 11:59:57 2019
#
# Combines all the metrics together to get the total risk per fleet
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","E3.Fleet_risk"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3];

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)
library(here)
library(matrixStats)

#'========================================================================
# Configure ####
#'========================================================================
#Metrics
flt.exp <-readRDS("objects/fleet_metrics/Fleet_exposure.rds") 
flt.vul <- readRDS("objects/fleet_metrics/Fleet_vulnerability.rds")
stk.haz <- readRDS("objects/biological_metrics/stock_hazard.rds") 

#Lookup key
fleet.catch.dat <- readRDS("objects/catch/STECF_catch_data.rds")  
cnty.3A2A.codes <- readRDS(here("objects/Geodata/country_3A_2A_codes.rds"))

#'========================================================================
# Hazard per fleet ####
#'========================================================================
#Generate lookup key for the stocks
#Value of catches by fleet segement, stock
val.fs.stk <- 
  fleet.catch.dat %>%
  unite("stock.code",species_code,F_SUBAREA) %>%
  #Calculate total value of landings for each fleet
  group_by(fs_name) %>%
  mutate(total.val.landings=sum(value)) %>%
  #Drop empty fleets
  filter(!is.na(fs_name))


#Calculate hazard per fleet
flt.haz <- 
  stk.haz %>%
  unite("stock.code",FAO_3A_code,F_CODE) %>% #Create stock code
  select(stock.code,hazard) %>%
  #Merge into fleet information
  left_join(x=val.fs.stk,by="stock.code") %>%
  #Drop stocks where we don't have coverage
  filter(!is.na(hazard)) %>%
  #Calculate importance (weighting) of each stock for each fleet
  group_by(fs_name) %>%
  mutate(prop.val.from.stk=value/sum(value)) %>%
  #Integrate
  summarize(value.covered=sum(value),
            total.val.landings=unique(total.val.landings),
            prop.missing=1-value.covered/total.val.landings,
            hazard=weightedMedian(hazard,prop.val.from.stk))             

saveRDS(flt.haz,file="objects/fleet_metrics/Fleet_hazard.rds")

#Check partially covered fleets
ggplot(flt.haz,aes(x=prop.missing))+
  geom_histogram(aes(y=..ndensity..))+
  stat_ecdf()

ggplot(flt.haz,aes(x=total.val.landings,y=value.covered))+
  geom_point()+
  scale_x_log10()+scale_y_log10()
  
#'========================================================================
# Risk per fleet ####
#'========================================================================
#Merge the three into a single data frame
flt.risk <- 
  flt.haz %>%
  left_join(y=flt.exp,by="fs_name") %>%
  left_join(y=flt.vul,by="fs_name") %>%
  select(fs_name,total.val.landings,prop.missing,hazard,exposure,vulnerability) %>%
  mutate(hazard=percent_rank(hazard),
         exposure=percent_rank(exposure),
         vulnerability=percent_rank(vulnerability),
         risk=percent_rank((hazard+exposure+vulnerability)))

#TODO: Handle fleets that have poor coverage by value

#Some tidying for further downstream useage
flt.risk <- 
  flt.risk %>%
  tidyr::extract(fs_name,
               into=c("country","area","gear","length","geo"),
               "^(.+?) (.+?) ([:alpha:]{1,3})([:alnum:]{4}) *(.*)$",
               remove=FALSE) %>%
  left_join(y=cnty.3A2A.codes,by=c("country"="country_3A")) 
  


#'========================================================================
# Complete ####
#'========================================================================
saveRDS(flt.risk,file="objects/fleet_metrics/Fleet_risk.rds")

#Turn off the lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
