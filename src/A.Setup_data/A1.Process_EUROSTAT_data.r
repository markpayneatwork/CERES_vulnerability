#/*##########################################################################*/
#' Process EUROSTAT data
#' ==========================================================================
#'
#' by Mark R Payne  
#' DTU-Aqua, Charlottenlund, Denmark  
#' http://www.staff.dtu.dk/mpay  
#'
#' Tue Feb 21 15:13:13 2017
#'
#' Processes statistics by country from EUROSTAT, downloaded from here
#' http://ec.europa.eu/eurostat/web/fisheries/data/database
#' The goal is to estimate 
#' * the value of landings per country 
#' * catch by species from each FAO area
#'
#' As the two data sets are coming from the same database, they have a very
#' similar structure, and we can therefore avoid duplication by handling them
#' both at once. 
#' 
#' There is unfortunately no formal metadata document to describe this, so I've
#' had to work it out from the data explorer (see above link) provided by
#' Eurostat instead. The headers go like this
#'    * pres - Presentation form e.g. frozen, dried, fresh etc
#'    * dest_use - Destination - human consumption or industrial fisheries
#'    * natvessr - nationality of vessel registration
#'    * species - Fxx codes correspond to classes. Otherwise a three letter code
#'      corresponding to the species
#'    * Unit - Euro, Euro per tonne (Eur_T), Tonnes product weight
#'    * geo - geographical area, including EU27, EU15 and EU28. Note that Iceland 
#'      and Norway are included here 
#
#  This work is subject to a Creative Commons "Attribution" "ShareALike" License.
#  You are largely free to do what you like with it, so long as you "attribute" 
#  me for my contribution. See the fine print at the end for exact details.
#
#  To do:
#
#  Notes:
# - While this script contains reminants of RMarkdown, it is not in a state
#    where it can be compiled in a meaningful manner
#/*##########################################################################*/

#/*======================================================================*/
#  Initialise system
#/*======================================================================*/
cat(sprintf("\n%s\n","Process EUROSTAT data"))
cat(sprintf("Analysis performed %s\n\n",base::date()))

#Configure markdown style, do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
                              flush.console();return(invisible(NULL))}

library(stringr)
library(tidyverse)
library(eurostat)
library(purrr)
library(lubridate)

#/*======================================================================*/
#  Configuration
#/*======================================================================*/
#Data sources
sel.yrs <- 2015:2016
geo.exclude <- c("EU15","EU27","EU28")
catch.data.ids <- c("fish_ca_atl21","fish_ca_atl27","fish_ca_atl34","fish_ca_atl37")

#'========================================================================
# Average price per species ####
#'========================================================================
#' Note that we could just use the EUR_T (Euro per tonne) field
#' directly from the EUROSTAT landings data
#' but calculating it manually has the effect of weighting it
#' by the size of the catch as well, which is desirable

#Download
fish.ld.main <-
  get_eurostat("fish_ld_main") %>%
  mutate(year=year(time)) %>%
  #Drop FAO group data immediately
  filter(!grepl("F[[:digit:]]{2}",species))

#Polish
sp.geo.price <- 
  fish.ld.main %>%
  filter(year %in% sel.yrs,
         pres=="TOTAL",
         dest_use=="TOTAL",
         natvessr=="TOTAL",
         !(geo %in% geo.exclude)) %>%
  select(-pres,-natvessr,-dest_use) %>%
  group_by(species,unit,geo,.drop=TRUE) %>%
  summarise(total=sum(values)) %>%  #Note - summing over years as well
  spread(unit,total) %>%
  mutate(mean.price=EUR/TPW) %>%
  select(-EUR_T,-EUR,-TPW) %>%
  ungroup()
saveRDS(sp.geo.price,file="objects/EUROSTAT/species_price.rds")

#/*======================================================================*/
#  Value of landings per country per species
#/*======================================================================*/
val.sp.geo <- 
  fish.ld.main %>%
  filter(year %in% sel.yrs,
         unit=="EUR",
         pres=="TOTAL",
         natvessr=="TOTAL",
         dest_use=="TOTAL",
         !(geo %in% c("EU15","EU27","EU28"))) %>%
  select(-c(pres,natvessr,dest_use,unit)) %>%
  #Average over years
  group_by(species,geo) %>%
  summarise(value=sum(values)/length(sel.yrs)) %>%
  ungroup()
saveRDS(val.sp.geo,file="objects/EUROSTAT/value.species.country.rds")

#'========================================================================
# Catches by stock (sp x FAO area) ####
#'========================================================================
#Download catch data
catch.datasets <-  
  search_eurostat("Catch") 
catch.dat <- 
  map(catch.data.ids,get_eurostat) %>%
  bind_rows() %>%
  #Drop FAO group data immediately
  filter(!grepl("F[[:digit:]]{2}",species))


# #Catch overview
# catch.overview <-
#   get_eurostat("fish_ca_main") %>%
#   mutate(year=year(time)) %>%
#   group_by(fishreg,year) %>%
#   summarise(sum.catch=sum(values))
# 
# ggplot(catch.overview,aes(x=year,y=sum.catch,colour=fishreg))+
#   geom_line()

catch.stock.geo <- 
  catch.dat %>%
  mutate(year=year(time)) %>%
  filter(unit=="TLW",
         year %in% sel.yrs,
         !(geo %in% c("EU15","EU27","EU28"))) %>%
  #Retain subareas only
  mutate(is.subarea=grepl("^[0-9]{2}_[0-9]+$",fishreg)) %>%
  filter(is.subarea) %>%
  mutate(fishreg=gsub("_",".",fishreg)) %>% #Use dots as separator
  select(-is.subarea,-unit) %>%
  #Average over years
  group_by(species,fishreg,geo) %>%
  summarise(catch=sum(values)/length(sel.yrs)) %>%
  ungroup()
saveRDS(catch.stock.geo,file="objects/EUROSTAT/catch.stock.geo.rds")

#Aggregate across countries
catch.stock <-
  catch.stock.geo %>%
  group_by(species,fishreg) %>%
  summarise(catch=sum(catch))
saveRDS(catch.stock,file="objects/EUROSTAT/catch.stock.rds")

#'========================================================================
# Landings data ####
#'========================================================================
#Get list of data sets
landings.datasets <-  
  search_eurostat("Landings") %>%
  filter(code!="fish_ld_main")

#Download and combine
landings.dat <- 
  map(landings.datasets$code,get_eurostat) %>%
  bind_rows() %>%
  mutate(year=year(time)) %>%
  #Drop FAO group data immediately
  filter(!grepl("F[[:digit:]]{2}",species))


#Select and average
landings.sel <-
  landings.dat %>%
  filter(pres=="TOTAL",
         dest_use=="TOTAL",
         !is.na(values)) %>%
  select(-pres,-dest_use) %>%
  filter(year %in% sel.yrs) %>%
  group_by(species,unit,geo,natvessr) %>%
  summarise(value=sum(values)/length(sel.yrs)) %>%
  ungroup()

saveRDS(landings.sel,file.path("objects/EUROSTAT/landings.geo.rds"))

#'========================================================================
# Visualisations of coverage ####
#'========================================================================
#Visualisation of landings coverage
landings.dat %>%
  count(year,geo) %>%
  mutate(geo=factor(geo) %>% fct_rev()) %>%
  group_by(geo) %>%
  mutate(prop.max=n/max(n)) %>%
  ungroup() %>%
  filter(n!=0) %>%
  ggplot(aes(x=year,y=geo,fill=prop.max))+
  geom_raster()+
  scale_fill_viridis_c()+
  geom_vline(xintercept=sel.yrs,linetype=3)

#/*======================================================================*/
#  Complete
#/*======================================================================*/

#Turn off thte lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

#' -----------
#' <small>*This work by Mark R Payne is licensed under a  Creative Commons
#' Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
#' For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
#' Basically, this means that you are free to "share" and "remix" for 
#' non-commerical purposes as you see fit, so long as you "attribute" me for my
#' contribution. Derivatives can be distributed under the same or 
#' similar license.*</small>
#'
#' <small>*This work comes with ABSOLUTELY NO WARRANTY or support.*</small>
#'
#' <small>*This work should also be considered as BEER-WARE. For details, see
#' http://en.wikipedia.org/wiki/Beerware*</small>
#' 
#' -----------
