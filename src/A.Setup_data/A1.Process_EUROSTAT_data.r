#/*##########################################################################*/
#' Process EUROSTAT data
#' ==========================================================================
#'
#' by Mark R Payne  
#' DTU-Aqua, Charlottenlund, Denmark  
#' http://www.staff.dtu.dk/mpay  
#'
#' Tue Feb 21 15:13:13 2017
#'
#' Processes statistics by country from EUROSTAT, downloaded from here
#' http://ec.europa.eu/eurostat/web/fisheries/data/database
#' The goal is to estimate 
#' * the value of landings per country 
#' * catch by species from each FAO area
#'
#' As the two data sets are coming from the same database, they have a very
#' similar structure, and we can therefore avoid duplication by handling them
#' both at once. 
#' 
#' There is unfortunately no formal metadata document to describe this, so I've
#' had to work it out from the data explorer (see above link) provided by
#' Eurostat instead. The headers go like this
#'    * pres - Presentation form e.g. frozen, dried, fresh etc
#'    * dest_use - Destination - human consumption or industrial fisheries
#'    * natvessr - nationality of vessel registration
#'    * species - Fxx codes correspond to classes. Otherwise a three letter code
#'      corresponding to the species
#'    * Unit - Euro, Euro per tonne (Eur_T), Tonnes product weight
#'    * geo - geographical area, including EU27, EU15 and EU28. Note that Iceland 
#'      and Norway are included here 
#
#  This work is subject to a Creative Commons "Attribution" "ShareALike" License.
#  You are largely free to do what you like with it, so long as you "attribute" 
#  me for my contribution. See the fine print at the end for exact details.
#
#  To do:
#
#  Notes:
# - While this script contains reminants of RMarkdown, it is not in a state
#    where it can be compiled in a meaningful manner
#/*##########################################################################*/

#/*======================================================================*/
#  Initialise system
#/*======================================================================*/
cat(sprintf("\n%s\n","Process EUROSTAT data"))
cat(sprintf("Analysis performed %s\n\n",base::date()))

#Configure markdown style, do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
                              flush.console();return(invisible(NULL))}

library(stringr)
library(tidyverse)

#/*======================================================================*/
#  Configuration
#/*======================================================================*/
#Data sources
src.fnames <- list(value.species.geo="data/EUROSTAT/fish_ld_main.tsv.gz",
                   catch.stock=dir("data/EUROSTAT/",pattern="fish_ca.*",full.names = TRUE))
sel.yrs <- as.character(2015:2018)
geo.exclude <- c("EU15","EU27","EU28")

#/*======================================================================*/
#'## Parse data
#/*======================================================================*/
#Loop over data types
dat.l <- list()
for(n in names(src.fnames)) {
  #Import data
  log.msg("Import data...\n")
  d.l <- lapply(src.fnames[[n]],function(f) {
    dat.in <- read_tsv(gzfile(f)) 
    # hdr <- colnames(dat.in)[1] %>% 
    #   gsub(pattern="(.*)\\\\.*$",replacement="\\1") %>%
    #   str_split(",",simplify=TRUE) 
    # res <- separate(dat.in,1,hdr,sep=",")
    return(dat.in)
  })
  dat.all <- bind_rows(d.l)
  
  #Get header
  hdr <- 
    colnames(dat.all)[1] %>%
    gsub(pattern="(.*)\\\\.*$",replacement="\\1") %>%
    str_split(",",simplify=TRUE)
  

  #Perform data polish and selection
  dat <-
    dat.all %>%
    gather("year","value",-1) %>%
    #Handle text to string
    rename(value.raw=value) %>%
    mutate(value=replace(value.raw,grepl("^:",value.raw),NA),
           value=gsub("[[:alpha:]]","",value),
           value=as.numeric(value)) %>%
    #Filter out misc stray data
    filter(!is.na(value)) %>%
    select(-value.raw) %>%
    #Tidy first column
    separate(1,into=hdr,sep=",") %>%
    #Drop species classifications of the form Fxx - these are categories
    #rather than individual species
    filter(!grepl("^F[0-9]{2}$",species))
  
  dat.l[[n]] <- dat
}

# Quick data coverage check -------------------------------------------------------
purrr::map(dat.l,distinct,year,geo) %>%
  bind_rows(.id="src") %>%
  filter(!geo %in% geo.exclude) %>%
  ggplot(aes(x=year,y=geo))+
  geom_point()+
  facet_wrap(~src)


#'========================================================================
# Average price per species ####
#'========================================================================
#' Note that we could just use the EUR_T (Euro per tonne) field
#' here, but calculating it manually has the effect of weighting it
#' by the size of the catch as well, which is desirable
sp.geo.price <- 
  filter(dat.l$value.species.geo,
         year %in% sel.yrs,
         pres=="TOTAL",
         dest_use=="TOTAL",
         natvessr=="TOTAL",
         !(geo %in% geo.exclude)) %>%
  select(-pres,-natvessr,-dest_use) %>%
  group_by(species,unit,geo) %>%
  summarise(total=sum(value)) %>%  #Note - summing over years as well
  spread(unit,total) %>%
  mutate(mean.price=EUR/TPW) %>%
  select(-EUR_T,-EUR,-TPW)
saveRDS(sp.geo.price,file="objects/catch/species_price.rds")


#/*======================================================================*/
#  Value of landings per country per species
#/*======================================================================*/
val.sp.geo <- 
  filter(dat.l$value.species.geo,
         year %in% sel.yrs,
         unit=="EUR",
         pres=="TOTAL",
         natvessr=="TOTAL",
         dest_use=="TOTAL",
         !(geo %in% c("EU15","EU27","EU28"))) %>%
  select(-c(pres,natvessr,dest_use,unit)) %>%
  #Average over years
  group_by(species,geo) %>%
  summarise(value=sum(value)/length(sel.yrs))
saveRDS(val.sp.geo,file="objects/catch/value.species.country.rds")

#'========================================================================
# Catches by stock (sp x FAO area) ####
#'========================================================================
catch.stock.geo <- 
  dat.l$catch.stock %>%
  filter(unit=="TLW",
         year %in% sel.yrs,
         !(geo %in% c("EU15","EU27","EU28"))) %>%
  #Retain subareas only
  mutate(is.subarea=grepl("^[0-9]{2}_[0-9]+$",fishreg)) %>%
  filter(is.subarea) %>%
  select(-is.subarea,-unit,catch=value)
  # #Average over years
  # group_by(species,fishreg,geo) %>%
  # summarise(catch=sum(value)/length(sel.yrs))
saveRDS(catch.stock.geo,file="objects/catch/catch.stock.geo.rds")

#/*======================================================================*/
#  Complete
#/*======================================================================*/

#Turn off thte lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

#' -----------
#' <small>*This work by Mark R Payne is licensed under a  Creative Commons
#' Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
#' For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
#' Basically, this means that you are free to "share" and "remix" for 
#' non-commerical purposes as you see fit, so long as you "attribute" me for my
#' contribution. Derivatives can be distributed under the same or 
#' similar license.*</small>
#'
#' <small>*This work comes with ABSOLUTELY NO WARRANTY or support.*</small>
#'
#' <small>*This work should also be considered as BEER-WARE. For details, see
#' http://en.wikipedia.org/wiki/Beerware*</small>
#' 
#' -----------
