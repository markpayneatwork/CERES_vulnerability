#/*##########################################################################*/
#' Setup FAO catch area data
#' ==========================================================================
#'
#' by Mark R Payne  
#' DTU-Aqua, Charlottenlund, Denmark  
#' http://www.staff.dtu.dk/mpay  
#'
#' Mon Jul 17 14:44:30 2017
#'
#' Imports and prepares polygons describing FAO areas for further use in processing and visualisation
#' 
#' Processes EUROSTAT catch.sp.fishreg data to focus on key areas
#
#  This work is subject to a Creative Commons "Attribution" "ShareALike" License.
#  You are largely free to do what you like with it, so long as you "attribute" 
#  me for my contribution. See the fine print at the end for exact details.
#
#  To do:
#
#  Notes:
# - While this script contains reminants of RMarkdown, it is not in a state
#    where it can be compiled in a meaningful manner
#/*##########################################################################*/

#/*======================================================================*/
#  Initialise system
#/*======================================================================*/
cat(sprintf("\n%s\n","FAO Polygons"))
cat(sprintf("Analysis performed %s\n\n",base::date()))

#Configure markdown style, do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
                              flush.console();return(invisible(NULL))}
library(tidyverse)
library(sf)

#'========================================================================
# Import FAO polygons ####
#'========================================================================
#Import polygons
FAO.areas.all <- st_read("data/FAO_Areas/FAO_AREAS.shp")

#Subset the polygons of interest
# We want to retain all in FAO areas 27, but are only interested in
# the Subarea leave - all of the smaller units in the Baltic for example
# are ignored to start with
FAO.areas <- 
  filter(FAO.areas.all,
         F_AREA %in% c(21,27,34,37),
         F_LEVEL=="SUBAREA") %>%
  select(F_CODE,F_AREA,geometry)
plot(FAO.areas[,"F_AREA"])

saveRDS(FAO.areas,file="objects/Geodata/FAO_polygons.rds")

#'========================================================================
# Map GCFM GSAs to FAO ####
#'========================================================================
#Import GCFM GSA shape files
GSA.sp <- st_read("data/FAO_Areas/GSAs_simplified.shp")

#We don't actually need to do any direct, one-to-one mapping here, as the
#FAO Subareas are actually listed anyway. Just extract them out
GSA.FAO.mapping <- 
  GSA.sp %>%
  as_tibble() %>%
  select(F_SUBAREA,F_GSA_LIB)

saveRDS(GSA.FAO.mapping,file="objects/Geodata/GSA_FAO_codes.rds")

#/*======================================================================*/
#  Complete
#/*======================================================================*/
#+ results='asis'
#Turn off thte lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# -----------
# <small>*This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or
# similar license.*</small>
# 
# <small>*This work comes with ABSOLUTELY NO WARRANTY or support.*</small>
# 
# <small>*This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware*</small>
# 
# -----------
