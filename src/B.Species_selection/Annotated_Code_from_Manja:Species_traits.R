
#  Species traits scoring
#setwd("C:/Users/Manja/Dropbox/MASTER THESIS/Data")

#MPAY: read self
library(tidyverse)
#metrics<-read.csv("compare metrics.csv", sep = ";", stringsAsFactors = FALSE, dec = ",")
metrics <- read_csv2("data/Traits/Manja/compare metrics.csv")

#metrics[grepl("XXX", metrics$TAXOCODE) & !grepl("BOR", metrics$FAO_3A_code) ,]

#metrics[grepl("BOR", metrics$FAO_3A_code) ,]
metrics<-metrics[-185,]   #MPA: Drop last line of NAs

# Remove all groups that are of a higher order than genus except caproidae
metrics1<-metrics[!grepl("XXX", metrics$TAXOCODE),]

metrics1<-rbind(metrics1, metrics[17,])

metrics1<-metrics1[-93,]   #FPE - European Perch
metrics1<-metrics1[-101,]  #PCB - Barnacle
metrics1<-metrics1[-115,]  #FPP - Pike-perch
metrics1<-metrics1[-131,]  #RAZ  - Solen razor clams nei

#  How big a portion og?f the totalt value is removed when removing the groups?
value_orig<-sum(metrics$sum.value)  #  = 8817541314
value_updated<-sum(metrics1$sum.value)   # = 8234862956
value_updated/value_orig*100      #  = 93.39 %

#--------------------- Scoring habitat specicificity----------------------------------


unique(metrics1$vertical.habitat)
unique(metrics1$horizontal.habitat)
unique(metrics1$Mobility)

# Species, where mobility is empty
which(metrics1$Mobility=="", arr.ind=TRUE)
metrics1$if.different.name[127]<- "Siganus rivulatus"
metrics1$Mobility[127]<- "Mobile"   #MPA:SPI
metrics1$Mobility[128]<- "Mobile"  #MPA: SOS

# All benthic species are demersal
metrics1$vertical.habitat <- replace(metrics1$vertical.habitat, 
                                     metrics1$vertical.habitat=="Benthic",
                                     "Demersal")

metrics1$score.hab<-NA

for (i in 1:length(metrics1$Mobility)){
  
  # mobile/highly migratory and oceanic and epi-/meso-/bathypelagic   =   low score=low risk
  if (metrics1$horizontal.habitat[i]=="Oceanic") {
    metrics1$score.hab[i]<-1
    
    # highly migratory and shelf and benthopelagic  = low score =low risk
  }else if (metrics1$Mobility[i]=="Highly migratory") {
    metrics1$score.hab[i]<-1
    
    # slope and mobile and bathydemersal    = low score = low risk
  }else if (metrics1$Mobility[i]=="Mobile" && metrics1$vertical.habitat[i]=="Bathydemersal" && metrics1$horizontal.habitat[i]=="Slope") {
    metrics1$score.hab[i]<-1
    
  }else if (metrics1$Mobility[i]=="Mobile" && metrics1$vertical.habitat[i]=="Mesopelagic" && metrics1$horizontal.habitat[i]=="Slope") {
    metrics1$score.hab[i]<-1
    
    
    # Unknown and Non-migratory species and bathydemersal  = medium score  = medium risk
  }else if (metrics1$Mobility[i]=="Sedentary" && metrics1$horizontal.habitat[i]=="Coastal") {
    metrics1$score.hab[i]<-4
    
    # Unknown and Non-migratory species and bathydemersal  = medium score  = medium risk
  }else if (metrics1$Mobility[i]=="Sedentary" && metrics1$vertical.habitat[i]=="Demersal") {
    metrics1$score.hab[i]<-4
    
    # Reef-associated and mobile species  = medium score  = medium risk
  }else if (metrics1$vertical.habitat[i]=="Reef-associated") {
    metrics1$score.hab[i]<-4
    
    
  # Species that are reliant on fresh- or brackish water sometimes are more vulnerable   
  }else if (metrics1$mobility.fishbase[i]=="Catadromous" || metrics1$mobility.fishbase[i]=="Anadromous") {
    metrics1$score.hab[i]<-3 
    
    # Species that live in the inner shelf and are demersal  
  }else if (metrics1$horizontal.habitat[i]=="Inner shelf" && metrics1$vertical.habitat[i]=="Demersal") {
    metrics1$score.hab[i]<-3 
    
    # Species that live in the inner shelf and are demersal  
  }else if (metrics1$horizontal.habitat[i]=="Inner shelf" && metrics1$vertical.habitat[i]=="Benthopelagic") {
    metrics1$score.hab[i]<-3
    
    # Species that live in the inner shelf and are demersal  
  }else if (metrics1$horizontal.habitat[i]=="Coastal" && metrics1$vertical.habitat[i]=="Benthopelagic") {
    metrics1$score.hab[i]<-3 
    
    
    # All other fish that are mobile, pelagic/demersal and live on shelf/slope/coastal  = medium low score = medium low risk
     
     } else {
      metrics1$score.hab[i]<-2
  }}


#  write.csv(fish_metrics, "")

#-----------------------Lifespan scoring all----------------------------
# fill in lifespans of molluscs and crustacea that were missing
metrics1$Lifespan.n[141]<-3 #MTS
metrics1$Lifespan.n[110]<-9 #RPN
metrics1$Lifespan.n[111]<-9 #RPW
metrics1$Lifespan.n[97]<-4 #SSH
metrics1$Lifespan.n[86]<-25 #SLO
metrics1$Lifespan.n[77]<-2 #OCC
metrics1$Lifespan.n[76]<-2#OCZ
metrics1$Lifespan.n[57]<-8 #SCR
metrics1$Lifespan.n[52]<-2.5 #
metrics1$Lifespan.n[50]<-3
metrics1$Lifespan.n[51]<-1
metrics1$Lifespan.n[8]<-2
metrics1$Lifespan.n[17]<-9
metrics1$Lifespan.n[30]<-2
metrics1$Lifespan.n[31]<-2
metrics1$Lifespan.n[40]<-2
metrics1$Lifespan.n[41]<-2
metrics1$Lifespan.n[42]<-2



#------------------Plotting life span-----------------------
breaks=seq(0, 80, 2.5)
v<-c(1,4,6,8,10,12,16,20,26,32,40,50,60,70,80)

par(mfrow=c(3, 3))
windows()
h<-hist(metrics1$Lifespan.n, plot=F)
plot(h$mids, h$counts, ylim = c(0, 25), xlim=c(0,75), 
     type = 'n', bty = 'n', xlab = 'Life span (years)', ylab = 'Number of species')
grid(NA, ny=NULL)
#hist(metrics1$Lifespan.n, add=T)
hist(metrics1$Lifespan.n, add=T, xlim=c(0,75), breaks=seq(0, 75, 2.5),main=NULL,ylab="Number of species", xlab="Lifespan (years)", col="darkgray", border="white")
axis(side=1, at=seq(0,80,10))
#rug(summary(metrics1$Lifespan.n)[1], col = "red", lwd=2.5)
rug(summary(metrics1$Lifespan.n)[2], col = "red", lwd=2.5)
rug(summary(metrics1$Lifespan.n)[3], col = "red", lwd=2.5)
rug(summary(metrics1$Lifespan.n)[5], col = "red", lwd=2.5)
#rug(summary(metrics1$Lifespan.n)[6], col = "red", lwd=2.5)

axis(side=2, at=seq(0,25,5))

# d <- density(metrics1$Lifespan.n)
# plot(d, type="n", main="Lifespan")
# lines(d, col="red")


summary(metrics1$Lifespan.n)#[5]
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#  2.00    9.25   13.50   16.33   19.66   72.00      22 

# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.00    7.90   12.30   14.83   19.10   72.00 

metrics1$ls_score<-NA

#MPA: Setting NAs to zero (??)
metrics1$Lifespan.n[which(is.na(metrics1$Lifespan.n))]<-0

#MPA: Looks like a cut based on quartiles, with 0 -> NA
for (j in 1:length(metrics1$Lifespan.n)){
  
  if (metrics1$Lifespan.n[j]<=summary(metrics1$Lifespan.n)[2] & metrics1$Lifespan.n[j]>0){
    metrics1$ls_score[j]<-1
    
  } else if (summary(metrics1$Lifespan.n)[2] < metrics1$Lifespan.n[j] & metrics1$Lifespan.n[j] <= summary(metrics1$Lifespan.n)[3]){
    metrics1$ls_score[j]<-2
    
  } else if (summary(metrics1$Lifespan.n)[3] < metrics1$Lifespan.n[j] & metrics1$Lifespan.n[j]<=summary(metrics1$Lifespan.n)[5]) {
    metrics1$ls_score[j]<-3
  } else if (metrics1$Lifespan.n[j]==0){
    metrics1$ls_score[j]<-NA
  } else { 
   metrics1$ls_score[j]<-4
    
  }}



#TSM<-read.csv("./Aquamaps/TSM with rankings.csv", header = T, stringsAsFactors = F)
RTSM<-read.csv("./Aquamaps/RTSM with rankings_new.csv", header = T, stringsAsFactors = F)

#colnames(RTSM)[3]<-'Scientific_name'

# Change names to make them similar to that of the fish_metrics dataframe
#TSM$Scientific_name<- gsub("\\s*\\([^\\)]+\\)","",as.character(TSM$Scientific_name))
RTSM$Scientific_name<- gsub("\\s*\\([^\\)]+\\)","",as.character(RTSM$Scientific_name))



ALL<-merge(RTSM, metrics1, by="Scientific_name" , all.x = T, all.y = T)

ALL[3,2:8]<-ALL[4,2:8]
ALL[11,2:8]<-ALL[22,2:8]
ALL[18,2:8]<-ALL[19,2:8]
ALL[31,2:8]<-ALL[30,2:8]
ALL[35,2:8]<-ALL[36,2:8]
ALL[37,2:8]<-ALL[34,2:8]
ALL[40,2:8]<-ALL[39,2:8] #ikke fjernes bagefter
ALL[44,2:8]<-ALL[43,2:8]
ALL[47,2:8]<-ALL[46,2:8]
ALL[57,2:8]<-ALL[58,2:8]
ALL[63,2:8]<-ALL[64,2:8]
ALL[65,2:8]<-ALL[38,2:8]
ALL[66,2:8]<-ALL[67,2:8] #ikke fjernes bagefter
ALL[70,2:8]<-ALL[68,2:8]
ALL[81,2:8]<-ALL[79,2:8]
ALL[83,2:8]<-ALL[82,2:8]
ALL[87,2:8]<-ALL[88,2:8]
ALL[91,2:8]<-ALL[90,2:8]
ALL[94,2:8]<-ALL[93,2:8]
ALL[98,2:8]<-ALL[99,2:8]  #ikke fjernes bagefter
ALL[105,2:8]<-ALL[102,2:8] #ikke fjernes bagefter
ALL[114,2:8]<-ALL[75,2:8]
ALL[115,2:8]<-ALL[75,2:8]
ALL[120,2:8]<-ALL[8,2:8]
ALL[127,2:8]<-ALL[144,2:8]
ALL[132,2:8]<-ALL[60,2:8]
ALL[133,2:8]<-ALL[129,2:8]
ALL[134,2:8]<-ALL[135,2:8] #ikke fjernes bagefter
ALL[149,2:8]<-ALL[148,2:8]
ALL[154,2:8]<-ALL[153,2:8]
ALL[155,2:8]<-ALL[113,2:8]
ALL[158,2:8]<-ALL[157,2:8]
ALL[164,2:8]<-ALL[163,2:8]
ALL[177,2:8]<-ALL[178,2:8]
ALL[184,2:8]<-ALL[183,2:8]


ALL1<-ALL[-c(4,22,19,30,36,34,43,46,58,64,38,68,79,82,88,89,90,93,75,8,144,60,129,148,153,113,157,163,178,183),]

ALL1$ls_score[which(is.na(ALL1$ls_score))]<-0
#metrics1$Lifespan.n[which(is.na(metrics1$Lifespan.n))]<-0


#  Overall ranking
for (x in 1:length(ALL1$Scientific_name)) {
  
  # mean of the three scores
 ALL1$Total.score[x]<-mean(c(ALL1$score[x],ALL1$score.hab[x],ALL1$ls_score[x])[ALL1$ls_score[x] != 0], na.rm = TRUE)
  
  # weighted mean, where TSM weighs 50% and the 2 others share 50%
  ALL1$Total.score1[x]<-sum(c(ALL1$score[x]*0.5,ALL1$score.hab[x]*0.25,ALL1$ls_score[x]*0.25)[ALL1$ls_score[x] != 0], na.rm = TRUE)

  
  ALL1$Total.score2[x]<-sum(c(ALL1$score[x],ALL1$score.hab[x]*0.5,ALL1$ls_score[x]*0.5)[ALL1$ls_score[x] != 0], na.rm = TRUE)
}



for (h in 1:length(ALL1$Scientific_name)) {
  
  if (ALL1$Total.score1[h]==0.00) {
    ALL1$Total.score1[h]<-sum(c(ALL1$score[h]*0.5,ALL1$score.hab[h]*0.5), na.rm = TRUE)
  }
  # mean of the three scores
 # ALL1$Total.score[x]<-mean(c(ALL1$score[x],ALL1$score.hab[x],ALL1$ls_score[x])[ALL1$ls_score[x] != 0], na.rm = TRUE)
  
  # weighted mean, where TSM weighs 50% and the 2 others share 50%
 # ALL1$Total.score1[x]<-sum(c(ALL1$score[x]*0.5,ALL1$score.hab[x]*0.25,ALL1$ls_score[x]*0.25)[ALL1$ls_score[x] != 0], na.rm = TRUE)
  
  
 # ALL1$Total.score2[x]<-sum(c(ALL1$score[x]*0.45,ALL1$score.hab[x]*0.3,ALL1$ls_score[x]*0.25)[ALL1$ls_score[x] != 0], na.rm = TRUE)
}

write.csv2(ALL1, "Species vulnerability with new RTSM_new.csv", row.names=F)

















#--------------------map with background gradient------------------
library(ggplot2) 
library(grid)
library(RColorBrewer)

make_gradient <- function(deg = 45, n = 100, cols = blues9) {
  cols <- colorRampPalette(cols)(n + 1)
  rad <- deg / (180 / pi)
  mat <- matrix(
    data = rep(seq(0, 1, length.out = n) * cos(rad), n),
    byrow = TRUE,
    ncol = n
  ) +
    matrix(
      data = rep(seq(0, 1, length.out = n) * sin(rad), n),
      byrow = FALSE,
      ncol = n
    )
  mat <- mat - min(mat)
  mat <- mat / max(mat)
  mat <- 1 + mat * n
  mat <- matrix(data = cols[round(mat)], ncol = n)
  grid::rasterGrob(
    image = mat,
    width = unit(1, "npc"),
    height = unit(1, "npc"), 
    interpolate = TRUE
  )
}
g <- make_gradient(
  deg = 45, n = 500, cols = brewer.pal(9, "Spectral")
)

ggplot(spec_vul, aes(spec_vul$rank_new, spec_vul$Total.score1, shape = factor(spec_vul$type), size = 1))+
  annotation_custom(
    grob = g, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
  ) + 
  geom_point() + labs(x = "Value rank", y="Species overall vulnerability",shape="Type", size=NULL) + 
  scale_shape_manual(values=c(8, 16, 5),labels=c("Crustaceans", "Fish", "Molluscs"))











#------------------- not necessary----------------------------
# Divide dataset into datasets of different type (fish, molluscs and crustacea)
fish_metrics<-subset(metrics1, type=="Fish")
moll_metrics<-subset(metrics1, type=="Mollusc")                     
crust_metrics<-subset(metrics1, type=="Crustacea")


#------------------ Fish Habitat scoring------------------------    

unique(fish_metrics$vertical.habitat)
unique(fish_metrics$horizontal.habitat)
unique(fish_metrics$Mobility)

# Species, where mobility is empty
fish_metrics$Scientific_name[which((fish_metrics$Mobility==""))]
fish_metrics$if.different.name[89]<- "Siganus rivulatus"
fish_metrics$Mobility[89]<- "Mobile"
fish_metrics$Mobility[90]<- "Mobile"


fish_metrics$score.hab<-NA

for (i in 1:length(fish_metrics$Mobility)){
  
  # mobile/highly migratory and oceanic and epi-/meso-/bathypelagic   =   low score=low risk
if (fish_metrics$horizontal.habitat[i]=="Oceanic") {
  fish_metrics$score.hab[i]<-1
  
  # highly migratory and shelf and benthopelagic  = low score =low risk
}else if (fish_metrics$Mobility[i]=="Highly migratory") {
  fish_metrics$score.hab[i]<-1
  
  # sedentary and inner shelf/outer shelf/shelf/slope and demersal/reef-associated   =   high score = high risk
}else if (fish_metrics$Mobility[i]=="Sedentary") {
  fish_metrics$score.hab[i]<-4
  
  # Reef-associated and mobile species  = medium score  = medium risk
}else if (fish_metrics$vertical.habitat[i]=="Reef-associated" && fish_metrics$Mobility[i]=="Mobile") {
  fish_metrics$score.hab[i]<-3

  # Unknown and Non-migratory species and bathydemersal  = medium score  = medium risk
}else if (fish_metrics$mobility.fishbase[i]=="Non-migratory" && fish_metrics$Mobility[i]=="Unknown") {
  fish_metrics$score.hab[i]<-3
  
}else if (fish_metrics$mobility.fishbase[i]=="Catadromous" || fish_metrics$mobility.fishbase[i]=="Anadromous") {
  fish_metrics$score.hab[i]<-3 
  
  # slope and mobile and bathydemersal    = low score = low risk
}else if (fish_metrics$horizontal.habitat[i]=="Slope" && fish_metrics$vertical.habitat[i]=="Bathydemersal" && fish_metrics$Mobility=="Mobile") {
  fish_metrics$score.hab[i]<-1
    
    # All other fish that are mobile, pelagic/demersal and live on shelf/slope/coastal  = medium low score = medium low risk
    
} else {
fish_metrics$score.hab[i]<-2
  }}


#  write.csv(fish_metrics, "")
  
#-----------------------Fish lifespan scoring----------------------------

summary(fish_metrics$Lifespan.n)[5]
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  2.80    9.45   14.20   16.86   20.50   48.40 

fish_metrics$ls_score<-NA

for (j in 1:length(fish_metrics$Lifespan.n)){
  
if (fish_metrics$Lifespan.n[j]<=summary(fish_metrics$Lifespan.n)[2]){
  fish_metrics$ls_score[j]<-1
  
} else if (summary(fish_metrics$Lifespan.n)[2] < fish_metrics$Lifespan.n[j] & fish_metrics$Lifespan.n[j] <= summary(fish_metrics$Lifespan.n)[3]){
  fish_metrics$ls_score[j]<-2
  
} else if (summary(fish_metrics$Lifespan.n)[3] < fish_metrics$Lifespan.n[j] & fish_metrics$Lifespan.n[j]<=summary(fish_metrics$Lifespan.n)[5]) {
  fish_metrics$ls_score[j]<-3
  
} else { 
  fish_metrics$ls_score[j]<-4

  }}



TSM<-read.csv("./Aquamaps/TSM with rankings.csv", header = T, stringsAsFactors = F)

colnames(TSM)[3]<-'Scientific_name'

# Change names to make them similar to that of the fish_metrics dataframe
TSM$Scientific_name<- gsub("\\s*\\([^\\)]+\\)","",as.character(TSM$Scientific_name))



#-----------------------Molluscs habitat scoring-----------------------

# All molluscs that are not octopuses and squids are sedentary which mean they are not mobile = a score of 4 = high risk

#  moll_metrics$Mobility[moll_metrics$ISSCAAP!=57]<-4

#-----------------------Molluscs lifespan scoring-----------------------


#----------------------Crustacea habitat scoring-----------------------

#----------------------Crustacea lifespan scoring-----------------------

#-----------------------------All:--------------------------------

FISH<-merge(TSM, fish_metrics, by="Scientific_name" , all.x = T, all.y = T)

FISH[3,2:18]<-FISH[4,2:18]
FISH[11,2:18]<-FISH[22,2:18]
FISH[18,2:18]<-FISH[19,2:18]
FISH[31,2:18]<-FISH[30,2:18]
FISH[35,2:18]<-FISH[36,2:18]
FISH[37,2:18]<-FISH[38,2:18]
FISH[43,2:18]<-FISH[42,2:18]
FISH[46,2:18]<-FISH[45,2:18]
FISH[56,2:18]<-FISH[57,2:18]
FISH[66,2:18]<-FISH[64,2:18]
FISH[77,2:18]<-FISH[75,2:18]
FISH[79,2:18]<-FISH[78,2:18]
FISH[83,2:18]<-FISH[84,2:18]
FISH[87,2:18]<-FISH[86,2:18]
FISH[90,2:18]<-FISH[89,2:18]
FISH[100,2:18]<-FISH[97,2:18]
FISH[120,2:18]<-FISH[137,2:18]
FISH[125,2:18]<-FISH[59,2:18]
FISH[126,2:18]<-FISH[122,2:18]
FISH[142,2:18]<-FISH[141,2:18]
FISH[147,2:18]<-FISH[146,2:18]
FISH[148,2:18]<-FISH[108,2:18]
FISH[151,2:18]<-FISH[150,2:18]
FISH[157,2:18]<-FISH[156,2:18]
FISH[170,2:18]<-FISH[171,2:18]

FISH1<-FISH[-c(4,22,19,30,36,38,42,45,57,64,75,78,84,86,89,97,137,59,122,141,146,108,150,156,171),]

#  Overall ranking
for (x in 1:length(FISH1$Scientific_name)) {
  
  # mean of the three scores
  FISH1$Total.score[x]<-mean(c(FISH1$score.x[x],FISH1$score.y[x],FISH1$ls_score[x]), na.rm = FALSE)
  
  # weighted mean, where TSM weighs 50% and the 2 others share 50%
  FISH1$Total.score1[x]<-sum(c(FISH1$score.x[x]*0.5,FISH1$score.y[x]*0.25,FISH1$ls_score[x]*0.25), na.rm = FALSE)
  
}
