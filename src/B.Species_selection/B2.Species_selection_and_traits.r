#'========================================================================
# A7.Import_trait_data
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Mon Aug 19 13:48:38 2019
#
# Imports the trait data for defining species adaptive capacity from the 
# various sources, and then constrains the species list further. This is a loose
# reimplementation of Manja's Species_traits.R code.
#
# Note that the species included here were originally selected based on the criteria
# that they must cover the top 90% of catches in each country for which we have
# data, extracted using the script in B2. Manja then refined this further by
# excluding grouped species and those for which we have no Aquamaps or similar.
# This script then ends up being the original definition of the species list, even if
# it is inspired by other scripts elsewhere.
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#'========================================================================
# Initialise system ####
#'========================================================================
cat(sprintf("\n%s\n","Import_trait_data"))
cat(sprintf("Analysis performed %s\n\n",base::date()))
start.time <- proc.time()[3] 

#Helper functions, externals and libraries
log.msg <- function(fmt,...) {cat(sprintf(fmt,...));
  flush.console();return(invisible(NULL))}

library(tidyverse)

#'========================================================================
# Configure ####
#'========================================================================
#Import CSV database 
# engelhardt.dat <- read_csv2("data/Traits/Engelhardt/Engelhardt_Ecotypes.csv",skip=2)
# peuchet.dat <- read_csv2("data/Traits/Laurene_LHS/Species LHS.csv")
# manja.dat <- read_csv2("data/Traits/Manja/Manja_traits.csv")
manja.dat <- read_csv2("data/Traits/Manja/compare metrics.csv")
alt.names <- read_csv2("data/alternative_names.csv") %>%
             select(FAO_3A_code,Alternative_name)

#Import scoring tables
# hab.score.tbl <- read_csv2("data/Traits/Habitat_scoring.csv")

#Import selected species
#sel.species.in <- readRDS("objects/Selected_species.rds")

#'========================================================================
# Setup ####
#'========================================================================
#Check for correct import
# stop_for_problems(engelhardt.dat)
# stop_for_problems(peuchet.dat)
stop_for_problems(manja.dat)
stop_for_problems(alt.names)
# stop_for_problems(hab.score.tbl)

#'========================================================================
# Filter Manjas data ####
# Apply the same constraints that Manja applied
#'========================================================================
#'
#'Species selection ------------------------------------------
trait.db <- 
  # Remove all groups that are of a higher order than genus except caproidae (BOR)
  manja.dat %>%
  mutate(n.xx.in.TAXOCODE=str_count(TAXOCODE,"X")) %>%
  filter((!n.xx.in.TAXOCODE>2) | (FAO_3A_code=="BOR")) %>%
  # Remove some specific species that are lacking Aquamaps (?) data
  #FPE - European Perch
  #PCB - Barnacle
  #FPP - Pike-perch
  #RAZ  - Solen razor clams nei
  filter(!FAO_3A_code %in% c("FPE","PCB","FPP","RAZ")) %>%
  #Add in alternative names
  left_join(y=alt.names,by="FAO_3A_code")
  
#' Trait modification -----------------------------------------------------
trait.db <-
  trait.db %>%
  #Set alternative name for Siganus spp SPI
  mutate(if.different.name=replace(if.different.name,FAO_3A_code=="SPI","Siganus rivulatus")) %>%
  #Set mobility for SPI, SOS
  mutate(Mobility=replace(Mobility,FAO_3A_code%in%c("SPI","SOS"),"Mobile")) %>%
  #All benethic species are demersal
  mutate(vertical.habitat=ifelse(vertical.habitat=="Benthic","Demersal",vertical.habitat))

#' Lifespan corrections-------------------------
lifespan.correct <- readRDS("data/Traits/Manja/Manual_lifespan_edits.rds")
trait.db <- 
  select(lifespan.correct,FAO_3A_code,correct.Lifespan.n=Lifespan.n) %>%
  left_join(x=trait.db,by="FAO_3A_code") %>%
  mutate(Lifespan.n=ifelse(is.na(Lifespan.n),correct.Lifespan.n,Lifespan.n)) %>%
  #Set NAs to zero
  mutate(Lifespan.n=ifelse(is.na(Lifespan.n),0,Lifespan.n))

#'========================================================================
# Convert to scores ####
#'========================================================================

#Habitat scoring ------------------------------------------------------
#Apply the habitat scoring in the form of a subsetting loop
scored.db <- 
  mutate(trait.db,
         hab.score=2, #Default
         hab.score=ifelse(horizontal.habitat=="Oceanic",1,hab.score),
         hab.score=ifelse(Mobility=="Highly migratory",1,hab.score),
         hab.score=ifelse(Mobility=="Mobile" &
                            vertical.habitat=="Bathydemersal" &
                            horizontal.habitat=="Slope",1,hab.score),
         hab.score=ifelse(Mobility=="Mobile" &
                            vertical.habitat=="Mesopelagic" &
                            horizontal.habitat=="Slope",1,hab.score),
         hab.score=ifelse(Mobility=="Sedentary" &
                            horizontal.habitat=="Coastal",4,hab.score),
         hab.score=ifelse(Mobility=="Sedentary" &
                            vertical.habitat=="Demersal",4,hab.score),
         hab.score=ifelse(vertical.habitat=="Reef-associated",4,hab.score),
         hab.score=ifelse(mobility.fishbase %in% c("Catadromous","Anadromous"),3,hab.score),
         hab.score=ifelse(horizontal.habitat=="Inner shelf" &
                            vertical.habitat=="Demersal",3,hab.score),
         hab.score=ifelse(horizontal.habitat=="Inner shelf" &
                            vertical.habitat=="Benthopelagic",3,hab.score),
         hab.score=ifelse(horizontal.habitat=="Coastal" &
                            vertical.habitat=="Benthopelagic",3,hab.score))


# Lifespan scoring ------------------------------------------
# Cut into quartiles
scored.db <-
  mutate(scored.db,
         ls.perc=(rank(Lifespan.n)-0.5)/nrow(scored.db),
         ls.score=as.numeric(cut(ls.perc,breaks=c(0,0.25,0.5,0.75,1))),
         ls.score=as.numeric(cut(Lifespan.n,c(-Inf,fivenum(Lifespan.n)[2:5]))))

saveRDS(scored.db,file="objects/Species_database.rds")

#'========================================================================
# Complete ####
#'========================================================================
#Turn off the lights
if(grepl("pdf|png|wmf",names(dev.cur()))) {dmp <- dev.off()}
log.msg("\nAnalysis complete in %.1fs at %s.\n",proc.time()[3]-start.time,base::date())

# .............
# This work by Mark R Payne is licensed under a  Creative Commons
# Attribution-NonCommercial-ShareAlike 3.0 Unported License.
# For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
# Basically, this means that you are free to "share" and "remix" for
# non-commerical purposes as you see fit, so long as you "attribute" me for my
# contribution. Derivatives can be distributed under the same or# Remove all groups that are of a higher order than genus except caproidae

# similar license.
#
# This work comes with ABSOLUTELY NO WARRANTY or support.
#
# This work should also be considered as BEER-WARE. For details, see
# http://en.wikipedia.org/wiki/Beerware
# .............
