---
title: "CERES Task 5.3 Vulnerabilty Results"
author: "Mark R Payne <br>DTU-Aqua, Technical University of Denmark<br> http://www.staff.dtu.dk/mpay"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document: default
  html_notebook: default
abstract: |
  This Notebook attempts to recreate the CERES WP5.3 vulnerability analysis for the effects of climate change on fish and fisheries. The code underlying this work was lost in the hard disk failure of May 2017, although the outputs and some of the source code is available. This notebook attempts to recreate that work in a broad sense - in some places, refinements to the work or a slightly different processing scheme are applied.
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,results="hide",fig.width=10,
                      message=FALSE,error=FALSE)

```

```{r setup}
#Setup
rm(list=ls())
library(ggplot2)
library(sp)
library(broom)
library(ggpolypath)
library(raster)
library(reshape2)
library(dplyr)
library(tibble)
library(mapdata)
library(maptools)

#Load data sets
load("../objects/EUROSTAT_data.RData")
load("../objects/ICES_data.RData")
load("../objects/proportion_of_landed_value.RData")
load("../objects/FAO_areas.RData")
load("../objects/LHS_strategies.RData")

#Misc ggplot2 objects
# map.theme <- theme(panel.background = element_rect(fill="black"),
#                     panel.grid.major = element_blank(), panel.grid.minor = element_blank())
base.map <- borders("world",xlim=c(-40,65),ylim=c(36,80),fill="black",colour="black")
map.xax <-   scale_x_continuous(name=NULL,expand=c(0,0))
map.yax <-   scale_y_continuous(name=NULL,expand=c(0,0)) 
proj.xy <- coord_quickmap(xlim=c(-40,65),ylim=c(36,80))
#proj.xy <- coord_map("cylequalarea",parameters=c(55),xlim=c(-40,65),ylim=c(36,80))
theme_set(theme_bw(base_size = 14))

#Prepare FAO spatial objects
FAO.areas$id <- rownames(FAO.areas@data)
FAO.tidy <- tidy(FAO.areas)

```

#Source Data

A brief description of each of the input data sources into this analysis is provided here

##Spatial Areas


Analyses are based on FAO regions, and particular focussed on FAO Area 27 for which catch statistics are readily availabe from EUROSTAT and from ICES. The FAO spatial classification is based on a five-layer hierarchy of regions: I have employed the “Subarea” level as the basic unit of analysis. It is possible to go further down the hierarchy, but not all of the catch data is resolved at this level. On the other hand, the Baltic is only represented by a single Subarea, and we may need to go further down for it to make more sense. Nevertheless, subarea seems to be a good choice to start with.

```{r}
#Plot of spatial areas
ggplot(FAO.tidy,aes(long,lat,group=group))+
  geom_polypath(colour="black",fill="lightgrey")+
  base.map + map.xax + map.yax + proj.xy

```

##Warming Data - Exposure

As the CERES downscaled projections are not yet available, I have used the standard CMIP5 projections as a placeholder for exposure to climate change. Specifically, I used projections of the mean sea surface temperature anomaly in the period 2040-2060, relative to a baseline climatology (1960-2000) from a single realisation of the MPI-ESM-MR model under the RCP8.5 scenario. After regridding on to a regular 0.1 degree grid, the spatially resolved projections look like so:

```{r}
#Map of projected anomalies
anom.r <- raster("../objects/projected_anomalies.nc")
anom.dat <- as.data.frame(rasterToPoints(anom.r))
g <- ggplot(anom.dat,aes(x,y,fill=Sea.Surface.Temperature))+geom_raster()+
  scale_fill_distiller(name="SST\nAnom\n[degC]",palette="BrBG",limits=c(-6,6))+
    base.map + map.xax + map.yax + proj.xy

print(g)

```

We can then calculate averages over each of the FAO regions as follows

```{r}
FAO.tidy$exposure <- FAO.areas@data[FAO.tidy$id,"exposure"]
ggplot(FAO.tidy,aes(long,lat,group=group,fill=exposure))+
  geom_polypath(colour="black")+
  scale_fill_distiller(palette = "OrRd",direction=1, name="SST\nAnom\n[degC]",limits=c(0,2))+
    base.map + map.xax + map.yax + proj.xy


```

##Landings Data
We characterise fisheries at the national level based on data from both ICES and EUROSTAT. ICES provides annual landings data by FAO region, country and species, while EUROSTAT also provides the sales price, and therefore the value of the fisheries. As this data is resolved by FAO area, it therefore adds a spatial aspect to the analysis. We can use this data to calculate how important each species is to an individual country e.g. for Germany

```{r}
#German data by species
plt.dat <- subset(propval.species.country,Country=="DE" & propval > 0.001)
ggplot(plt.dat,aes(Species,propval))+geom_bar(stat="identity")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    facet_wrap(~Country)+
  scale_y_continuous(name="Proportion of landings (by Value)",
                     limits=c(0,0.25),expand=c(0,0))
```

Similarly, we can work out the proportion of each indivudal species that comes from a given area e.g. for Mackerel.
```{r}
mac.dat <- subset(propland.area.species,Species=="MAC")
plt.dat <- merge(mac.dat,FAO.areas@data,by.x="Area",by.y="F_SUBAREA")
rownames(plt.dat) <- plt.dat$id
FAO.tidy$mac <- plt.dat[FAO.tidy$id,"propland"]
ggplot(FAO.tidy,aes(long,lat,group=group,fill=mac))+
  geom_polypath(colour="black")+
  scale_fill_distiller(palette = "BuPu",direction=1,name="Prop.")+
   base.map + map.xax + map.yax + proj.xy


```

These proportions then be used as weighting factors to determine the vulnerability metrics for each species and country.

##Life History Strategy (LHS) Data

We have characteristed the biological sensitivity and adaptive capacity of species to climate change based on their traits. DTU Aqua is host to a Centre of Excellence called “Centre for Ocean Life”, which focuses on developing the trait-based approach to life in the ocean, and in this regard we have compiled extensive trait-based databases of marine organisms. In particular, we have on-going work identifying life-history strategies in the ocean that is directly relevant here, and that we have applied as the basis for the biological part of the vulnerability analysis.

The life history analysis is based on the following traits

* Maximum observed length
* Estimated trophic level
* Lifespan
* Degree of parental care (five levels)
* Fecundity
* Offspring Size 
    
  We have then applied an archetypal analysis (AA) to identify characteristic life-histories. While AA is ultimately a classification and discrimination technique, it has the advantage that it assigns a fraction of each of the archetypes to a species - classification is therefore continuous rather than discrete, which makes it ideal for this type of analysis.

Three unique strategies emerge from our analysis: the Equilibrium, Opportuntistic and Periodic strategies. While these strategies are already well known from freshwater fish species, they have not been described before in the ocean. We have examined the spatial distribution of these life history strategies across european waters based on survey data, and found clear spatial patterns. Linking these patterns to the charcteristics of the local environment, we find clear relationships between the LHS and the environment - in particular, Opportunistic organisms appear to dominate in highly variable environments, while Periodic and Equilibrium species are dominate in more stable environments. We hypothesise therefore that this distinction is a useful, first-order, way to approach the question of climate change sensitivity and adaptive capacity - organisms that can thrive in variable environments can be expected to adapt more readily to changing conditions, and to generally be less sensitive. We therefore use this as the basis for our biological sensitivity /adaptative capacity metric in this first-order analysis.

Refining this analysis will be one of the major tasks that needs to be performed. For example, trophic level and size are probably not of direct importance in determining the sensitivity and adaptive capacity of species to climate change. Other traits will also be added to this analysis including

* thermal range (wide / narrow)
* geographic range (wide / narrow)
* population growth rates
* recruitment sensitivity (i.e. change in recruitment per change in temperature)
* degree of annual migration
* other traits based on approaches employed elsewhere e.g Hare et al 2016, Cheung et al 2005

Here's an example of the database

```{r}
print(head(LHS.dat,10))
```

#Vulnerability by Species

We first analyse the vulnerability of individual species. The vulnerability metrics are put together as follows

* Exposure - The amount of warming that the species is exposed to - calculated as the landings-weighted average of the exposure metrics in each of the FAO subareas
* Sensitivity - the proportion of LHS strategy associated with that species that is not opportunitistic (i.e. Equilibrium + Periodic)

Plotting these two against each other gives the following

```{r}
#Merge in exposure metrics and calculate exposure per species
propland.area.species.exp <- merge(propland.area.species,FAO.areas@data[,c("F_CODE","exposure")],
                                       by.x="Area",by.y="F_CODE")
propland.area.species.exp <- transform(propland.area.species.exp,exp.wt=propland*exposure)
species.exp <- tapply(propland.area.species.exp$exp.wt,propland.area.species.exp$Species,sum)

#Sensitivity
LHS.dat$sensitivity <- 1- LHS.dat$Opportunistic

#Merge the two into one data frame
species.vul <- melt(species.exp,varnames="FAO_code",value.name = "exposure")
species.vul <- merge(LHS.dat[,c("FAO_code","Species","English","sensitivity")],species.vul,by="FAO_code")

#Plot
ggplot(species.vul,aes(sensitivity,exposure))+geom_text(aes(label=FAO_code))+
  scale_x_continuous(name="Sensitivity score")+scale_y_continuous(name="Exposure score [deg C]")

```

One definition of vulnerable species is to focus on those that are in the upper tercile in both axes.
```{r}
#Define vulnerability score
species.vul$exp.ptile <- (rank(species.vul$exposure)-0.5)/nrow(species.vul)
species.vul$sens.ptile <- (rank(species.vul$sensitivity)-0.5)/nrow(species.vul)
species.vul$vul <- rowMeans(species.vul[,c("exp.ptile","sens.ptile")])
species.vul$vul.ptile <- (rank(species.vul$vul)-0.5)/nrow(species.vul)

ggplot(species.vul,aes(sensitivity,exposure))+
  geom_text(aes(label=FAO_code,colour=vul))+
  scale_x_continuous(name="Sensitivity score")+
  scale_y_continuous(name="Exposure score [deg C]")+
  scale_color_distiller(palette="OrRd",name="Vul. score",direction=1)+
  guides(colour=FALSE)
```

We can then extract a list of vulnerable species with the corresponding perctiles of their sensitivity, exposure and vulnerability scores. Looking at, for example, the top 10%:

```{r}
plt.dat <- subset(species.vul,vul.ptile>0.9,select=c(FAO_code,Species,English,exp.ptile,sens.ptile,vul.ptile))
plt.dat <- plt.dat[order(plt.dat$vul.ptile,decreasing=TRUE),]
print(plt.dat)
```

#Vulnerability by Country

We can then analyse the vulnerability integrated over the entire country - note that this is not the vulnerability of the country per se (and therefore does not include any socio-economic metrics etc) but rather the value-weighted exposure / sensitivty of the fish species that it is fishing on. i.e. if the country fishes a single species with a high exposure, then that makes the country exposed as well, whereas if that highly exposed species is just one of lots of species with a low exposure, then the country will have a low vulnerability. The vulnerability metrics are put together as follows

* Exposure - the species-specific exposure scores from above, weighted by the landed-value of that species in the country
* Sensitivity - the species-specific LHS strategy proportions, weighted by the landed-value of that species in the country

```{r}
#Merge the data sets and calculate the per-country results
country.vul.tbl <- propval.species.country %>% 
  rename(FAO_code=Species) %>%
  inner_join(species.vul,by="FAO_code") %>%
  mutate(exp.wt=exposure*propval,sens.wt=sensitivity*propval)
country.vul <- country.vul.tbl %>%
                    group_by(Country) %>%
                    summarise(exposure=sum(exp.wt),
                              sensitivity=sum(sens.wt))

#Drop Strange countries from the analysis
country.vul <- country.vul %>% subset(!Country %in% c("CN","TW","JP","LY"))

#Make plot
ggplot(country.vul,aes(sensitivity,exposure))+geom_text(aes(label=Country))+
  scale_x_continuous(name="Sensitivity score")+
  scale_y_continuous(name="Exposure score [deg C]")

```

```{r}
#Calculate an overall metric of vulnerability
country.vul <- country.vul %>%
               mutate(exp.ptile=(rank(exposure)-0.5)/nrow(.),
                      sens.ptile=(rank(sensitivity)-0.5)/nrow(.))
country.vul$vul <- rowMeans(country.vul[,c("exp.ptile","sens.ptile")])
country.vul$vul.ptile <- (rank(country.vul$vul)-0.5)/nrow(country.vul)

ggplot(country.vul,aes(sensitivity,exposure))+
  geom_text(aes(label=Country,colour=vul))+
  scale_x_continuous(name="Sensitivity score")+
  scale_y_continuous(name="Exposure score [deg C]")+
  scale_color_distiller(palette="OrRd",name="Vul. score",direction=1)+
  guides(colour=FALSE)

```

Can we get this to plot on a map as well?
```{r}
#Get map country list by expanding iso3166 codes
iso.codes <- as.character(country.vul$Country)
poly.lst <- lst()
for(i in iso.codes) {
  map.poly <- map("world",iso.expand(i),plot = FALSE,fill=TRUE)
  map.sp <- map2SpatialPolygons(map.poly,map.poly$names)
  map.tidy <- map.sp %>% 
    tidy(map.sp) %>%
    as.tibble() %>%
    mutate(Country=i)
  poly.lst[[i]] <- map.tidy
}
poly.comb <- do.call(rbind,poly.lst) %>%
            inner_join(country.vul,by="Country")
  
  
#Now make plot
ggplot()+borders(fill="grey50")+
     map.xax + map.yax + proj.xy+
    geom_polypath(data=poly.comb,aes(long,lat,group=group,fill=vul),colour="black")+
    scale_fill_distiller(palette="OrRd",name="Vul.\nscore",direction=1)

```


***
<small>*This work by Mark R Payne is licensed under a  Creative Commons
Attribution-NonCommercial-ShareAlike 3.0 Unported License.
For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
Basically, this means that you are free to "share" and "remix" for
non-commerical purposes as you see fit, so long as you "attribute" me for my
contribution. Derivatives can be distributed under the same or
similar license.*</small>

<small>*This work comes with ABSOLUTELY NO WARRANTY or support.*</small>

<small>*This work should also be considered as BEER-WARE. For details, see
http://en.wikipedia.org/wiki/Beerware*</small>

***